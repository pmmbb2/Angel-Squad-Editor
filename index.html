<!doctype html>
<html>
	<head>
	<meta charset="UTF-8">
	
	<link href='jquery-ui-1.12.1/jquery-ui.css'  type="text/css" rel="stylesheet" />  
	<link href='jquery-ui-themes-1.12.1/jquery-ui-themes-1.12.1/themes/black-tie/jquery-ui.min.css'  type="text/css" rel="stylesheet" />  
	
	<!--<link href='css/smoothness/jquery-ui-1.10.3.min.css' type="text/css" rel="stylesheet" />-->
	<link href='css/editors.css' type="text/css" rel="stylesheet" />
	<link href='css/states-manager.css' type="text/css" rel="stylesheet" />
	
	<style type='text/css'>
	 
	
	div#expProgressLog {
		/*position: fixed;*/
		background-color: #000;
		color: lime;
		right: 0;
		top: 0;
		width: 50%;
		height: calc( 100% - 2em);
		overflow-y: auto;
		display: none;
		z-index: 100000000
	}
	/*
	#importLog{
		position:fixed;
		background-color: #000;
		color: lime;
		right: 0;
		top: 0;
		width: 50%;
		height: calc( 100% - 2em);
		overflow-y: auto
	}

	#importLog::before {
		content: 'Campaign Import Log';
		display: block;
		margin-bottom: 1em;
	}*/
		
	*{margin:0 ;padding: 0; font-family: Helvetica, Georgia, Verdana, Sans serif;}
	
  li{
		list-style: none
	}

	textarea{
		border-color: #999
	}


	#stageEntityBtn {
		text-decoration: none;
		padding: 0.5em;
		font-variant: all-petite-caps;
		color: #000;
		display: inline-block;
		border: thin #f90 solid;
		margin: 0.5em;
		background-color: #f90;
	}
	
	#body{
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: gray;
	}	
	
	body#body {
		background-image: url(game_assets/images/UI%20MOCKUPS/UI-PARTS/ui-stage-wings-halo-360x75.png);
		background-position: center 15em;
		background-color: #09f;
		background-repeat: no-repeat;
	}

	body#body:after {
		display: block;
		content:'Angel Squad Editor';
		font-size: 10em;
		line-height: 4em;
		text-align: center;
		color: #fff;
		text-shadow: 2px 2px black  
	}


	h3{
		width: 100% !important;
	}
	
		.handle{
			position:absolute;
			top:0;
			left:0;
			width: 100%;
			/*! height: 1em; */
			background-color: #000;
		}
		
		.customWindow{
			padding-top: 1.5em;
			display: block;
			height: 80%;
			width: 80%;
			background-color: #ddc;			
		}
		
		.customWindow/*, .customWindow>**/{
						overflow:hidden;			
		}	
		
      .customWindow>*{
			
			overflow-y: auto;			
		}	

		.handle button{
			float: right;
			border: none
		 }
	  
    .handle .title{			
			width: 100px;
			color: #fff
		}


.loader {	   	  
	  border: 16px solid #09f;
	  border-radius: 30px;
	 /* border-top: 10px inset #09f;
	  border-bottom: 10px outset #09f;*/
	  width: 60px;
	  height: 60px;
	  background-color: white;
	  padding: 0.5em
	 
	  -webkit-animation: spin 2s linear infinite;
	  animation: spin 2s linear infinite;	  
	}

	@-webkit-keyframes spin {
	  0% { -webkit-transform: rotate(0deg); }
	  100% { -webkit-transform: rotate(360deg); }
	}

	@keyframes spin {
	  0% { transform: rotate(0deg); }
	  100% { transform: rotate(360deg); }
	}
	
	#loader{
		/*opacity:1;*/
		margin-top: -200%;
		position: absolute;		
	}
	
	.loading{
		width: 100px;
		text-align: center;
		background-color: #fff;
		color: #09f;
		border-radius: 0.5em;
		border: 12px outset #09f;
		margin-top: -50px;
		margin-bottom: 20px;
	}
	
	/*
		loader gear -- begin
	*/		
			
		.parent{
		  display: flex;
		  /*! height: 500px; */
		}

		.gear{
		  position: relative;
		  width: 100px;
		  height: 100px;
		  margin: auto;
		  background: #09f;
		  border-radius: 50%;
		  animation-name: spin;
		  animation-duration: 4s;
		  animation-iteration-count: infinite;
		  animation-timing-function: linear;
		}

		.gear .center{
		  position: absolute;
		  top: 25px;
		  left: 25px;
		  z-index: 10;
		  width: 50px;
		  height: 50px;
		  background: #09f;
		  border-radius: 50%;
		}

		.tooth{
		  position: absolute;
		  top: -12.5px;
		  left: 37.5px;
		  z-index: 1;
		  width: 22.5px;
		  height: 125px;
		  background:#09f;
		}

		.tooth:nth-child(2){
		  transform: rotate(45deg);
		}

		.tooth:nth-child(3){
		  transform: rotate(90deg);
		}

		.tooth:nth-child(4){
		  transform: rotate(135deg);
		}

		@keyframes spin {
		  from {transform: rotate(0deg); }
		  to {transform: rotate(360deg);}
		}	
			
	/*
		loader gear -- end
	*/		
	#minimized_windows{position: absolute; z-index: 1;right:0}

	#minimized_windows .customWindow{
		height: 0em !important;
		overflow: hidden !important;
		/*display: inline-block !important;*/
	}
		
		
	form > label:not(.customStyle), 
	form > input:not(.customStyle), 
	form > textarea:not(.customStyle){
		width: 48%;
		display: inline-block;
	}

	.ui-draggable-handle{cursor:move}

	.info:after {
	  position: absolute;
	  bottom: 0;
	  background-color: #09f;
	  width: 1em;
	  text-align: center;
	  line-height: 1em;
	  content: '\24d8';
	  color: #fff;
	  /*font-weight: bold;*/
	  border-radius: 0.25em
	}
	
	
	
	</style>

	<script type="text/javascript" src="js/dexie.min.js"></script>
	<!--<script type="text/javascript" src="js/dexie.min.js.map"></script>
	<script type="text/javascript" src="js/dexie.d.ts"></script>-->
	
	<!--<script type="text/javascript" src="js/dexie_export2.js"></script>-->
	
	<script type='text/javascript' src='js/jquery-2.1.4.min.js'></script>
	<script type='text/javascript' src='jquery-ui-1.12.1/jquery-ui.js'></script>
	<script type='text/javascript' src='js/html2canvas.min.js'></script>
	<script type='text/javascript' src='js/jqueryui.dialog.fullmode.js'></script>	
	<!--<script type='text/javascript' src='js/states-manager.js'></script>-->
	
	
	<script type='text/javascript'>
	
	/*
		GLOBALs 
	*/
	
	
		/*
		POPULATE LBL[] TO LOCALIZE THE EDITOR
		
		loadLanguageJson()
		
		use an item: LBL['OBJ_LBL_DESTROYALLBRICKS']
		
	*/
	
	var LBL = [],
		objectivesOptions = []
		
	var loadLBLs = $.Deferred()
	
	function loadLanguageJson(){
		$.getJSON('./languages/en.json')
		.done(function(data){			
			Array.prototype.some.call(data,function(item){				
				LBL[item['name']] = item['value'] 				
			})
			loadLBLs.resolve()			
		})		
	}
	
	loadLanguageJson()
	
	$.when(loadLBLs)
	 .then(function(){
	
		objectivesOptions =
		[
			// DEDICATED TO SELECTING 
			{'name': 'destroyBW','lbl': LBL['OBJ_LBL_DESTROYALLBRICKS'],
			'input':'text',
			'value': true, 
			'description': LBL['OBJ_LBL_DESTROYALLBRICKS'], 
			'messageSuccess': LBL['OBJ_MSG_SUCCESS'],
			'messageFailure': LBL['OBJ_MSG_FAILURE']
			},
			{'name': 'minCombos',
			'input':'spinner',
			'lbl': LBL['OBJ_LBL_MINCOMBOS'],
			'value': 0, 
			'description': LBL['OBJ_LBL_MINCOMBOS'],
			'messageSuccess': LBL['OBJ_MSG_SUCCESS'], 
			'messageFailure': LBL['OBJ_MSG_FAILURE']
			},
			{'name': 'timer',
			'input':'spinner',
			'lbl': LBL['OBJ_LBL_TIMER'],
			'value': -1, 
			'description':LBL['OBJ_LBL_TIMER'], 
			'messageSuccess': LBL['OBJ_MSG_SUCCESS'], 
			'messageFailure': LBL['OBJ_MSG_FAILURE']
			},
			{'name': 'targets',
			'input':'textarea',
			'lbl': LBL['OBJ_LBL_TARGETS'],
			'value': [], 
			'description': LBL['OBJ_LBL_TARGETS'], 
			'messageSuccess': LBL['OBJ_MSG_SUCCESS'], 
			'messageFailure': LBL['OBJ_MSG_FAILURE']
			},			
			{'name': 'escortees',
			'input':'textarea',
			'lbl': LBL['OBJ_LBL_ESCORTEES'],
			'value': [], 
			'description': LBL['OBJ_LBL_ESCORTEES'], 
			'messageSuccess': LBL['OBJ_MSG_SUCCESS'], 
			'messageFailure': LBL['OBJ_MSG_FAILURE']
			}
		]
	
	})
	
	
	
	
	var destination_dir = {
		'sprites': 'game_assets/sprites',
		'paths': 'game_assets/paths',
		'brickwalls': 'game_assets/brickwalls',
		'entities': 'game_assets/entities',
		'stages': 'game_assets/stages',
		'sounds': 'game_assets/sounds',
		'campaigns': 'game_assets/campaigns'
	},	
	
	canvases = 
	[		
		// DEDICATED TO DISPLAYING ENTITIES ON THE STAGE
		{ 'name':'groundScrolling', 'zIndex': 0, 'x':0, 'y': 0, 'width':360, 'height':700},
		{ 'name':'ground', 'zIndex': 1, 'x':1, 'y': 0, 'width':360, 'height':700},
		{ 'name':'aboveGroundScrolling', 'zIndex': 2, 'x':0, 'y': 0, 'width':360, 'height':700},		
		{ 'name':'aboveGround', 'zIndex': 3, 'x':0, 'y': 0, 'width':360, 'height':700},
		{ 'name':'midAir', 'zIndex': 4, 'x':0, 'y': 0, 'width':360, 'height':700},
		{ 'name':'skyScrolling', 'zIndex': 5, 'x':0, 'y': 0, 'width':360, 'height':700},		
		{ 'name':'sky', 'zIndex': 6, 'x':0, 'y': 0, 'width':360, 'height':700},
		{ 'name':'teleport', 'zIndex': 7, 'x':0, 'y': 0, 'width':360, 'height':700},
		// DEDICATED TO THE COMBO SYSTEM
		{ 'name':'energyPoints', 'zIndex': 8, 'x':0, 'y': 0, 'width':360, 'height':700},	
		{ 'name':'comboStar', 'zIndex': 9, 'x':0, 'y': 0, 'width':360, 'height':700},		
		{ 'name':'combo', 'zIndex': 10, 'x':0, 'y': 0, 'width':360, 'height':700}		
	], // USED BY entities editor & stages editor
	
	stageDefaultWidth = 360,
	stageDefaultHeight = 700,
	
	// USED BY stages_editor
	entityCannons = [],
	stageNthFrame = 0,
	timeUnit = 0,
	startMax = 0,
	behaviours = {
		  rotateForOrientation: {lbl:'Rotate sprite to match direction(1)',idTrue:'Yes',idFalse:'No','value':false},
		  spriteFacingUp: {lbl:'Sprite facing Up (1)',idTrue:'Yes',idFalse:'No','value':true},
		  bounceHorizontally: {lbl:'Bounce when out of horizontal limits',idTrue:'Yes',idFalse:'No','value':true},
		  bounceVertically: {lbl:'Bounce when out of vertical limits',idTrue:'Yes',idFalse:'No','value':true},
		  outOfHorizontalBoundaryRemove: {lbl:'Remove when out of horizontal limits',idTrue:'Yes',idFalse:'No','value':true},
		  outOfVerticalBoundaryRemove: {lbl:'Remove when out of vertical limits',idTrue:'Yes',idFalse:'No','value':true},
		  collideWithPaddleRemove: {lbl:'Remove when collide with paddle',idTrue:'Yes',idFalse:'No','value':true},// remove this on collide with paddle 
		  collideWithPaddleBounce: {lbl:'Bounce when collide with paddle',idTrue:'Yes',idFalse:'No','value':true},
		  BounceBallVertically: {lbl:'Bounce ball vertically',idTrue:'Yes',idFalse:'No','value':true},
		  BounceBallHorizontally: {lbl:'Bounce ball horizontally',idTrue:'Yes',idFalse:'No','value':true},
		  collidePaddleAttacksPaddle: {lbl:'Attack paddle when collide with it',idTrue:'Yes',idFalse:'No','value':true},// remove ball on collide
		  collideBallRemoveBall: {lbl:'Remove ball when collide with it',idTrue:'Yes',idFalse:'No','value':true},// remove ball on collide
		  collideBallAttacksBall:{lbl:'Attack ball when collide with it',idTrue:'Yes',idFalse:'No','value':true},// on collision the sprite attacks the ball that loses energy
		  collideBallLoseEnergy: {lbl:'Lose energy when collide with ball',idTrue:'Yes',idFalse:'No','value':true},
		  collidePaddleLoseEnergy:{lbl:'Lose energy when collide with paddle',idTrue:'Yes',idFalse:'No','value':true},
		  collideWithBWRemove:{lbl:'Remove when collide with brickwall(balls, sprites not yet)',idTrue:'Yes',idFalse:'No','value':false},
		  collideWithBWBounce:{lbl:'Bounce when collide with brickwall(balls, sprites not yet)',idTrue:'Yes',idFalse:'No','value':true}
	  },
	
	
	defStateDialog // promise holdr for statemanger dialog
	
	
	/*
		PATH TIMER -- begin
	*/
	window.timer = 0
	window.timerOn = false
	window.timerPath = null
	/*
		PATH TIMER -- end
	*/
	
	// USED BY mainPreviewSprite()
	window.spriteReq = '',
	window.obj = {}
	

	
	
	/*
		function setElementDefaultSize(jQueryObject)
		DOES:
			SET AN ELEMENT 's DIMENSIONS 
			TO THE DEFAULT DEFINED ONES	
		PARAMS:
			jQueryObject -- required
			
	*/	
	function setElementDefaultSize(jQueryObject){
		jQueryObject.width(stageDefaultWidth)
		jQueryObject.height(stageDefaultHeight)  
	}
	
	
	
	/*

		function generateAssetSelector( paramsObject [,callback()] )

		DOES : 
			GENERATE A SCROLLABLE LIST OF SELECTABLE ITEMS

		PARAMS:
			paramsObject - required
			callback function() - optional	
			
			selectorId: idName,
			target: jQueryObject,
			injectMethod: 'append | insertBefore | insertAfter | replaceWith',
			contentPath: 'URL + CSS style path to the URL target resource'
			
		EXAMPLE: 
		var paramsObject = {
			selectorId: 'stage_BW_path_selector',
			target: $('#stage_BW_path'),
			injectMethod: 'insertAfter',
			contentPath: './paths_editor/ #paths_list_container .paths_list'
		}
		generateAssetSelector( paramsObject )
	*/

	function generateAssetSelector( paramsObject ){	 	
		
		let callback;
		let searchFormId
		
		if( arguments.length > 1 ){
			callback = arguments[1]			
		}
		
		// REMOVE EXISTING ELEMENT WITH THE SAME ID, IF IT EXISTS
		$('#'+paramsObject.selectorId).remove()
		
		var selector = 
		$('<div/>')
		.attr('id',paramsObject.selectorId)		
		.load(paramsObject.contentPath,function(e){	
		
		
			// ADD ASSETS SEARCH FORM
			
			// used in .filter .keyup > filterInputParent
			console.log("*****paramsObject.searchFormId*****")
			console.log(paramsObject.searchFormId)
			
			if( typeof paramsObject.searchFormId !== 'undefined'){
				//searchFormId : 'entityFilterSprites'
				searchFormId = paramsObject.searchFormId
			}
			
			$(this)
			.prepend('<div id="'+searchFormId+'" class="search_form_container"></div>')
			
			$(this)
			.find('.search_form_container')			
			.load('./searchForm.php',function(e){
				//alert(e)
				styleSearchForm()
			})

		
		  $(this)
			.dialog({
				title: paramsObject.title,				
				modal: true,
				autoOpen: false,
				width: 800,
				height: 600,
				dialogClass: "dialog-full-mode",
				open: function(){
					if( arguments.length == 2 ){

						if($('#stages_entities_list_container_live').length > 0){
							load_entities('live')						
						}
						else{
							load_entities()						
						}
						
					}
					$(document).dialogfullmode();// RE-INIT FULLSCREEN BTN					
				},
				close:function(){
					$(this).find('a').off('click')
					$(this).dialog('destroy').remove()
					$(document).dialogfullmode();// RE-INIT FULLSCREEN BTN
				}
			})	  
		  
		  // FOR BGM SELECTOR DO NOT REMOVE THE LAST ANCHOR
		  if (paramsObject.selectorId != 'stage_BGM_selector'){		  
			  $('#'+paramsObject.selectorId)
				.find('ul li')
				.each(function(i,e){
				console.log(i+' '+e)
				$(this).find('a:last').remove()// remove 'delete button'
			  })  		  
		  }
		  else{
			  decorateBGMControls()
		  }
		  
		  $(document).dialogfullmode();// INIT FULLSCREEN BTN
		  $('#'+paramsObject.selectorId)
		  .dialog('open') 
		  
		  loaderOff()
		 
		})
		
		 
		// INJECTION INTO DOM
		var target = paramsObject.target
		switch( paramsObject.injectMethod ){
		  case 'appendTo': 
			target.append(selector)		
		  break;
		  case 'insertBefore':  
			selector.insertBefore(target)
		  break;
		  case 'insertAfter':  
			selector.insertAfter(target)
		  break;
		  case 'replaceWith':  
			target.replaceWith(selector)
		  break;  
		}
		
			
		
		
	}


	
	
	function load_images_list(){
		loader()	
	  // REFRESH IMAGES LIST
	  $('#images_list_container, #BW_images_list_container')
		.load('./sprites_editor/ #images_list_container .images_list',function(){
			loaderOff()
		dialogNotify('images list refreshed')
	  })
	}

	$(document)
	.delegate('.refreshImagesListBtn','click',function(e){
		e.preventDefault();
		load_images_list()
	})
	
    /*
		RETURN HOW MANY subString IN string
	*/
	function occurrences(string, subString, allowOverlapping) {

		string += "";
		subString += "";
		if (subString.length <= 0) return (string.length + 1);

		var n = 0,
			pos = 0,
			step = allowOverlapping ? 1 : subString.length;

		while (true) {
			pos = string.indexOf(subString, pos);
			if (pos >= 0) {
				++n;
				pos += step;
			} else break;
		}
		return n;
	}


    	
	
	function dialogNotify(msg){
		var dlg = 
		$('<div/>')
		.html(msg)
		.dialog({
			create:function(){
				setTimeout(function(){dlg.fadeOut(function(){$(this).remove()})},2000)
			}
		})
	}

	/*
		preview sprite -- BEGIN
		also used for timerPath
	*/
	
	window.requestAnimationFrame = function () {
	return window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	function(f) {
		//window.setTimeout(f,1e3/60);
			window.setTimeout(f,1000/60);				
		}
		}()
	window.cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame
	
	
	/*
		LOAD JSON FILE WITH A CALLBACK FUNCTION
		-- same funct as in APP
	*/
	function load(url, callback) {
	  var xhr = new XMLHttpRequest();
	  xhr.onreadystatechange = function() {
		if (xhr.readyState === 4) {
		  callback(xhr.response);
		}
	  }
	  xhr.open('GET', url, true);
	  xhr.send('');
	}	
	
	/*
		function search()
		get json object 
		- from myArray 
		- which attribute name == nameKey		
		-- same funct as in APP
	*/	
	function search(nameKey, myArray){
		var i = 0;
		while ( i <= myArray.length-1 ) {
			if (myArray[i].name === nameKey) {
				return myArray[i];
			}
			i++
		}
	}
	
	/*
		RETURN [EC,index] WHICH ID = ID
		 - used to remove it from entities
	*/
	function searchEcInEntities(ID){
		var i = 0;
		while ( i <= entityCannons.length-1 ) {
			if (entityCannons[i].ID === ID) {
				return [entityCannons[i],i];
			}
			i++
		}
	}
	
	/*
		UPDATE startMax ( hightest value of attribute 'start' among ECs )
	*/	
	function startMaxUpdate(){  
		// 1 determine highest start  
		var n = 0
		while ( n < entityCannons.length ){
		if ( entityCannons[n].start > startMax ){
		startMax = entityCannons[n].start
		}
		n++
	  }// end while    
	}
	
	
	/*
		function searchEC()
		get a collection array of 
		entities which attribute 'start' equals stageNthFrame
	*/	
	function searchEC(){
		var i = 0,
			found = [];
			
		while ( i <= entityCannons.length-1 ) {
			if (entityCannons[i].start === stageNthFrame) {
				 found.push(entityCannons[i]);
			}
			i++
		}			
		//return JSON.stringify(found)
		return JSON.stringify(found)
	}
	
	/*
		rotateEC()
		
		DOES:
			update the rotation property of divs
			representing entityCannons on the stage
			based on:
				property entityCannon.entityName

	    VERY USEFUL FOR VISUALIZING speedChangers 
		ON STAGE WHILE DESIGNING THE LEVEL
	
	*/
	window.rotateEC = function(){
		entityCannons.some(function(obj, idx){

			// GET THE ENTITY OBJECT USING ENTITYCANNON'S entityName PROPERTY
			// TO GET: spriteFacingUp, rotateForOrientation
			
			/* 	
			if( obj.entityName == "speedChangerArrow-UP.ent" ){
				var sprite = entities.filter(function(o,i){
				return o.name == 'speedChangerArrow-UP.ent'
			})[0]
			*/
					
			var sprite = entities.filter(function(o,i){
				return o.name == obj.entityName
			})[0]		
					
			
			
			
			if( 
				/*sprite === null 
				||*/ typeof sprite === 'undefined'				
			){
								
			}
			else if( 
				typeof sprite.rotateForOrientation === undefined
				|| typeof sprite.spriteFacingUp === undefined			
			){
								
			}
			else if( sprite.rotateForOrientation == true){
			
				if( obj.dx == 0 ){
					if( obj.dy > 0  ){
						
						if( sprite.spriteFacingUp == false){	
							obj.rotation = 0
						}
						else if( sprite.spriteFacingUp == true){	
							obj.rotation = 180
						}
					}		
					else if( obj.dy < 0  ){
						
						if( sprite.spriteFacingUp == false){	
							obj.rotation = 180
						}
						else if( sprite.spriteFacingUp == true){	
							obj.rotation = 0
						}
					}				
				}
				
				else if( obj.dy == 0 ){					
					if( obj.dx > 0  ){					
										
						if( sprite.spriteFacingUp == false){	
							obj.rotation = 270
						}
						else if( sprite.spriteFacingUp == true){	
							obj.rotation = 90
						}
					}
					else if( obj.dx < 0  ){					
										
						if( sprite.spriteFacingUp == false){	
							obj.rotation =90
						}
						else if( sprite.spriteFacingUp == true){	
							obj.rotation = 270
						}
					}
				}	
				
				else if( sprite.spriteFacingUp == true ){			
					if( obj.dx > 0 && obj.dy < 0 ){
						// up right
						obj.rotation = 45			
					}
					else if( obj.dx > 0 && obj.dy > 0 ){
						// up right
						obj.rotation = 135			
					}
					else if( obj.dx < 0 && obj.dy > 0 ){
						// up right
						obj.rotation = 225			
					}
					else if( obj.dx < 0 && obj.dy < 0 ){
						// up right
						obj.rotation = 315			
					}
				}
				
				else if( sprite.spriteFacingUp == false ){			
					if( obj.dx > 0 && obj.dy < 0 ){
						// up right
						obj.rotation = 135			
					}
					else if( obj.dx > 0 && obj.dy > 0 ){
						// up right
						obj.rotation = 45			
					}
					else if( obj.dx < 0 && obj.dy > 0 ){
						// up right
						obj.rotation = 315			
					}
					else if( obj.dx < 0 && obj.dy < 0 ){
						// up right
						obj.rotation = 225			
					}
				}
				
				console.log(obj.ID)
				console.log(sprite)
				console.log('obj.dx: '+obj.dx)
				console.log('obj.dy: '+obj.dy)
				console.log('sprite.spriteFacingUp: '+sprite.spriteFacingUp)
				console.log('sprite.rotateForOrientation: '+sprite.rotateForOrientation)
				console.log('obj.rotation: '+obj.rotation)

				try{			
					document
					.getElementById(obj.ID)
					.childNodes[0]
					.style.transform = "rotate("+obj.rotation+"deg)"
				}
				catch(err){
					console.log(err)
				}
				
			}
			
			//}// end if obj is speedChangerArrow-UP.ent
		})

	}// rotateEC()


	
	
	function triggerEntityCannons( found ){
	
		console.log(				
				'triggerEntityCannons(): \r\n found:'+found.found
				+'\r\n'
				+'found.length:'+found.found.length	
				+'\r\n'					
				//+'entityCannons[n].entityName:'+entityCannons[n].entityName					
			)
	
	
		for (var n = 0; n < entityCannons.length; n++){	
			
			if( (Number(entityCannons[n].iterations) == -1
				|| Number(entityCannons[n].iterations) > 0)
				&& Number(entityCannons[n].start == timeUnit)
				){
				
				$('#'+entityCannons[n].ID)
				.css({opacity:1})
			
				//spawnEntityFromJson(entityCannons[n].entityName)
				
				//dialogNotify(entityCannons[n].entityName)
				console.log('entityCannons[n].entityName: '+entityCannons[n].entityName)
				
				console.log('IS INFINITE: '+Number(entityCannons[n].iterations) == -1)
				console.log('Math.number: '+Number(entityCannons[n].iterations) == -1)
				console.log('entityCannons[n].iterations: '+entityCannons[n].iterations)
				console.log('typeof entityCannons[n].iterations: '+typeof entityCannons[n].iterations)
				
				
				entityCannons[n].start = Number( timeUnit + entityCannons[n].next)
				
				if( Number(entityCannons[n].iterations) > 0 ){
					entityCannons[n].iterations = Number(entityCannons[n].iterations) - 1
				}
				
			}
			else{
				$('#'+entityCannons[n].ID)
				.css({opacity:0})
			}
		}
	}
	
	function checkEC(){
	
		var result = searchEC( timeUnit )
		var found = JSON.parse(result)
		if( found.length > 0 ){	
			console.log('stageNthFrame: '+stageNthFrame)
			console.log('timeUnit: '+timeUnit)
			console.log('found: '+JSON.stringify(found))
			triggerEntityCannons( found )
		}
	}
	
	
	var lastTime = 0
	window.mainPreviewStage = function(currentTime){
		//$('.edit_ec').hide()
		//checkEC()
		/*
		var result = searchEC( stageNthFrame )
		var found = JSON.parse(result)
		if( found.length > 0 ){	
			console.log('stageNthFrame: '+stageNthFrame)
			console.log('found: '+JSON.stringify(found))
			triggerEntityCannons( {found:found} )
		}		
		*/
		
		
		triggerEntityCannons( {found:entityCannons} )
		
		stageNthFrame++;		
		$('#stageNthFrameC').val(stageNthFrame)	
		
		console.log(currentTime + ' / '+ lastTime)
		
		if ( parseInt(currentTime) >= parseInt(lastTime) + 100 ){// every 10th of second
		// one second has passed, run some code here					
			$('#timeUnitC').val(timeUnit)	
			update_timeline_ruler()
			lastTime = currentTime;
			timeUnit++
					
		}
		
		if( $('#playTimeLineBtn').is(':hidden') ){		
			
			//console.log($('#playTimeLineBtn').is(':hidden'))
			
			stageReq = requestAnimationFrame( mainPreviewStage ) 		
		}	
		
	}
	
	function update_timeline_ruler() {
	  redraw_timeline_ruler({
		startFrom:timeUnit,//stageNthFrame,//, timeUnit
		step: 40
	  })
			  
	}


	function stepDown(){
	  //stageNthFrame -= 100
	  timeUnit -= 1
			$('#stageNthFrameC').val(stageNthFrame)
			$('#timeUnitC').val(timeUnit)
			if( typeof stageReq !== 'undefined' ){
		  cancelAnimationFrame(stageReq)
		}
			update_timeline_ruler() 
	  
		if( $('#playTimeLineBtn').is(':hidden')){
		  $('#pauseTimeLineBtn').hide()
		  $('#playTimeLineBtn').show()      
		}

		mainPreviewStage()		
	}

	function stepUp(){
	
	  timeUnit++ 
			$('#stageNthFrameC').val(stageNthFrame)
			$('#timeUnitC').val(timeUnit)	  
		
			if( typeof stageReq !== 'undefined' ){
			  cancelAnimationFrame(stageReq)
			}
			update_timeline_ruler() 
	  
		if( $('#playTimeLineBtn').is(':hidden')){
		  $('#pauseTimeLineBtn').hide()
		  $('#playTimeLineBtn').show()      
		}
		mainPreviewStage()
		
		
		
	}

	$(document)
	  .delegate('#stepDown','click',function(e){
	  e.preventDefault()
	  if( stageNthFrame > 0 && timeUnit > 0){
		stepDown()
	  }
	})

	$(document)
	  .delegate('#stepUp','click',function(e){
	  e.preventDefault()
	  stepUp()
	})

	
	$(document)
	.delegate('#playTimeLineBtn','click',function(e){
	  e.preventDefault()
		$(this).hide()
		$('#pauseTimeLineBtn').show(mainPreviewStage())
	})
	
	$(document)
	.delegate('#pauseTimeLineBtn','click',function(e){
	  e.preventDefault()		
		if( typeof stageReq !== 'undefined' ){
		  cancelAnimationFrame(stageReq)
		}
		$(this).hide()
		$('#playTimeLineBtn').show()	  
	})
	
	
	function resetTimeLine(){
	
		stageNthFrame = 0
		timeUnit = 0
		
		$('#stageNthFrameC').val(stageNthFrame)
		$('#timeUnitC').val(timeUnit)
		
		// STOP RAF
		if( typeof stageReq !== 'undefined' ){
			cancelAnimationFrame(stageReq)
		}	
		
		update_timeline_ruler() 	
	}
	
	/*
		RESET EC's start ATTRIBUTE
	*/
	function ECResetStart(){	
	// RESET TO INITIAL VALUE (start has been modified)
		$.each(entityCannons,function(i,e){
		
			console.log("RESET")
		    console.log(entityCannons[i].start+' '+entityCannons[i].iterations)
			
			entityCannons[i].start = entityCannons[i].archiveStart
			
			entityCannons[i].iterations 
			= 
			( entityCannons[i].archiveIterations < 0 )
			?Math.abs(entityCannons[i].archiveIterations) * -1
			:entityCannons[i].archiveIterations
			
			console.log(entityCannons[i].start+' '+entityCannons[i].iterations)			
		})	
	}
	
	$(document)
	.delegate('#ECResetStartBtn','click',function(e){
	  e.preventDefault()
		ECResetStart()
		startMaxUpdate()
	    // IF EC UI is visible, refresh it
	   if ( $('#stage_timeline_container').is(':visible') ){  
		 //ec_manager_ui ()
		 ec_manager_ui2()
		}
	})
	
	$(document)
	.delegate('#stopTimeLineBtn','click',function(e){
	  e.preventDefault()
		ECResetStart()
		resetTimeLine()
		startMaxUpdate()
		// IF EC UI is visible, refresh it
	   if ( $('#stage_timeline_container').is(':visible') ){  
		 //ec_manager_ui ()
		 ec_manager_ui2()
	   }		
		$('#pauseTimeLineBtn').hide()
		$('#playTimeLineBtn').show()
		toggleDisplayStageEmptyFrames()		
	})
	
	/*
		USED BY PATHS EDITOR & STAGES EDITOR -- begin
	*/
	
	window.drawLine = function(context, x1, y1, x2, y2) {			
			  context.beginPath();
			  context.strokeStyle = 'white';
			  context.lineWidth = 1;
			  context.moveTo(x1, y1);
			  context.lineTo(x2, y2);
			  context.stroke();
			  context.closePath();
			  return true
			}
	
	
	window.draw_axis_ruler = function( paramsObject ){
			  
			   // PUBLIC PARAMS
			  var params = paramsObject
			  
			  var canvasId = paramsObject.canvasId,// req
				  axis = paramsObject.axis ,// req
				  step = paramsObject.step ,// req           
				  ftSize = (paramsObject.ftSize)?paramsObject.ftSize:10,
				  axisDecal =  (paramsObject.axisDecal)?paramsObject.axisDecal:0,
				  markLengthMax =  (paramsObject.markLengthMax)?paramsObject.markLengthMax:ftSize,
				  ftName =  (paramsObject.ftName)?paramsObject.ftName:'Officina Sans',
				  ftColor =  (paramsObject.ftColor)?paramsObject.ftColor:'white',
				  textValue =  (paramsObject.textValue)?paramsObject.textValue:'nSteps',// units | nStep
				  startFrom =  (paramsObject.startFrom)?paramsObject.startFrom:0// 0 | any7 number to start counting from
			  
			  var canvas = document.getElementById(canvasId);
			  var ctx = canvas.getContext("2d")	  
			  
			  // PRIVATE PARAMS
			  var cvWidth = canvas.clientWidth,
				  cvHeight = canvas.clientHeight,  
				  length,
				  n = 0,
				  n_to,
				  x1, y1,
				  x2, y2,
				  tx, ty,
				  markLength
				
			  // GET THE LENGTH OF THE RULER
			  switch( axis ){
				case 'x0':
				case 'x1':
				   length = cvWidth
				break;
				case 'y0':
				case 'y1':
				   length = cvHeight
				break;
				case 'stage_time_line':
					length = cvWidth					
				break;
			  }
			/*
			   length += parseInt(startFrom)
			   n += parseInt(startFrom) 
			*/
			   n_to = length-1
			   
			   // MARKS ON THE AXIS
			  ctx.font= ftSize+"px "+ftName;
			  ctx.fillStyle = ftColor;
			  
			  while ( n <= n_to){				
				markLength = ( n%20 == 0 )?markLengthMax:markLengthMax/2				
				switch( axis ){
				  case 'x0':
				  case 'stage_time_line':
					 x1 = n
					 y1 = 0
					 x2 = n
					 y2 = markLength
					 tx = x2-ftSize/2
					 ty = y2+axisDecal
				  break;
				  case 'x1':
					 x1 = n
					 y1 = cvHeight
					 x2 = n
					 y2 = cvHeight-markLength 
					tx = x2-ftSize/2
					ty = y2-axisDecal
				  break;
				  case 'y0':
					 x1 = 0
					 y1 = n
					 x2 = markLength
					 y2 = n 
					tx = x2+axisDecal
					ty = y2//-ftSize/2
				  break;
				  case 'y1':				  
					x1 = cvWidth
					y1 = n
					x2 = cvWidth-markLength
					y2 = n
					tx = x2-axisDecal
					ty = y2-ftSize/2
				  break;
				}
				
				drawLine(ctx, x1, y1, x2, y2)
				
				if (markLength == markLengthMax){
				  if( textValue == 'nSteps'){
					ctx.fillText(n, tx, ty );
				  }
				  else if( textValue == 'units'){
					ctx.fillText((n+parseInt(startFrom))/step, tx, ty );
					//console.log((n+parseInt(startFrom))+ ' '+n+ ' ' +step)
				  }
				  if( axisDecal == markLengthMax){
					axisDecal = markLengthMax/2
				  }else{
					axisDecal = markLengthMax
				  }
				}
				
				n += step
			  }
			}
	
	/*
		DRAW TIMELINE RULERs UNITS
		used by stageReq RAF
	*/
	function redraw_timeline_ruler(paramsObject){
		clear_canvas('timeline_canvas')
		var params = 
		{
		  canvasId: 'timeline_canvas',
		  axis: 'stage_time_line',
		  step: paramsObject.step,
		  ftColor: 'white',
		  markLengthMax: 20,
		  textValue: 'units',
		  startFrom: paramsObject.startFrom*paramsObject.step //  N x step = startFrom value
		}
		draw_axis_ruler( params )	
	}
	
	/*
		USED BY PATHS EDITOR & STAGES EDITOR -- end
	*/
	
	window.mainPreviewSprite = function() {			
	  //console.log(obj)
	  var a = obj.canvas,
		  b = obj.ctx,
		  c = obj.img,
		  d = obj.positions,
		  e = obj.prevSprtIdx,
		  f = obj.sWidth,
		  g = obj.sHeight,
		  h = obj.frameTicker,
		  i = obj.nextFrameAt  
	   
	  if ( h >= i ){
		drawFrame(a,b,c,d,e,f,g,h,i);        
		h = 0    
		e++
		if (e > d.length-1){
		  var e = 0
		}
	  }      
	   h++  
	   obj = {
		 canvas:a, 
		 ctx:b, 
		 img:c, 
		 positions:d, 
		 prevSprtIdx:e, 
		 sWidth:f, 
		 sHeight:g, 
		 frameTicker:h, 
		 nextFrameAt:i     
	   }  
	  spriteReq = requestAnimationFrame( mainPreviewSprite )   
	}
	
	/*
	var objectPreview = {
		imgSrc :,
		positions :,
		sprtWidth :,
		sprtHeight :,
		nextFrameAt:
	}
	preview_sprite( objectPreview )
	
	*/
	function preview_sprite( objectPreview )
	{
	   cancelAnimationFrame(spriteReq)
	   /*
	    $('#sprite_preview')
		.remove()
	  */
	  var previewContainer = 
		  objectPreview.previewContainer,
		  imgSrc = objectPreview.imgSrc,
		  positions = objectPreview.positions,
		  sprtWidth = objectPreview.sprtWidth,
		  sprtHeight = objectPreview.sprtHeight,
		  nextFrameAt = objectPreview.nextFrameAt
	  
	  /*
	   $('<canvas/>')
		.attr('id','sprite_preview')		
		.prependTo(previewContainer)
	  */
	  
	  var img = new Image()
	  img.onload = function(){
		  
	     
		
		 var canvas = document.querySelector('#sprite_preview')    
		 var ctx = canvas.getContext("2d")
		 var PrevSprtIdx = 0
		
		  // resize canvas to fit image size					
		  ctx.canvas.width = img.naturalWidth;
		  ctx.canvas.height = img.naturalHeight; 
		 var frameTicker = 0,
			 prevSprtIdx = 0
		 obj = {}
		 obj.canvas = canvas
		 obj.ctx = ctx
		 obj.img = img
		 obj.positions = positions
		 obj.prevSprtIdx = prevSprtIdx
		 obj.sWidth = sprtWidth
		 obj.sHeight = sprtHeight
		 obj.frameTicker = frameTicker
		 obj.nextFrameAt =  nextFrameAt 
		 
		 mainPreviewSprite(); 
		
	  }// onload 
	  
	  img.src = imgSrc+'?t='+Date.now()
	 
	}//preview_sprite( objectPreview )

	 window.drawFrame = function(Canvas, Ctx, Img, Positions, PrevSprtIdx, SWidth, SHeight, FrameTicker, NextFrameAt){
	   var j = Canvas, 
		   k = Ctx, 
		   l = Img, 
		   m = Positions, 
		   n = PrevSprtIdx, 
		   o = SWidth, 
		   p = SHeight
	   
	   
		if (n <= m.length-1){
		 
		  // clear canvas
		  k.clearRect(0,
						0,
						j.clientWidth,
						j.clientHeight);    
		  
		  var sx = m[n][0],
			  sy = m[n][1],
			  sWidth = o,
			  sHeight = p, 
			  dx = 0,
			  dy = 0,
			  dWidth = SWidth, 
			  dHeight = SHeight           
					 
		  // draw image on canvas
		  k.drawImage(l, 
						sx, 
						sy, 
						sWidth, 
						sHeight, 
						dx, 
						dy, 
						dWidth, 
						dHeight);     
		  
	   }
	}
	
	/*
	var objectPreview = {
		imgSrc : 'game_assets/images/boy-spritesheet-mirrored.png',
		positions : [[0,0],[20.5,0],[41,0],[61.5,0]],
		sprtWidth : 20.5,
		sprtHeight : 24,
		nextFrameAt: 12
	}
	preview_sprite( objectPreview )
*/
	
	/*
		preview sprite -- END
	*/
	
	
	
	
	
	// SPRITES EDITOR
	var spriteEditorImage,// NOT REALLY NECESSARY SO FAR
		spriteEditorImageSrc,
		spritesheetParsing = 'horizontal',
		positions = []
		/* how the spritesheet is parsed, 'vertical' | 'horizontal', 
					 changes the order the frames appear in the frame selector */
		
	// PATHS EDITOR
		var mousePressed = false, lastX, lastY, ctx_canvas
		
		
		$.widget( "custom.windowToTab",{
			options: {
				title: 'a sample custom window',
				status: 'minimized',
				width: 50+'%',
				height: 50+'%',
				html: this.innerHTML
				
			},
			_create: function() {
				
				var handleDom = 
				'<div class="handle"><span class="title">'
				+this.options.title
				+'</span>'
				+'<button class="close"><span class="ui ui-icon ui-icon-closethick ui-corner-all"></span></button>'
				+'<button class="minimize"><span class="ui ui-icon ui-icon-minusthick ui-corner-all"></span></button>'
				+'<button class="maximize"><span class="ui ui-icon ui-icon-plusthick ui-corner-all"></span></button>'				
				+'<button class="maximizeDefault"><span class="ui ui-icon ui-icon-arrow-4-diag ui-corner-all"></span></button>'				
				+'</div>'
				this
				.element
				.append( handleDom )
				
				if ( this.options.status == 'maximized' ){
					this._maximize()					
				}
				else if ( this.options.status == 'maximizedDefault' ){
					this._maximizeDefault()					
				}
				else{
					this._minimize()					
				}
								
				this.element
				.data('width',90*window.innerWidth/100)					
				this.element
				.data('height',90*window.innerHeight/100)				 
				//var position = this.element.position();					
				this.element
				.data('top',window.innerHeight/2 - (window.innerHeight*0.9)/2)					
				this.element
				.data('left',window.innerWidth/2 - (window.innerWidth*0.9)/2)	
			

				
				this._on( this.element, {
				  "click button.minimize": function( event ) {
					this.options.status = this._minimize()					
				  }
				});
				
				this._on( this.element, {
				  "click button.maximize": function( event ) {				
					this.options.status = this._maximize()
				  }
				});	
				
				this._on( this.element, {
				  "click button.maximizeDefault": function( event ) {				
					this.options.status = this._maximizeDefault()
				  }
				});	

				this._on( this.element, {
				  "click button.close": function( event ) {				
					this.options.status = this._close()
				  }
				});					
				
				
				if( this.element.hasClass('ui-resizable') == false ){
				
				this.element
				.resizable({
					resize:function(){
					$(this)
					.data('width',$(this).width())					
					$(this)
					.data('height',$(this).height())				 
					var position = $(this).position();					
					$(this)
					.data('top',position.top)					
					$(this)
					.data('left',position.left)	
					}
				})
				.draggable({
					handle: ".handle",containment: "#body",
					drag:function(){
					$(this)
					.data('width',$(this).width())					
					$(this)
					.data('height',$(this).height())				 
					var position = $(this).position();					
					$(this)
					.data('top',position.top)					
					$(this)
					.data('left',position.left)	
					}
				})
				
				this._on( this.element, {
				  "mouseup button.maximize": function( event ) {
					event.preventDefault();				  
					this._maximize()
					this._off( this.element.find('button.maximizeDefault'), "mouseup" );
					this._off( this.element.find('button.maximize'), "mouseup" );
					this._off( this.element.find('button.minimize'), "mouseup" );
				  }
				});
								
				this._on( this.element, {
				  "mouseup button.maximizeDefault": function( event ) {
					event.preventDefault();				  
					this._maximizeDefault()
					this._off( this.element.find('button.maximizeDefault'), "mouseup" );
					this._off( this.element.find('button.maximize'), "mouseup" );
					this._off( this.element.find('button.minimize'), "mouseup" );
				  }
				});
				
				this._on( this.element, {
				  "mouseup button.minimize": function( event ) {
					event.preventDefault();				  
					this._minimize()
					this._off( this.element.find('button.maximize'), "mouseup" );
					this._off( this.element.find('button.maximize'), "mouseup" );
					this._off( this.element.find('button.minimize'), "mouseup" );					
				  }
				});
				
				}
				
			},
			/*_setOption: function( key, value ) {
				if ( key === "value" ) {
					value = this._constrain( value );
				}
				this._super( key, value );
			},*/
			/*_setOptions: function( options ) {
				this._super( options );
				this.refresh();
			},*/			
			_minimize: function() {
				
				this
				.element
				.css({
					position:'relative',
					top:0+'px',
					left:0+'px',
					width: 200,
					height: '1em',
					marginLeft: 0+'px',
					marginTop: 0+'px',
					overflow:'hidden'
				})
				/*.replaceWith('<li id='+this.element.id+'>'+this.element.innerHTML+'</li>')*/					
				.appendTo('#minimized_windows')
								
				if( this.element.hasClass('ui-resizable') ){
					this
					.element
					.resizable('disable')								
				}
				
				
				if( this.element.hasClass('ui-draggable') ){
					this
					.element					
					.draggable('disable')				
				}
				
				this.element.find('.handle .minimize').hide()
				this.element.find('.handle .maximize').show()
				this.element.find('.handle .maximizeDefault').show()
				
				$('#undefined').remove()
								
				this.options.status == 'minimized'
								
				if( this.options.title == 'sprites_editor' ){
					// DISABLE MOUSE INTERACTIONS WITH SPRITE PREVIEW
					$('#sprites_list_container .sprites_list li a').off('mouseenter')
					$('#sprites_list_container .sprites_list li a').off('mouseleave')
				}				
				
				if( this.options.title == 'paths_editor' ){
					
				}	
				
			},
			_maximize: function() {
				
				// DISPLAY MAXIMIZED IN ITS PREVIOUS COORDS & DIMENSIONS
				var width = this.element.data('width'),
					height = this.element.data('height'),
					top = this.element.data('top'),
					left = this.element.data('left')
				
				console.log(width+' '+height+' '+top+' '+left)
				
				this.element			
				/*.replaceWith('<div id='+this.element.id+'>'+this.element.innerHTML+'</div>')*/				
					
				.appendTo('#body')
				.css({
					position:'absolute',
					display: 'block',
					top: top+'px',
					left: left+'px',
					width: width+'px',
					height: height+'px',
					marginLeft: 0,
					marginTop: 0					
				})				
				
				
				if( this.element.hasClass('ui-resizable') ){
					this
					.element
					.resizable('enable')								
				}
				
				if( this.element.hasClass('ui-draggable') ){
					this
					.element					
					.draggable('enable')				
				}
				
				
				this.element.find('.handle .minimize').show()
				this.element.find('.handle .maximize').hide()
				this.element.find('.handle .maximizeDefault').hide()
				
				this.options.status == 'maximized'
				$('#undefined').remove()
				
				if( this.options.title == 'sprites_editor' ){
					$('#sprt-ed-tabs').tabs()
					init_sprite_preview()
				}				
				
				if( this.options.title == 'paths_editor' ){
					$('#cv-ed-tabs').tabs()
				}	
			},
			
			_maximizeDefault: function() {
				
				// DISPLAY MAXIMIZED CENTERED BY DEFAULT
				
				this.element			
				/*.replaceWith('<div id='+this.element.id+'>'+this.element.innerHTML+'</div>')*/				
				
				.appendTo('#body')
				.css({
					position:'absolute',
					display: 'block',
					top: window.innerHeight/2,
					left: window.innerWidth/2,
					width: 90*window.innerWidth/100,
					height: 90*window.innerHeight/100,
					marginLeft: -1* (90*window.innerWidth/100)/2,
					marginTop: -1* (90*window.innerHeight/100)/2					
				})

				if( this.element.hasClass('ui-resizable') ){
					this
					.element
					.resizable('enable')								
				}
				
				if( this.element.hasClass('ui-draggable') ){
					this
					.element					
					.draggable('enable')				
				}
				
				
				this.element.find('.handle .minimize').show()
				this.element.find('.handle .maximize').hide()
				this.element.find('.handle .maximizeDefault').hide()
				
				this.options.status == 'maximizedDefault'
				$('#undefined').remove()
				
				if( this.options.title == 'sprites_editor' ){
					$('#sprt-ed-tabs').tabs()
					init_sprite_preview()
				}				
				
				if( this.options.title == 'paths_editor' ){
					$('#cv-ed-tabs').tabs()
				}	
			},
					
			
			_close: function() {
				this.element.remove()
			}
			
		});
		
		/*
			TAKE A SCREENSHOT OF THE CANVAS OF THE PATHS EDITOR
		*/
		window.screenshot = function(paramsObject){
	
		console.log('window.screenshot: \r\n'+JSON.stringify(paramsObject))
		
	   var fileName = paramsObject.fileName,
		   Canvas = document.getElementById(paramsObject.canvasId),//paramsObject.fromCanvasObject,
		   destinationDir = paramsObject.destinationDir
		
		//////alert(paramsObject.sourceImageWidth+' '+paramsObject.sourceImageHeight)
		
       html2canvas( Canvas,{
					  scale:1,
					  width: paramsObject.sourceImageWidth,
					  height: paramsObject.sourceImageHeight
					}).then(function(cnvs) {
		
		console.log('cnvs: \r\n'+cnvs)
		
         // Get base64URL
        var base64URL = cnvs.toDataURL('image/png').replace('image/png', 'image/octet-stream');
		 
		//var path_name = $('#path_name').val()
				 
         // AJAX request
         $.ajax({
            url: 'canvasToThumbnail.php',
            type: 'POST',
            data: {'image': base64URL, 'fileName':fileName,'destinationDir':destinationDir}            
         })
		 .done(function(data){
			console.log('Upload successfully');
			console.log('data: '+data);
			/*$(".wrapper>*, body>*:not(#levels_list):not(#loader)")
			.toggle()*/
		})
		
       })
     }
	
	    
		function copyCanvasContentToSnapshotCanvas(paramsObject) {  
		
		console.log('copyCanvasContentToSnapshotCanvas(): \r\n'+JSON.stringify(paramsObject))
		  return new Promise(function(resolve,fail){
		  var fromCanvasObject = paramsObject.fromCanvasObject  
		  var destinationCanvas = document.getElementById('snapshot_canvas')
			  destinationCanvas.width = paramsObject.sourceImageWidth
			  destinationCanvas.height = paramsObject.sourceImageHeight
			
			  let destWidth = paramsObject.sourceImageWidth,
				  destHeight =  paramsObject.sourceImageHeight
				  
				  if( typeof paramsObject.destImageWidth !=='undefined'){
					 destWidth =  paramsObject.destImageWidth
				  }
				  
				   if( typeof paramsObject.destImageHeight !=='undefined'){					  
					 destHeight =  paramsObject.destImageHeight					  
				  }

			
			  $('#snapshot_canvas').css({
				width: paramsObject.sourceImageWidth/*destWidth*/,
				height: paramsObject.sourceImageHeight/*destHeight*/,
				margin: 0,
				padding:0,
				border: 'none'
			  })
			  
		  //grab the context from your destination canvas
		  var destCtx = destinationCanvas.getContext('2d');
		  //call its drawImage() function passing it the source canvas directly
		  //return 
		  destCtx.drawImage(
			fromCanvasObject,
			0,
			0,
			paramsObject.sourceImageWidth,
			paramsObject.sourceImageHeight,
			0,
			0,
			destWidth,
			destHeight
		  );
		  
		  resolve()
		  })
		}
		
		/*
		  GENERATE A THUMBNAIL OF BRICKWALL FOR brickwalls_editor
		  IT SHOULD BE MODIFIED IN ORDER TO BE USED BY OTHER EDITORS
		*/
		 window.brickwalls_canvas_screenshot = function(){
		  // COPY CONTENT FROM canvas TO #snapshot_canvas  (#brickwalls_canvas)
		  var paramsObject = {
			fromCanvasObject:canvas,
			sourceImageWidth:sourceWidth,
			sourceImageHeight:sourceHeight,
			canvasId: canvas.id,
			fileName: $('#brickwall_name').val(),
			destinationDir: $('#brickwall_ed_frm .destination_dir').val()
		  }
		  
		  //copyCanvasContentToSnapshotCanvas(paramsObject)
		  /*
		  var paramsObject = {
			canvasId: 'snapshot_canvas',//brickwall_canvas
			fileName: $('#brickwall_name').val(),
			destinationDir: $('#brickwall_ed_frm .destination_dir').val()
		  }*/
		  screenshot(paramsObject)  
		}
		
		function stage_screenshot(){
		   let bgSrcArr = (document.querySelector("#scrollingsContainer .shootable.sprite_thumb") !==null)?document.querySelector("#scrollingsContainer .shootable.sprite_thumb").src.split('?'):'undefined'  
		   let bwSrcArr = (document.querySelector("#BW_avatar img") !==null)?document.querySelector("#BW_avatar img").src.split('?'):'undefined' 
		   let fileName = document.querySelector("#stage_name").value
		 
		   let data = {}
			data.fileName = fileName

			if(bgSrcArr !=='undefined' ){
			   let bgSrcArr2 = bgSrcArr[0].split('/'),
				   bgSrc = bgSrcArr2[bgSrcArr2.length-1]
			   data.bgSrc = bgSrc
			}

			if(bwSrcArr !=='undefined' ){
			   let bwSrcArr2 = bwSrcArr[0].split('/'), 
				   bwSrc = bwSrcArr2[bwSrcArr2.length-1]  
			   data.bwSrc = bwSrc 
			}

			// AJAX request
			 $.ajax({
				url: 'merge_images.php',
				type: 'GET',
				data: data          
			 })
		console.log(data)
		}
	

		/*
		  GENERATE A THUMBNAIL FOR THE SPRITE
		  ./game_assets/sprites/spriteName.png
		*/
		function sprite_screenshot(){
				  // COPY CONTENT FROM canvas TO #snapshot_canvas  (#brickwalls_canvas)
			  var canvas = document.getElementById("sprt_ed_container_sprite").firstElementChild////sprt_ed_container_sprite
				  var paramsObject = {
					fromCanvasObject:canvas,
					canvasId:canvas.id,
					sourceImageWidth:$("#sprt_ed_container_sprite").find('canvas:eq(0)').width(),
					sourceImageHeight:$("#sprt_ed_container_sprite").find('canvas:eq(0)').height()
				  }
				  paramsObject.destinationDir = $('#sprt_ed_frm .destination_dir').val()
				  paramsObject.fileName = $('#sprite_name').val()
				  
				  
				  //copyCanvasContentToSnapshotCanvas(paramsObject)
				  /*
				  var paramsObject = {
					canvasId: 'snapshot_canvas',//brickwall_canvas
					fileName: $('#sprite_name').val(),
					destinationDir:  $('#sprt_ed_frm .destination_dir').val(),
					sourceImageWidth:,
					sourceImageHeight
				  }*/
				  screenshot(paramsObject)  
				}

		window.snapshot_canvas = function( paramsObject ){	
		  
			var canvasId = paramsObject.canvasId 
			var canvas = document.getElementById(canvasId);
			var ctx = canvas.getContext("2d")
			
			ctx.clearRect(0, 0, canvas.width, canvas.height); 
			
			$.each(path_coords,function(i,e){
				console.log(i+' '+e)   
				if( i < path_coords.length-1 ){
				  drawLine(ctx, e[0], e[1], path_coords[i+1][0], path_coords[i+1][1])
				}    
			})
			console.clear()
			console.log('snapshot_canvas: \r\n'+paramsObject)
			paramsObject.sourceImageWidth = canvas.width			
			paramsObject.sourceImageHeight = canvas.height
		  screenshot( paramsObject )
		}
		/*
		function entity_screenshot(){
				// COPY CONTENT FROM canvas TO #snapshot_canvas
		  var canvas = $("#divDEFAULT label .sprite_thumb")// DEFAULT ANIMATION THUMB
		  var canvasID = canvas.attr('id')
			  canvas = document.getElementById(canvasID)			
			  
			  //////alert(canvasID)
			  
		  var paramsObject = {
			fromCanvasObject:canvas,
			canvasId: canvasID,
			sourceImageWidth:canvas.width,
			sourceImageHeight:canvas.height,					
			fileName: $('#entity_name').val(),
			destinationDir: destination_dir.entities 
		  }	
		  screenshot(paramsObject) 	  
						  
		}
		*/
	function entity_screenshot(){
			var imgId = $('#divDEFAULT label img').attr('id')
var img = document.getElementById(imgId)//"im1577606157127"

      var paramsObject = {
				fromCanvasObject:img,
				canvasId: img.id,
				sourceImageWidth:img.width,
				sourceImageHeight:img.height,					
				fileName: $('#entity_name').val(),
				destinationDir: destination_dir.entities 
		  }	
		  
	    var fromCanvasObject = paramsObject.fromCanvasObject  
		  var destinationCanvas = document.getElementById('snapshot_canvas')
			    destinationCanvas.width = paramsObject.sourceImageWidth
			    destinationCanvas.height = paramsObject.sourceImageHeight
			  
			  $('#snapshot_canvas').css({
					width: paramsObject.sourceImageWidth,
					height: paramsObject.sourceImageHeight,
					margin: 0,
					padding:0,
					border: 'none'
			  })
			  
			  
		  //grab the context from your destination canvas
		  var destCtx = destinationCanvas.getContext('2d');
				//call its drawImage() function passing it the source canvas directly
				
				destCtx.drawImage(
				fromCanvasObject,
				0,
				0,
				paramsObject.sourceImageWidth,
				paramsObject.sourceImageHeight,
				0,
				0,
				paramsObject.sourceImageWidth,
				paramsObject.sourceImageHeight
				);	
			
			  var paramsObject = {
					fromCanvasObject: document.getElementById("snapshot_canvas"),
					canvasId: 'snapshot_canvas',//brickwall_canvas
					fileName: $('#entity_name').val(),
					destinationDir: destination_dir.entities,
					sourceImageWidth:img.width,
					sourceImageHeight:img.height						
			  }
								  
			  screenshot(paramsObject) 
		  
						  
		}
		
		
		$(function(){
			
			// TO ENABLE SENDING FORM DATA AS A JSON OBJECT
			$.fn.serializeObject = function() {
				var o = {};
				var a = this.serializeArray();
				$.each(a, function() {
					if (o[this.name]) {
						if (!o[this.name].push) {
							o[this.name] = [o[this.name]];
						}
						o[this.name].push(this.value || '');
					} else {
						o[this.name] = this.value || '';
					}
				});
				return o;
			};
			
			
			
			
			/*
				FOR ALL EDITORS
			*/
			 window.load_editor = function( editorName ){
				
				
				$('div#'+editorName).remove()
				
				var editorDialog = $('<div/>')

				loader()

			    				
				editorDialog.load(editorName+'/index.php',function(){
					
					//document.querySelector('#loader').style.opacity = 0
					
					loaderOff()
					
					// OPEN THE EDITOR IN A JQUERY customWindow widget
					$(this)
					.addClass('customWindow')
					.attr('id',editorName)					
					.appendTo('#body')
					.windowToTab({
						title: editorName,
						status: 'maximizedDefault',
						width: window.innerWidth*0.8, // 80% of the window's width
						height: window.innerHeight*0.8, // 80% of the window's height,
						html: $('#'+editorName).innerHTML
					})
										
					$(this).appendTo(editorDialog)
					
					styleSearchForm()
					
					if(editorName == 'sprites_editor'){
						$('#sprt_ed_frm .destination_dir').val(destination_dir.sprites)
						$("#sprt-ed-tabs" ).tabs();
						
						$('#sprt-tabs-wrapper')
						.css({right: '1em'})
						.draggable()
						
						init_sprite_preview()
						
						$('#sprites_editor').delegate('#toggleSprtImgSelectorBtn','click',function(e){
							e.preventDefault();
							let el = $('#sprt-tabs-wrapper')
							if( el.is(':hidden') ){
								el.show()
							}else{
								el.hide()
							}
						})
						
						// RESET ONE FRAME's hitbox
						$('#sprites_editor').delegate('.resetHB','click',function(e){
							e.preventDefault()
							let hitbox = $(this).parent()
							let hitboxParent = hitbox.parent()

							let Pid = $(this).parent().attr('id'),
								H = parseInt(hitboxParent.css('height')),
								W = parseInt(hitboxParent.css('width'))         
								hitbox.data('x',0)
								hitbox.data('y',0)
								hitbox.data('h',H)
								hitbox.data('w',W)

							$(this)
							.css({
								top: 0,
								left: 0,
								width: hitbox.data('w'),
								height: hitbox.data('h')
							})

							var obj = {}
								  obj.pid = Pid
								  obj.x = 0
								  obj.y = 0
								  obj.h = hitbox.data('h')  
								  obj.w = hitbox.data('w')               
								  hitbox.data('hbData',obj)

							// RESIZE THE HITBOX
							hitbox
							.css({
								top:0,
								left:0,
								width:W,
								height:H
							})
						})
						
						// IMAGES / SPRITES SELECTORS ARE HIDDEN BY DEFAULT
						$('#sprt-tabs-wrapper').hide()
						
						$('#sprt_ed_frm').delegate('#generateHitboxes','click',function(e){
							e.preventDefault()
							updateHitboxesData()
						})
					}
					
					if( editorName == 'paths_editor' ){
						$('#path_ed_frm .destination_dir').val(destination_dir.paths)
						
						$('#canvas-width').val(stageDefaultWidth)
						$('#canvas-height').val(stageDefaultHeight)
						
						$('#cv-ed-tabs').tabs()
						setElementDefaultSize($('#path_canvas'))						
					}	
					if( editorName == 'brickwalls_editor' ){
						$('#brickwall_ed_frm .destination_dir').val(destination_dir.brickwalls)
						$('#brickwalls_editor .tools').draggable()	
						$('#BW-ed-tabs')
						.tabs()
						//.draggable()
						
						// INJECT DEFAULT VALUES
						var dataObject = {
						  '#tileWidth':45,
						  '#tileHeight':40,
						  '#mapRows':5,
						  '#mapColumns':5
						}
						injectDefaultValue( dataObject )						
						generateColorPalette()
					}	
					
					if( editorName == 'entities_editor' ){
						$('#entity_identity_inputs .destination_dir').val(destination_dir.entities)
						/*$('#brickwalls_editor .tools').draggable()	*/
						$('#ent-ed-tabs')
						.tabs({
							create: function( event, ui ){
								
								// IDENTITY
								$('#entity_strength,#entity_resistance,#entity_energy').spinner()								
								generate_entityTypeSelect()
																
								// POSITIONS & MOVEMENTS
								$('<a/>')
								.attr('id','noPathBtn')
								.text('no')
								.appendTo('label[for="entity_path"]')
								
								//$('#entity_pathStep,#entity_pathIdx').spinner()
								
								$('#entity_pathStep')
								.val(1)
								.spinner()
								
								$('#entity_pathIdx')
								.val(0)
								.spinner()
								
								$(document)
								.delegate('#noPathBtn','click',function(e){
									e.preventDefault()
								   $('label[for="entity_path"] .path_thumb')
								   .remove()
								  $('#entity_path').val(-1)
								})
								
								// ANIMATIONS
								generateEntitiesAnimationsInputs()
								generate_entityPathEndSelect()									
								
								
								/*
								  GENERATE ENTITY CANVASES DROPDOWN
								*/
								 var paramsObject =
										{
										  id: 'entity_drawOnCanvas', // element id attribute
										  name: 'drawOnCanvas', // element name attribute
										  selectedValue: 'ground', // option selected by default          
										  target: $('label[for=entity_drawOnCanvas]'),// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
										  injectMethod:'insertAfter',// appendTo | insertAfter | replaceWith,
										  lbl: 'drawOnCanvas' // element's label text         
										}

								generateDropDown( paramsObject )
								
								$('#entity_x,#entity_y')
								.val(0)
								.spinner({
									change: function( event, ui ) {
										 spawnEntityPreview()
									},
									spin: function( event, ui ) {
										 spawnEntityPreview()
									}
								})
						
								$('#entity_dx,#entity_dy')
								.val(0)
								.spinner()
								
								// BEHAVIOURS
								generateBehaviourInputs()
							}
						})
						setElementDefaultSize($('#entity_stage_position_preview'))
						
						$('#entity_firstStateAt')
						.val(0)
						.spinner()
						
						
					}// end if
					
					if( editorName == 'stages_editor' ){
						
						$('#hideEmptyStageFrames').trigger('click')
						
						/*
							DECORATE IFRAME TEST LIVE BUTTONS
						*/
						$('.testIframeCreate')
						.button({
							icon: "ui-icon-newwin",
							showLabel: false,
							iconPosition: "end"
						})

						$('.testIframeStageLoad')
						.button({
							icon: "ui-icon-circle-triangle-e",
							 showLabel: false,
							iconPosition: "end"
						})
						
						$('.liveEditorAddEntityBtn')
						.button({
							icon: "ui-icon-plus",
							showLabel: false,
							iconPosition: "end"
						})
						
						$('.testIframeStagePause')
						.button({
							icon: "ui-icon-pause",
							showLabel: false,
							iconPosition: "end"
						})
						
						$('.testIframeToggleVerbose')
						.button({
							icon: "ui-icon-squaresmall-plus",
							showLabel: false,
							iconPosition: "end"
						})
						
					
						
						$('#liveUpdateContainer').draggable()
						
						
						/*
							CHNAGE TIME UNIT ON CHANGE
						*/
						$('#goToTimeUnit').spinner({
							change:function(event,ui){									
								$('#timeUnit_').text($(this).val())
								tIfrm.contentWindow.timeUnit = $(this).val()
							}
						});
						
						
						$(document).delegate('.screenContainer .sprite_thumb','click',function(e){
							e.preventDefault()
							$('.shootable').removeClass('shootable')
							$(this)   
							.addClass('shootable')
						})
						
						$('#stage_preview_container')
						.resizable()
						
						$('#maxCasualties')
						.spinner()
						
						load_stages_list()	
												
						$( "#stg-ed-tabs" ).tabs({
							activate : function( event, ui ){
								//console.clear()
								//console.log(JSON.stringify(ui))
								
								var activePanel = ui.newPanel.selector								
								var inactivePanel = ui.oldPanel.selector
								
								// ALL TABS
								$('#objectivesContainer, #scrollingsContainer')
								.hide()
								
								switch( activePanel ){
									case '#stg-ed-tabs-2':
										// OBJECTIVES
										$('#objectivesContainer')
										.show()
									break;
									case '#stg-ed-tabs-5':
										// SCROLLINGS
										$('#scrollingsContainer')
										.show()
									break;
									default:
										
									break;									
								}
							}
						});
						
						
						$( "#stage_timeline_container" )
						.draggable({
							handle: "#timeline_controls",
							create: function( event, ui ) {							
								/*$( "#stage_timeline_container" )
								.css({
									top:'100%',
									marginTop:'-100px',
									zIndex: 6
								})*/
								$('#pauseTimeLineBtn').hide()
							}
						})
					.css({display:'none'})
						/*
						$('#stage_ec_manager_container').draggable({
							handle: "#stage_ec_manager_controls",
							create: function( event, ui ) {
							}											
						})
						.hide()
						*/
						$('#timeUnitC')
						.spinner({
						  spin: function(event,ui){
						  /*
						    stageNthFrame = $(this).val()
							
							if( typeof stageReq !== 'undefined' ){
							  cancelAnimationFrame(stageReq)
							}													  
								if( $('#pauseTimeLineBtn').is(':hidden')){
								  $('#pauseTimeLineBtn').show()
								  $('#playTimeLineBtn').hide(mainPreviewStage())      
								}*/
								
								if( ui.value > $(this).val() ){
									stepUp()
								}
								
								if( ui.value < $(this).val() ){
									stepDown()
								}
								
								//stageNthFrame = ui.value
								timeUnit = ui.value
								
							},
						  change: function( event, ui ) {
								/*if( ui.value > $(this).val() ){
									stepUp()
								}
								
								if( ui.value < $(this).val() ){
									stepDown()
								}*/
								
								
								//stageNthFrame = ui.value
								timeUnit = $(this).val()
								//alert(timeUnit)
								if( typeof stageReq !== 'undefined' ){
								  cancelAnimationFrame(stageReq)
								}
								update_timeline_ruler() 
						  
								if( $('#playTimeLineBtn').is(':hidden')){
								  $('#pauseTimeLineBtn').hide()
								  $('#playTimeLineBtn').show()      
								}
								mainPreviewStage()
								
						  },
						  stop: function( event, ui ) {	
						  
						  }
							
						})
						
						$(document)
						.delegate('#stageNthFrameC','change',function(){
							//checkEC()// check if there is any entity cannon at 		
							mainPreviewStage()
						})
						
						$('#stage_idstage_inputs .destination_dir').val(destination_dir.stages)	
						generate_stagePathEndSelect()
						
						// ADD noPath BUTTON
						var noPathBtn = $('<a/>')
						.attr('id','BWnoPathBtn')
						.text('no')

						noPathBtn
						.appendTo('label[for="stage_BW_path"]') 
						
						// ADD noBrickwall BUTTON
						var noBrickwallBtn = $('<a/>')
						.attr('id','BWnoBrickwallBtn')
						.text('no')

						noBrickwallBtn
						.appendTo('label[for="stage_brickwall_name"]')  
						
						/*
						  GENERATE BRICKWALL CANVASES DROPDOWN
						*/
						 var paramsObject =
								{
								  id: 'stage_BW_drawOnCanvas', // element id attribute
								  name: 'BW_drawOnCanvas', // element name attribute
								  selectedValue: 'ground', // option selected by default          
								  target: $('label[for=stage_BW_drawOnCanvas]'),// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
								  injectMethod:'insertAfter',// appendTo | insertAfter | replaceWith,
								  lbl: 'drawOnCanvas' // element's label text         
								}

						generateDropDown( paramsObject )
						
						
						/*
						  UPDATE BW_avatar's z-index on #stage_BW_drawOnCanvas select
						*/
						$('#stage_BW_drawOnCanvas')
						.selectmenu({
							change:function(){
							var drawOnCanvas = $('#stage_BW_drawOnCanvas').val()						
								var canvas = search(drawOnCanvas, canvases)// get drawOnCanvas's index

								if( $('#BW_avatar') !== null && typeof canvas !='undefined'){
									$('#BW_avatar')
									.css({'z-index': canvas.zIndex})
									console.log($('#BW_avatar').css('z-index'))
								}
							}	
						})
						
						$('#stage_BW_pathEnd')
						.val('loop')
						.selectmenu()
						
						
						// SET STAGE & ITS CONTAINER's DIMENSIONS
						setElementDefaultSize($('#stage_preview'))						
						$('#entity_position_movements_preview').height(stageDefaultHeight)
						
						// STAGE SCROLLINGS CONTROLS
						$('#addParallaxBtn')
						.button({
							icon: "ui-icon-plusthick",
							iconPosition: "end"
						})
						
						$('#addParallaxBtn')
						.button({
							icon: "ui-icon-plusthick",
							iconPosition: "end"
						})
						
						// GENERATE STAGE SCROLLING EDITION INTERFACE
						generate_stage_scrolling_UI()
						
						$('#updateStageScrollingScreensBtn')
						.button({
						  icon: "ui-icon-arrowrefresh-1-e",
						  iconPosition: "end"
						})

						
						// STAGE OBJECTIVES CONTROLS
						$('#addObjectiveBtn')
						.button({
							icon: "ui-icon-plusthick",
							iconPosition: "end"
						})
						
						$('#addObjectiveBtn')
						.button({
							icon: "ui-icon-plusthick",
							iconPosition: "end"
						})
						
						// GENERATE STAGE OBJECTIVES EDITION INTERFACE
						 generate_stage_objective_UI()
						
						
						$('#updateStageObjectivesBtn')
						.button({
						  icon: "ui-icon-arrowrefresh-1-e",
						  iconPosition: "end"
						})
						
						
						// STAGE BRICKWALL						
						$('#stage_BW_x')
						.val(0)
						.spinner({
							spin:function(event,ui){														
								$('#BW_avatar')
								.css({
									left: ui.value+'px',								
								})							
							},
							change:function(event,ui){														
								$('#BW_avatar')
								.css({
									left: $('#stage_BW_x').val()+'px',								
								})							
							}						
						})
						
						$('#stage_BW_y')
						.val(0)
						.spinner({
							spin:function(event,ui){														
								$('#BW_avatar')
								.css({
									top: ui.value+'px',								
								})							
							},
							change:function(event,ui){														
								$('#BW_avatar')
								.css({
									top: $('#stage_BW_y').val()+'px',								
								})							
							}						
						})
						
						
						
						$('#stage_BW_dx,#stage_BW_dy,#stage_BW_pathIdx,#stage_BW_firstStateAt')
						.val(0).spinner()
						
						$('#stage_BW_pathStep')
						.val(1).spinner()
						
						
						// CREATE BW STATE MANAGER AND BTN TO OPEN IT
						var paramsObject = 
						{
							statesOwnerId: 'stageBW',// THE name ATTRIBUTE OF ENTITY/EC/BW THIS STATES COLLECTION BELONGS TO, ex: flower2.ent
							statesDefaultModel: 'stageBW', // states[]WILL BE POPULATED WITH THE states[] FROM statesDefaultModel
							target: $('#openBWStatesManagerLbl'),// openStatesManagerLbl JQUERY OBJECT TO USE AS A REFERENCE TO INJECT THE STATES MANAGER BTN 
							injectMethod: 'insertAfter', //HOW TO INJECT THE BTN, i.e.: 'append | insertBefore | insertAfter | replaceWith
							statesManagerId: 'stages_editor_BWStatesManager', //ID OF THE INSTANCE OF THE MANAGER DIALOG
						}
						generateStatesManager( paramsObject )	
						
						
						
					} // end stages_editor
					
					if( editorName == 'campaigns_editor' ){
						
						/*
						  LOAD CAMPAIGNS EDITOR -- begin
						*/
						$('#campaigns_destination_dir').val( destination_dir.campaigns)

						$('#cmp-ed-tabs').tabs({
						  activate : function( event, ui ){
							/*console.clear()
							console.log(JSON.stringify(ui))*/

							var activePanel = ui.newPanel.selector								
							var inactivePanel = ui.oldPanel.selector
							var panelIdClass = activePanel.substr(1)
								
							//console.log(activePanel+' '+inactivePanel+' '+panelIdClass)
							
							// HIDE ALL TABS
							$('.assetsList')
							.hide()
								
							$('.'+panelIdClass)
							.show()    
							
						  }// activate
						})

						// REMOVE ALL USELESS DELETE BTNS
						$('#campaigns_editor #cmp-ed-tabs form > div div ul li a:last-child:not(.delete_campaign):not(.stop_bgm)').remove()



						// CREATE ASSETS DROPPABLES
						$.each($('#cmp_ed_frm > div'), function( i, e){
						  let thisId = $(this).attr('id')
						  /*
							SKIP CAMPAIGN TAB
								 CAMPAIGNS TAB
								 UNDEFINED TAB (a non-relevant div)
						  */
						  console.log('thisId: '+thisId)
						  if( typeof(thisId) === 'undefined' || thisId == 'cmp-ed-tabs-8' || thisId == 'cmp-ed-tabs-1' ){
							return true
						  }
						  
						  var lblTxt =
							  $('#cmp_ed_frm ul:eq(0) li a')
							  .filter(function(){
								console.log($(this).attr('href') + ' ' + thisId)
								return $(this).attr('href').indexOf(thisId) != -1
							  })
							  .text() 
						  
						  var txtAreaId = 'assets_'+lblTxt
						  
						  var assetsTextAreaLabel = 
						  $('<label/>')  
						  .attr('for',txtAreaId)
						  .attr('relatedPanel',thisId)
						  .text(lblTxt)
						  
						  var assetsTextArea = 
						  $('<textarea/>')
						  .attr('id', txtAreaId)
						  .attr('name',lblTxt)//$(this).attr('id')
						  .val('[]')
						  
						  $('#campaign_inputs').append(assetsTextAreaLabel)
						  $('#campaign_inputs').append(assetsTextArea)
						  $('#campaign_inputs').append('<br/>')
						  
						  var sharedId = 'paired'+Date.now()
						  
						  var ulId = 'ul'+Date.now()
						  
						  // INJECT SOURCE ASSETS LIST TO TAB PANEL
						  var ul =
						  $('<ul/>')
						  .attr('id',ulId)  
						  .addClass('assetsList') 
						  .addClass($(this).attr('id')) 
						  
						  $(this).append(ul)
						  
						var selectables = [
										  'stageLbl',
										  'entityLbl',
										  'pathLbl',
										  'spriteLbl',
										  'bgmLbl',
										  'BWLbl'
										]
						  
						  // INJECT TARGET ASSETS LIST TO TAB PANEL
						  $('#'+ulId)
						  .addClass(sharedId)
						  .sortable({
							connectWith: '.'+sharedId,
							forceHelperSize: true,
							forcePlaceholderSize : true,
							placeholder: "sortable-placeholder",
							cursor: "grab",
							receive: function( event, ui ) {
								var array = []        
								var textArea =        
								$('#'+txtAreaId) 
								
								$('#'+ulId)
								.find('li a')
								.each(function(i,e){ 
								  var a = $(this)
								  var spanText = 
									  $(this)
									  .children('span')
									  .filter(function(i){                 
										var classes = []                   
										$(this)
										.attr('class')
										.split(' ')
										.map(function(clssName){  
										  classes.push(clssName)
										})                
										console.log('classes: '+classes)                
										var firstClass = classes[0]
													
										var select = false                
										select = (
										$.inArray(firstClass,selectables) !== -1 )?true:select
										return select == true
									  })
								  .text()          
										  
								  if( spanText !=='' ){
									  array.push(spanText)  
								  }
								})
							  // POPULATE RELEVANT ASSET TEXTAREA  
							  textArea.val(JSON.stringify(array))
							},
							stop: function( event, ui ) {
								var array = []        
								var textArea =        
								$('#'+txtAreaId)                
								$('#'+ulId)
								.find('li a')
								.each(function(i,e){ 
								  var a = $(this)
								  var spanText = 
									  $(this)
									  .children('span')
									  .filter(function(i){                 
										var classes = []                   
										$(this)
										.attr('class')
										.split(' ')
										.map(function(clssName){  
										  classes.push(clssName)
										})                
										console.log('classes: '+classes)                
										var firstClass = classes[0]
										console.log('firstClass: '+firstClass)                
										var select = false                
										select = (
										$.inArray(firstClass,selectables) !== -1 )?true:select
										return select == true
									  })
								  .text()
								  if( spanText !=='' ){
									  array.push(spanText)  
								  }
								})
							  // POPULATE RELEVANT ASSET TEXTAREA  
							  textArea.val(JSON.stringify(array))      
							}
						  })
						  
						  // SOURCE ASSETS LIST
						  $(this)
						  .find('ul')
						  .addClass(sharedId)
						  .sortable({
							connectWith: '.'+sharedId,
							placeholder: "sortable-placeholder",
							forceHelperSize: true,
							forcePlaceholderSize : true,    
							cursor: "grab"
						  })
						  
						  console.log('sharedId: '+sharedId)
						  
						})
						
						// STYLE SOUND CONTROLS TO PREVIEW [play] [stop]
						decorateBGMControls()
						
						// MAKE THE USELESS FIRST ANCHOR (select_bgm) UNCLICKABLE, TO PREVENT LOSING WINDOW FOCUS
						$('#cmp-ed-tabs-7 ul li a.select_bgm')
						.button('option','disabled',true)
						
						/*
						  LOAD CAMPAIGNS EDITOR -- end
						*/
						/*
							PREVENT CLICK ON SORTABLES -- begin						
							, .ui-sortable.sounds_list li a
						*/
							$(document)
							.delegate('.assetsList li a, .ui-sortable.stages_list li a, .ui-sortable.sprites_list li a, .ui-sortable.brickwalls_list li a, .ui-sortable.entities_list li a, .ui-sortable.paths_list li a','click',function(e){
								e.preventDefault()								
							})
						/*
							PREVENT CLICK ON SORTABLES -- end						
						*/
						
						
						
					}
					
				})// load
						
			}
			
			$(document).delegate('.export_campaign','click',function(e){
				e.preventDefault()
				let hrefArray = $(this).attr('href').split('/')
				let href = hrefArray[hrefArray.length-1]
					hrefArray = href.split('.json')
					href = hrefArray[0]
					dialogNotify('Exporting zip of:'+href)
				populateAssetsTable({name:href})

			})

			
			// TO ENABLE SENDING FORM DATA AS A JSON OBJECT
			$.fn.serializeObject = function() {
				var o = {};
				var a = this.serializeArray();
				$.each(a, function() {
					if (o[this.name]) {
						if (!o[this.name].push) {
							o[this.name] = [o[this.name]];
						}
						o[this.name].push(this.value || '');
					} else {
						o[this.name] = this.value || '';
					}
				});
				return o;
			};
			
			// RESET FORM (sprites editor)

			function reset_form(){
			  //empty name, spritesheet, width, height
			  $('#sprite_name,#sprite_src,#sprite_width,#sprite_height,#sprite_positions,#sprite_hitboxes')
			  .val(null)
			  
			  // remove selectable frames
			  $('#sprt_ed_container_frames').empty();
			  // remove selectable sprite frames
			  $('#sprt_ed_container_sprite').empty();
			  
			  hbData = []
			  spritesData = []
			}
			
			/*
				SET FORM FIELDS DEFAULT VALUES
				AND TRIGGER CHANGE INCASE IT NEEDS TO
			*/
			window.injectDefaultValue = function( dataObject ){  
			  $.each( dataObject,function(i,e){
				 $(i).val(e).trigger('change')
			  }) 
			}

			
			/*
				PARAMETERS: canvas id - string
			*/
			 window.clear_canvas = function(){
				
			  if(arguments.length > 0){
				var canvas = document.getElementById(arguments[0])    
			  }
			  else{
				var canvas = document.getElementById('sprt_ed_image_grid')    
			  }
				// clear canvas
			  
			  var ctx = canvas.getContext("2d")   
			  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
			}
			
			// RESET THE SPRITES EDITOR FORM
			$(document)
			.delegate('#reset_form','click',function(e){
				reset_form()
				clear_canvas()
			})
			
			/*
				SPRITES EDITOR ONLY
			*/			
			$('#sprites_editor_btn').on('click',function(){load_editor('sprites_editor')})
			$('#paths_editor_btn').on('click',function(){load_editor('paths_editor')})
			$('#brickwalls_editor_btn').on('click',function(){load_editor('brickwalls_editor')})
			$('#entities_editor_btn').on('click',function(){load_editor('entities_editor')})
			$('#stages_editor_btn').on('click',function(){load_editor('stages_editor')})
			$('#campaigns_editor_btn').on('click',function(){load_editor('campaigns_editor')})
			
			$(document)
			.delegate('#images_list_container .select_image','click',function(e){
				e.preventDefault();	
								
				spritesData = []
				
				$('.hitBoxControls').remove()
				
				var imgSrc = $(this).children('img:eq(0)').attr('src')
					//spriteEditorImage = $(this).children('img:eq(0)')
					spriteEditorImageSrc = imgSrc; //make it globally available
					$('#sprite_src').val(spriteEditorImageSrc);// update spritesheet input					
					$('#sprt_ed_container_frames').val(null);// remove selectable frames
					$('#sprt_ed_container_sprite').empty(null);// remove selectable sprite
					copy_image_to_canvas(imgSrc)
					
			})
			
			
			
			function copy_image_to_canvas( imgSrc ){
			
				// COPY IMAGE TO #image_container				
				var container = $('#sprt_ed_container_image');
				var canvas = document.getElementById('sprt_ed_image_grid')    
				var ctx = canvas.getContext("2d")	
								
				var img = new Image()
				
				img.onload = function(){
	
					var canvas = document.getElementById('sprt_ed_image_grid')    
					var ctx = canvas.getContext("2d")   
				
					// resize canvas to fit image size					
					ctx.canvas.width = img.naturalWidth;
					ctx.canvas.height = img.naturalHeight ;
					
					// clear canvas
					ctx.clearRect(0,
                    0,
                    canvas.clientWidth,
                    canvas.clientHeight);
					
					// draw image on canvas
					ctx.drawImage(img, 0,0);
					
					var colSize = $('#sprite_width').val(),
						rowSize = $('#sprite_height').val()				
					if( $('#sprite_width').val() != '' && $('#sprite_height').val() != '' ){
						drawGrid('sprt_ed_image_grid',
								  ctx.canvas.width, 
								  ctx.canvas.height, 
								  colSize, 
								  rowSize);
								  
						populateFrames(
								  ctx.canvas.width, 
								  ctx.canvas.height, 
								  colSize, 
								  rowSize)  
					}
					
					
				}
				img.src = imgSrc
			}

			function populateFrames( canvasWidth, canvasHeight, colSize, rowSize){
							
				
				var total_frames = (canvasWidth/colSize) * (canvasHeight/rowSize)
				//////alert(total_frames)
				
				var frames = []
								
				var n = 0,
					x = 0,
					y = 0
				while ( n <= total_frames-1) {	
					
					frames.push({x: Number(x),y: Number(y)})
					
						console.log(spritesheetParsing)
					
						if( spritesheetParsing == 'horizontal' ){
							if( x >= Number(canvasWidth) - Number(colSize) ){
								y +=  Number(rowSize)
								x = 0;//Number(colSize)
							}
							x +=  Number(colSize)
						}else if( spritesheetParsing == 'vertical' ){
							if( y >= Number(canvasHeight) - Number(rowSize) ){
								x +=  Number(colSize)
								y = 0;//Number(rowSize)
							}
							y +=  Number(rowSize)
						}
					n++
				}
										
				var n = 0;
				while (n < frames.length){
				
					var frame = frames[n]
					var x = frame.x,
						y = frame.y
						console.log(frame)			
					var canvasId = 'frame'+n//Math.floor(Date.now())							
					var newCanvas = $('<canvas/>')
						.attr('id',canvasId)
						.attr('width', colSize)
						.attr('height', rowSize)
						.attr('title', JSON.stringify({x:x,y:y}))						
						.addClass('frameCtrl')
					
					newCanvas.appendTo('#sprt_ed_container_frames')	
					
					var canvas = document.getElementById(canvasId)
					var ctx = canvas.getContext("2d") 					
					var img = document.getElementById('sprt_ed_image_grid')    						
					//ctx.drawImage(img, x, y, rowSize, colSize, 0, 0, rowSize, colSize);	
					ctx.drawImage(img, x, y, colSize, rowSize, 0, 0, colSize, rowSize);
					n++
				}
			}

			function drawGrid(idCanvas, bw, bh, colSize, rowSize){ 

				$('#sprt_ed_container_frames').empty();// remove selectable frames
				$('#sprt_ed_container_sprite').empty();// remove selectable sprite
				
				var canvas = document.getElementById(idCanvas)     
				var ctx = canvas.getContext("2d")
				// VERTICAL LINES
				for (var x = 0; x <= bw/colSize; x += 1) {
					ctx.moveTo(x*colSize, 0);
					ctx.lineTo(x*colSize, bh);
				}
				// HORIZONTAL LINES
				for (var x = 0; x <= bh/rowSize; x += 1) {
					ctx.moveTo(0, x*rowSize);
					ctx.lineTo(bw, x*rowSize);
				}
				ctx.strokeStyle = "#000";
				ctx.stroke();
			}

			function updateGrid( imgSrc ){
				// clear canvas 
				//ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);
				copy_image_to_canvas( imgSrc )
			}
			
			/*
				EVENT LISTENERS
			*/
			
			$(document)
			.delegate('#sprite_width,#sprite_height','change',function(){
				updateGrid(spriteEditorImageSrc)
			})

			$(document).on('change', 'input[name="spritesheetParsing"]', function() {
			  var spritesheetParsing = $("input[name='spritesheetParsing']:checked").val();
				console.log(spritesheetParsing)
				updateGrid(spriteEditorImageSrc)
			});
			
			// ADD A FRAME TO THE SPRITE
			$(document)
			.delegate('#sprt_ed_container_frames .frameCtrl','click',function(){
				
				// ORIGINAL CANVAS
				var oCanvasId = $(this).attr('id')
				var oCanvas = document.getElementById(oCanvasId);
				
				// CLONE CANVAS
				var cloneCanvasId = Math.floor(Date.now())
				var canvasClone = 
					$(this)
					.clone()
					.attr('id', cloneCanvasId)
					.appendTo('#sprt_ed_container_sprite')
				
				
				let lastCanvasIdx = $('#sprt_ed_container_sprite .frameCtrl').length - 1
				
				let countHB = $('.hitBoxControls').length
				
				/*
					ALWAYS INSERT NEW CANVASES BEFORE THE FIRST HITBOX CONTROL
				*/
				if( countHB > 0){
					$('#'+cloneCanvasId).insertBefore('.hitBoxControls:first')					
				}
				
				var canvas = document.getElementById(cloneCanvasId);//$('#'+cloneCanvasId)
				var ctx = canvas.getContext("2d")				
				ctx.drawImage(oCanvas, 0, 0);
				
				// get sprite's frame's x,y,width,height, id
				populateSpritesData(lastCanvasIdx)
				// generate sprite's frame's hitbox
				generateHitBoxControls(lastCanvasIdx)
				
				// update sprites frames positions
				sprite_generate_json()
			})
			
			// REMOVE A FRAME FROM THE SPRITE
			$(document)
			.delegate('#sprt_ed_container_sprite .frameCtrl','click',function(){
				let id = $(this).attr('id')
				let hbId = '#HB'+id	
				
				/*
					REMOVE THE MATCHING ENTRY IN spritesData[]
				*/
				spritesData.some(function(obj,idx){
					console.log(obj+' '+obj)
					if(obj.id == id){ 
						spritesData.splice(idx,1)
						console.log(spritesData+' removed!')        
					}
				})
				
				$(hbId).remove()// remove hitbox controls
				$(this).remove()// remove the frame
				
				// update sprites frames positions
				sprite_generate_json()
				// update all hitboxes data
				updateHitboxesData()
			})
			
			
			
			// CONVERT FRAMES INTO ARRAY DATA
			// GENERATE ARRAY POSITIONS[]
			// POPULATE #sprite_positions with positions[]
			 window.sprite_generate_json = function(){
			
			  positions = []
			  $('#sprt_ed_container_sprite .frameCtrl')
			  .each(function(idx,el){
				console.log(idx+' '+el.title)
				
				var data = JSON.parse(el.title)
				
				 var position = []
				     position[0] = [data.x,data.y]
				positions.push(position[0])
			  })
			  $('#sprite_positions')
				.val(JSON.stringify(positions))			  
			}
			
			$(document).delegate('#generatePositions', 'click', function(event) {
				event.preventDefault()			
				sprite_generate_json();// POPULATE THE TEXTAREA WITH positions[]
			})
			
			// EXPORT A SPRITE TO A JSON FILE
			$(document).delegate('form#sprt_ed_frm', 'submit', function(event) {
			  event.preventDefault();
			  loader()
			  /*
				GENERATE A THUMBNAIL OF THE SPRITE
				.game_assets/sprites/spriteName.png
				will be used by:
					sprites editor
					entities editor
					stage editor
			  */
			  sprite_screenshot() 
			  
			  sprite_generate_json();// POPULATE THE TEXTAREA WITH positions[]
			  
			  var json = $('form#sprt_ed_frm').serializeObject()  
			
			console.clear()
			console.log(json)
			
			  $.ajax({
				  type : "POST",
				  async: true,
				  url : "export_json_file.php",
				  data : {json:JSON.stringify(json)}
			  })
			  .done(function(response){
				  console.log(response)
				  loaderOff()
				  var jsonObj = JSON.parse(response)
				  
				  dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
					load_sprites_list()				  
			  })  
			})
			
			function load_sprites_list(){
				loader()
				// REFRESH SPRITES LIST
				$('#sprites_list_container')
				.load('./sprites_editor/ #sprites_list_container .sprites_list',function(){
					loaderOff()
					init_sprite_preview()
				})
			}
			
			
			
			$(document).delegate('#sprites_list_container .sprites_list a.delete_sprite', 'click', function(e) {
				e.preventDefault()
				loader()
				$.ajax({
					method: 'POST',
					url: 'deleteFile.php',
					asyn: true,
					data: {fileUrl: $(this).attr('href')}
				
				})
				.done(function(response){
					 loaderOff()
					 var jsonObj = JSON.parse(response)
					
					//////alert( jsonObj.type+':\r\n'+jsonObj.msg  )
					dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
					load_sprites_list()
				})
			})
			
			
			/*
				LOAD A SPRITE FROM THE UL .sprites_list (sprites_editor)
			*/			
			$(document).delegate('#sprites_list_container .sprites_list a.select_sprite', 'click', function(e) {
				e.preventDefault()
				loader()
				$.getJSON($(this).attr('href'))
				.done(function(json){
					
					
					loaderOff()
				  console.log(json)				  
				  
					spritesData = []
					hbData = []
				  
					$('#sprite_name').val(json.name)
					$('#sprite_description').val(json.sprite_description)					
					$('#sprite_src').val(json.src)
					$('#sprite_width').val(json.width)
					$('#sprite_height').val(json.height)
					$('#sprite_positions').val(json.positions)
					$('#sprite_frame').val(json.frame)
					$('#sprite_frameMax').val(json.frameMax)
					$('#sprite_frameTicker').val(json.frameTicker)
					$('#sprite_nextFrameAt').val(json.nextFrameAt)
					
					$('#sprite_hitboxes').val(JSON.stringify(json.hitboxes))
					hbData = json.hitboxes
					
					
					// select the spritesheet
					$('.select_image img[src="'+json.src+'"]').trigger('click')
					
					var imgSrcArr = json.src.split('?')// get rid of ?t=...
					var imgSrcWOT = imgSrcArr[0]
										
					var imgSrc = $('.select_image')
					.filter(function(){
						return $(this)
						.children('img:eq(0)')
						.attr('src')
					    .indexOf(imgSrcWOT) > -1
						
					})
					.children('img:eq(0)')
					.attr('src')
										
					//spriteEditorImage = $(this).children('img:eq(0)')
					spriteEditorImageSrc = imgSrc; //make it globally available
					$('#sprite_src').val(spriteEditorImageSrc);// update spritesheet input					
					$('#sprt_ed_container_frames').val(null);// remove selectable frames
					$('#sprt_ed_container_sprite').empty(null);// remove selectable sprite
					copy_image_to_canvas(imgSrc)	
					
						
					// GIVE IT TIME TO FINISH LOAD THE JSON AND GENERATING FRAMES
					// THEN GENERATE THE SPRITE WITH ITS FRAMES 
					
					
					// COPY IMAGE TO #image_container				
				var container = $('#sprt_ed_container_image');
				var canvas = document.getElementById('sprt_ed_image_grid')    
				var ctx = canvas.getContext("2d")	
								
				var img = new Image()
				
				img.onload = function(){
	
					var canvas = document.getElementById('sprt_ed_image_grid')    
					var ctx = canvas.getContext("2d")   
				
					// resize canvas to fit image size					
					ctx.canvas.width = img.naturalWidth;
					ctx.canvas.height = img.naturalHeight ;
					
					// clear canvas
					ctx.clearRect(0,
                    0,
                    canvas.clientWidth,
                    canvas.clientHeight);
					
					// draw image on canvas
					ctx.drawImage(img, 0,0);
					
					var colSize = $('#sprite_width').val(),
						rowSize = $('#sprite_height').val()				
					if( $('#sprite_width').val() != '' && $('#sprite_height').val() != '' ){
						drawGrid('sprt_ed_image_grid',
								  ctx.canvas.width, 
								  ctx.canvas.height, 
								  colSize, 
								  rowSize);
								  
						populateFrames(
								  ctx.canvas.width, 
								  ctx.canvas.height, 
								  colSize, 
								  rowSize)


						// SELECT THE FRAMES PERTAINING positions
						$.each( json.positions ,function(i,e){
						  var x = e[0], y = e[1]						
						  var str = '{"x":'+x+","+'"y":'+y+'}'
						  $.each( $('#sprt_ed_container_frames').children('.frameCtrl'),function(a,b){
							if( 
							  $(this).attr('title').indexOf(str) != -1 									
							){
							  $(this)
								.trigger('click')
							}
						  })
						})// $.each(JSON.parse(json.positions)
						
					// NOTIFY OBJET LOADED
					var msg = 'sprite animation built'					
					dialogNotify(msg)
					
					}
					
				}
				img.src = imgSrc
				
					
					// NOTIFY OBJET LOADED
					var msg = 'sprite '+json.name+' loaded'					
					dialogNotify(msg)
					
				})
				
				
			})
						
			 window.init_sprite_preview = function(){
			// LOAD JSON and START PREVIEW ON MOUSEOVER
			  //$('#sprites_list_container .sprites_list li a.select_sprite').on('mouseenter',function(e){
			  $(document).delegate('#sprites_list_container .sprites_list li a.preview_sprite','click',function(e){
				
				cancelAnimationFrame(spriteReq)	
				
			    e.preventDefault()
				
				//$('#spritePreviewContainer').html(null)
				
				$.getJSON($(this).attr('href'))
					.done(function(json){		  
					 var objectPreview = {}
					 var n = 0
				   $.each(json,function(i,e){
					 console.log(i+' '+e)
					 switch(i){
					   case 'src': 
						 objectPreview.imgSrc = e
					   break;
					   case 'positions': 
						 var positions = e//JSON.parse(e)
						 objectPreview.positions = positions
					   break;
					   case 'width':              
						 objectPreview.sprtWidth = e           
					   break;
					   case 'height': 
						 objectPreview.sprtHeight = e           
					   break;
					   case 'nextFrameAt': 
						 objectPreview.nextFrameAt = e              
					   break;
					 }
					  n++;
					 console.log('n:'+n)
					 if( n >= 9   ){
					   objectPreview.previewContainer = $('#spritePreviewContainer')
						 preview_sprite( objectPreview )
					 }// if     
 
				   })// each json      
				})// done    
			  })	
/*
			 // stop preview on mouseout
			 //$('#sprites_list_container .sprites_list li a.select_sprite').on('mouseleave',function(e){
			$(document).delegate('#sprites_list_container .sprites_list li a.select_sprite','mouseleave',function(e){
				//e.preventDefault()	   
					cancelAnimationFrame(spriteReq)	
				//$('#spritePreviewContainer').html(null)
			  })
			  */
			}
			
			
				/*
					SPRITES - HIT BOX - begin
				*/
					window.spritesData = []
					window.hbData = []
				/*
					populateSpritesData()
						DOES:						
							create sprites frame data
							and save sprites frames data objects into spritesData
						ARGUMENTS:
							idx - integer - optional
							used to populate only one sprite frame				
				*/
				window.populateSpritesData = function(){
					
					let idx = ''
					if(arguments.length == 1){
						idx = arguments[0];// N,ie: 0,1,2,...N - canvas index
					}					
					
					$('#sprt_ed_container_sprite canvas')
					.each(function(i,obj){						
						if( 
							(idx != '' && i == idx) 
							|| idx == ''
						){
							
							var position = $(obj).position()
							
							var spriteObject = {}
								spriteObject.x = Math.ceil(position.left)
								spriteObject.y = Math.ceil(position.top)
								spriteObject.width = Math.ceil($(obj).width())
								spriteObject.height = Math.ceil($(obj).height())
								spriteObject.id = $(obj).attr('id') 
								
								spritesData.push(spriteObject)
						}
					})
				}
				
				
				/*
					generateHitBoxControls()
						DOES:						
							generate UI controls to define one hitbox for each sprite frame
							on each hitbox change updateHitboxesData() saves all hitboxes data
							and populate the textarea #sprite_hitboxes with 
							an array of json objects containing all hitboxes data
						ARGUMENTS:
							idx - integer - optional
							used to generate only one hit box control for one frame
				*/
				window.generateHitBoxControls = function(){
					
					let idx = ''
					if(arguments.length == 1){
						idx = arguments[0];// N,ie: 0,1,2,...N - canvas index
					}					
					else{
						$('.hitBoxControls').remove()
					}
					
					$.each(spritesData,function(i,obj){ 
					
					if( 
						(idx != '' && i == idx) 
						|| idx == ''
					){
					
					let HBCreateBtn =
					  $('<a/>')
					  .attr('href','#')
					  .addClass('resetHB')
					  .text('reset')
					  .button({
						icon: "ui-icon-arrow-4-diag",
						showLabel: false
					  })		

					let HBControlsContainer =
						 $('<div/>')
						.attr('id','HB'+obj.id)
						.addClass('hitBoxControls')
						.css({           
							/*position:'absolute',*/
							width: obj.width,
							height: obj.height,
							marginTop: -1*obj.height,
							marginLeft: obj.width*i
						})
						.appendTo('#sprt_ed_container_sprite') 

						$('<div/>') 
						.addClass('hitbox')      
						.css({                  
							width: obj.width,
							height: obj.height,
							background:'rgba(255,255,255,0.3)'
						})
						.append(HBCreateBtn)
						.resizable({  
						   handles: "n, e, s, w, ne, se, sw, nw",
						   containment:'parent',
						   create: function( event, ui ){
								if( typeof hbData !== 'undefined'){
									if( typeof hbData[i] !== 'undefined'){
										  console.log('hbData[i]: \r\n'+ hbData[i])
										  
									let Top = hbData[i].y,
										Left = hbData[i].x,
										Height = hbData[i].h,
										Width = hbData[i].w,
										Pid = $(this).parent().attr('id')          
											$(this).data('x',Left)
											$(this).data('y',Top)
											$(this).data('h',Height)
											$(this).data('w',Width)
										
										$(this)
										.css({
											top: Top+'px',
											left: Left+'px',
											width: Width+'px',
											height: Height+'px'
										})
										
									var obj = {}
										  obj.pid = Pid
										  obj.x = $(this).data('x') 
										  obj.y = $(this).data('y')  
										  obj.h = $(this).data('h')  
										  obj.w = $(this).data('w')               
										  $(this).data('hbData',obj) 								  								  
									}
								}  	  
							},
						   stop: function(event, ui) {            
							 let width = $(event.target).width(),
								 height = $(event.target).height();            
								  $(this).data('h',height)
								  $(this).data('w',width)
									
							  var obj = {}
								  obj.pid = $(this).data('pid')
								  obj.x = $(this).data('x') 
								  obj.y = $(this).data('y')  
								  obj.h = $(this).data('h')  
								  obj.w = $(this).data('w')
								  $(this).data('hbData',obj)  
								
								// update all hitboxes data at once
								updateHitboxesData()									
							}
						})
						.draggable({        
							containment:'parent',
							create: function( event, ui ){
							
								if( typeof hbData !== 'undefined'){
									if( typeof hbData[i] !== 'undefined'){
										  console.log('hbData[i]: \r\n'+ hbData[i])
										  
									let Top = hbData[i].y,
										Left = hbData[i].x,
										Height = hbData[i].h,
										Width = hbData[i].w,
										Pid = $(this).parent().attr('id')          
											$(this).data('x',Left)
											$(this).data('y',Top)
											$(this).data('h',Height)
											$(this).data('w',Width)
										
									$(this)
									.css({
										top: Top+'px',
										left: Left+'px',
										width: Width+'px',
										height: Height+'px'
									})
									
									var obj = {}
										  obj.pid = Pid
										  obj.x = $(this).data('x') 
										  obj.y = $(this).data('y')  
										  obj.h = $(this).data('h')  
										  obj.w = $(this).data('w')               
										  $(this).data('hbData',obj) 								  								  
								  }
								} 	  
							},
							
							drag: function(event, ui) {

							let Top = ui.position.top,
								Left = ui.position.left,
								Pid = $(this).parent().attr('id')           
									$(this).data('y',Top)
									$(this).data('x',Left)

								var obj = {}
									  obj.pid = Pid
									  obj.x = $(this).data('x') 
									  obj.y = $(this).data('y')  
									  obj.h = $(this).data('h')  
									  obj.w = $(this).data('w')               
									  $(this).data('hbData',obj)  
							},
							stop: function(event, ui){
								// update all hitboxes data at once
								updateHitboxesData()							
							}
												
						})						
						.appendTo('#HB'+obj.id)       
						}// if if( (idx != '' && i == idx) || idx == '')
							
					
					})
				}


				window.updateHitboxesData = function(){

					let allHbDataObjArr = []

					$('.hitbox')
					.each(function(i, o){
						console.log(i+' '+o)
						console.log( $(this).data('hbData'))
						
						if( typeof $(this).data('hbData') !== 'undefined' ){
						let hbData = $(this).data('hbData')
							hbData.idx = i            
							$(this).data('hbData',hbData)
							delete hbData.pid// pid is useless for the app
							let cloneObj =  hbData           
							allHbDataObjArr.push(cloneObj)   
							$('#sprite_hitboxes').val(JSON.stringify(allHbDataObjArr))
						}
					})
					console.log(allHbDataObjArr)
					
				}
/*
				// get sprites x,y,width,height, id
				populateSpritesData()
				// generate hitboxes
				generateHitBoxControls()
*/
	
				/*
					SPRITES - HIT BOX - end
				*/
			
			
			
			
			
			
			/*
				SPRITES EDITOR ONLY - end
			
			*/
			
			
			
			
			/*
				PATHS
			*/
			// REFRESH PATHS LIST
			window.load_paths_list = function(){
				
				$('#paths_list_container').load('./paths_editor/ #paths_list_container .paths_list',function(e){
					console.clear()
					console.log(e)
				})
			}
			
			
			$(document).delegate('.paths_list a.delete_path', 'click', function(e) {
				e.preventDefault()
				loader()
				$.ajax({
					method: 'POST',
					url: 'deleteFile.php',
					asyn: true,
					data: {fileUrl: $(this).attr('href')}
				
				})
				.done(function(response){
					loaderOff()
					// REFRESH SPRITES LIST
					load_paths_list()
					
					 var jsonObj = JSON.parse(response)	
					////alert( jsonObj.type+':\r\n'+jsonObj.msg  )
					
				})
			})
			
			
			/*
				CREATE RELATIVE PATH FROM ABSOLUTE PATH    
				return the relative path
			*/

				window.get_relative_path_from_absolute = function(){

				console.clear()
					 var n = 0,
						 x,
						 y,
						 x2,
						 y2,
						 path_coords2 = []
					 
					 while ( n <= path_coords.length-2 ){         
					   x = path_coords[n][0]
					   y = path_coords[n][1]           
					  x2 = path_coords[n+1][0]
					  y2 = path_coords[n+1][1]           
					  path_coords2[n] = [x2-x, y2-y]             
					  console.log(path_coords2[n])              
					  n++
					 }
					return path_coords2
				}

		/*
			LOAD A BRICKWALL --begin
		*/
		
		  // LOAD PATH into paths editor FROM THE .json file
			$(document).delegate('#BW_brickwalls_list_container .brickwalls_list a.select_brickwall', 'click', function(e) {
			  e.preventDefault()	
			  loader()
			  load_brickwall($(this).attr('href'))				
			})
			
			// LOAD PATH into paths editor FROM THE .json file
			function load_brickwall(brickwallFileUrl){
				
				$.getJSON(brickwallFileUrl)
				.done(function(json){ 
				loaderOff()				
				$('#brickwall_name').val(json.brickwall_name)          
				$('#wallBrick_description').val(json.description)          
				    
				$('#brickWidth').val(json.brickWidth)
				$('#brickHeight').val(json.brickHeight)
				$('#brickRowCount').val(json.brickRowCount)
				$('#brickColumnCount').val(json.brickColumnCount)
				$('#brickPadding').val(json.brickPadding)
				$('#brickWallSkin').val(json.brickWallSkin)// RADIO 
				$("input[name=brickWallSkin][value=" +json.brickWallSkin + "]").prop('checked', true);
				$('#bricksEqualTiles').val(json.bricksEqualTiles)// RADIO
				$("input[name=bricksEqualTiles][value=" +json.bricksEqualTiles + "]").prop('checked', true);          
				$('#brickWallImage').val(json.brickWallImage)
				$('#tileWidth').val(json.tileWidth)
				$('#tileHeight').val(json.tileHeight)
				$('#mapRows').val(json.mapRows)
				$('#mapColumns').val(json.mapColumns)
				$('#sourceWidth').val(json.sourceWidth)
				$('#sourceHeight').val(json.sourceHeight)          
				// CLEAR CANVAS & CANVAS_NRG
				clear_canvas('brickwall_canvas')// clear canvas
				clear_canvas('brickwall_nrg_canvas')// clear canvasNRG 

				
				brickWidth =  json.brickWidth
				brickHeight =  json.brickHeight
				brickRowCount = json.brickRowCount
				brickColumnCount = json.brickColumnCount          
				brickPadding = json.brickPadding
				brickWallSkin = json.brickWallSkin          
				bricksEqualTiles = json.bricksEqualTiles
				brickWallImage = json.brickWallImage          
				tileWidth = Number(json.tileWidth)
				tileHeight = Number(json.tileHeight)
				mapRows = json.mapRows
				mapColumns = json.mapColumns          
				sourceWidth = Number(json.sourceWidth)
				sourceHeight = Number(json.sourceHeight)            
				canvas.width = sourceWidth
				canvas.height = sourceHeight*2		
				canvasEnergy.width = sourceWidth
				canvasEnergy.height = sourceHeight*2          
				mapHeight = sourceHeight
				mapWidth = sourceWidth
				
				// POPULATE THE 2 ARRAYS tiles & nrgAmount
				$.each( JSON.parse( json.wallBrickMap ) ,function(i,e){              
				  tiles[i] = e
				})				
				$.each( JSON.parse( json.wallBrickMapEnergy ) ,function(i,e){              
				  nrgAmount[i] = e
				})
				
				$('#wallBrickMap').val(json.wallBrickMap)    // TEXTAREA       
				$('#wallBrickMapEnergy').val(json.wallBrickMapEnergy)// TEXTAREA     
				
				// RESET THE EDITOR STATE
				initWallBrickMap()
				
					// DRAW SPRITESHEET TILES
			  if ( brickWallSkin == 'img' ){				  
				  
				 image = new Image();
					image.width = sourceWidth
					image.height = sourceHeight
					image.onload = function() {								
						context.drawImage(image, 0, 0,sourceWidth,sourceHeight);				  
						//image = brickWallImage				 
					//redrawSource()// FOR TILES PALETTE  
						drawTheGrid()
					}
				image.src = brickWallImage 
					
			  // FOR brickWallSkin == 'img' ONLY 
					
					// GET THE THUMBNAIL SOURCE
					var imgSrc = $('#brickwall_ed_frm .destination_dir').val()
								+'/'
								+json.brickwall_name+'.png'        
						let tmpImg = new Image();
							tmpImg.width = sourceWidth
							tmpImg.height = sourceHeight
							tmpImg.onload = function() {								
								context.drawImage(tmpImg, 0, 0,sourceWidth,sourceHeight);
								  
							}
						tmpImg.src = imgSrc+'?t='+Date.now() ;	
					}	
					else if( brickWallSkin == 'color' ){
					/*
						image = new Image() ;           
						image.onload = function() {
			   */   
						  var i = 0;             
						  let gridX = 0, 
							  gridY = 0; 

						  while (i <= wallBrickMap.length ){
							// DRAW COLOR BRICKS
							sourceTile = tiles[i] 
								
							// PAINT THE TILE WITH THE SELECTED COLOR
							var color_idx = sourceTile
							if( color_idx != -1 ){
								context.fillStyle = colors[color_idx];    
								context.fillRect(gridX, gridY, tileWidth, tileHeight);
							}	
							// DRAW RESISTANCE DATA ON NRG CANVAS
							contextNRG.font = 0.5*tileWidth+"px Comic Sans MS";
							contextNRG.fillStyle = (nrgAmount[i] == 'I')?"red":"lime";
							contextNRG.textAlign = "right";
							contextNRG.fillText( nrgAmount[i], gridX+tileWidth*0.8, gridY+tileHeight*0.8);	

							// ITERATE
							gridX += tileWidth
							if( gridX == sourceWidth){               
							  gridX = 0
							  gridY += tileHeight              
							  if( gridY == sourceHeight+sourceHeight){
								gridY  = 0
							  }
							} 
							i++;
						 }
					}//else if( brickWallSkin == 'color' ){
					
					// NOTIFY OBJET LOADED
					var msg = 'brickwall '+json.brickwall_name+' loaded'					
					dialogNotify(msg)					
					
				})// DONE
			}
			
			
			
			
			
			
		/*
			LOAD A BRICKWALL --end
		*/
			
			$(document).delegate('#BW_brickwalls_list_container .brickwalls_list a.delete_brickwall', 'click', function(e) {
				e.preventDefault()
				loader()
				$.ajax({
					method: 'POST',
					url: 'deleteFile.php',
					async: true,
					data: {fileUrl: $(this).attr('href')}
				
				})
				.done(function(response){
					loaderOff()
					 var jsonObj = JSON.parse(response)
					////alert( jsonObj.type+':\r\n'+jsonObj.msg  )					
					load_brickwalls_list()
				})
			})
			
			 window.load_brickwalls_list = function(){
				// REFRESH BRICWALLS LIST
				loader()
				$('#BW_brickwalls_list_container')
				.load('./brickwalls_editor/ #BW_brickwalls_list_container .brickwalls_list',function(){
					loaderOff()
				//init_sprite_preview()
				})
			}
			
				
			
			window.loader = function (){			
					
				// NO ARGUMENTS , INIT THE LOADER
					var b = $('#body'),
						bW = Number.parseInt(b.css('width')),
						bH = Number.parseInt(b.css('height'))
						
						console.log(bW+' '+bH)
					$('#loader')
					.css({
						zIndex: 100000000000,
						opacity:1,
						position: 'absolute',
						top: bH/2+'px',
						left: bW/2+'px',
						marginTop: -1 * 60+'px',
						marginLeft: -1 * 60+'px',
						width: 120+'px',
						height: 120+'px'
					})
				
			}
			
		})
		
		
		window.loaderOff = function(){
			document.querySelector('#loader').style.marginTop = '-200%'
		}
		
		 window.colors = 
			  [
				'#000', '#444', '#222', 
				'#fff', '#999',
				'#00f', '#05f', '#09f', '#f0f', 
				'#fcf', '#808', '#f7f', 
				'#f00', '#f70', '#f90', '#fcc', 
				'#f40', '#ff0',
				'#090', '#0f0' 
			  ]
		function generateColorPalette(){
		  var palette = $("#colorWatchesContainer")
			palette.empty()
		 
		  // MAKE THE COLOR PICKER
		  $.each(colors,function(i,e){  
			var colorWatch = 
			$('<a/>')
			.attr('href','#') 
			.attr('title',colors[i])
			.attr('idx',i)
			.addClass('color_select')
			.css({
			  display:'inline-block',
			  width: 50,
			  height: 50,
			  backgroundColor: colors[i]
			})
			.appendTo(palette)    
		  })

		  $(document)
		  .delegate('.color_select','click',function(e){
			e.preventDefault()
			
			$('.color_select').removeClass('selected')
			$(this).addClass('selected')
			
			//////alert($(this).css('background-color')+' / '+$(this).attr('title'))
		  })		
	}
	
	/*
		ENTITIES -- begin
	*/
	// BEHAVIOURS
	 function generateBehaviourInputs(){

		  //console.clear()
		  // GENERATE BEHAVIOURS INPUTS IN THE 5th TAB
		  $('#ent-ed-tabs-5 .wrapper')
		  .html(null)
		  
		  $.each(behaviours,function(i,e){

			//console.log(i+' '+e.value)

			var label =
			$('<label/>')
			.text(e.lbl)

			var input1 =
			$('<input/>')
			.attr('type','radio')
			.attr('id',i+e.idTrue)  
			.attr('name',i)
			.val(true)

			var label1 =
			$('<label/>')
			.attr('for',i+e.idTrue)  
			.text(e.idTrue)

			var input2 =
			$('<input/>')
			.attr('type','radio')
			.attr('id',i+e.idFalse)  
			.attr('name',i)
			.val(false)

			var label2 =
			$('<label/>')
			.attr('for',i+e.idFalse)  
			.text(e.idFalse)

			$('<span/>')
			.addClass('btnSet')
			.appendTo('#ent-ed-tabs-5 .wrapper')  
			
			label
			.appendTo('#ent-ed-tabs-5 .wrapper .btnSet:last')  

			input1
			.appendTo('#ent-ed-tabs-5 .wrapper .btnSet:last')  
			label1
			.appendTo('#ent-ed-tabs-5 .wrapper .btnSet:last')  

			input2
			.appendTo('#ent-ed-tabs-5 .wrapper .btnSet:last')  
			label2
			.appendTo('#ent-ed-tabs-5 .wrapper .btnSet:last')  

			$('#ent-ed-tabs-5 .wrapper')
			.append('<br/>')

		  })
		  
		  $( ".btnSet" ).controlgroup();
		  
		}// function
	
	
	// IDENTITY
	function generate_entityTypeSelect(){
		var type_options = {
		  enemy: 'enemy',
		  graphic: 'graphic',
		  powerup: 'powerup',
		  ball: 'ball',
		  paddle: 'paddle',
		  speedChanger: 'speedChanger',
		  bumper: 'bumper',
		  escorteeTarget: 'escorteeTarget',
		  obstacle: 'obstacle'
		}

		var options_str;

		$.each(type_options, function(i,e){
		  options_str += '<option id="'+i+'" value="'+e+'">'
		  options_str +=  e
		  options_str += '</option>'
		  
		})

		var entityTypeSelect = 
			$('<select/>')
			.attr('id','entity_type')
			.attr('name','type')
			.html(options_str)

		$('#entity_type')
		.replaceWith(entityTypeSelect)
	}
	
	// POSITIONS AND MOVEMENTS
	// SELECT A PATH FOR THE ENTITY FROM ENTITY EDITOR
	$(document)
	.delegate('#entity_path','click',function(e){
	  e.preventDefault()
	  loader()
	   var paramsObject = {
			selectorId: 'entities_paths_selector',
			target: $('#entity_path'),
			injectMethod: 'insertAfter',
			contentPath: './paths_editor/ #paths_list_container .paths_list',
			title: 'select a path for the entity',
			searchFormId : 'entityFilterPaths'
		}
		generateAssetSelector( paramsObject )
	  
	})
	
	// CLOSE ENTITY EDITOR PATH SELECTOR
	$(document)
	.delegate('#closeEntityPathSelector','click',function(e){
	  e.preventDefault()
	  $('#entities_paths_selector').remove()
	})
	
	// ENTITIES EDITOR SELECT PATH FOR ENTITY
	$(document)
	.delegate('#entities_paths_selector .paths_list .select_path','click',function(e){
	  e.preventDefault()
	  $('label[for="entity_path"] .path_thumb').remove()
	  var img = $(this).children('img')
	  $('#entity_path').val(img.attr('title'))
	  img
	  .addClass('path_thumb')
	  .appendTo('label[for="entity_path"]')
	  $('#entities_paths_selector').remove()
	})
	
	// ANIMATIONS
	
	// GENERATE SPRITES PLACEHOLDERS INDICATING up,down,left,right,appear,disappear in the 4th tab
	function generateEntitiesAnimationsInputs(){ 
	  var spriteAnimations  =
	  {
		UP: {x: 50, y: 0}, 
		LEFT: {x: 25, y: 25},
		DEFAULT: {x: 50, y: 25},
		RIGHT: {x: 75, y: 25},
		DOWN: {x: 50, y: 50},
		APPEAR: {x: 25, y: 75},
		DISAPPEAR: {x: 50, y: 75},
		PUNCHED: {x: 75, y: 75}
	  }
	  
	  $('#ent-ed-tabs-4').html(null)
	  
	  $('#animationsContainer img.sprite_thumb,#animationsContainer .remove_animation,#entity_witness')
	  .remove()
	  
	  $('<div/>')
	  .attr('id','animationsContainer')
	  .css({ 
		  position: 'absolute',
		  display: 'block',
		  top: 1.5+'em',
		  left: 0,
		  width: 100+'%',
		  height: 700+'px',
		  backgroundColor: '#ccc' 
	  })
	  .appendTo('#ent-ed-tabs-4')
	  
	  $.each(spriteAnimations,function(i,e){
		var input = 
			$('<input/>')
			.attr('type','text')
			.attr('id',i)
			.attr('name',i)// INPUT
		var a = 
			$('<a/>')
			.attr('href','#')			
			.html('&times;')			
			.addClass('remove_animation')// INPUT
		var label = 
			$('<label/>')      
			.attr('for',i)
			.text(i)// LABEL
		var div = 
			$('<div/>')      
			.attr('id','div'+i)
			.css({
			  position:'absolute',
			  top: e.y+'%',
			  left: e.x+'%'
			})// CONTAINER
			
		 div
		 .append(label)
		 .append(input)
		 .append(a)
		 .appendTo('#animationsContainer') // INSERT LABEL, INPUT TO DOM
	  })
	  
	  
	  //generateRotationOrientationSelector()
	}
	
	
	/*
	function generateRotationOrientationSelector(){
		
		
		
	}
	*/
	
	$(document)
	.delegate('#animationsContainer input','click',function(e){
	  e.preventDefault() 
	  
    $(this).parent('div').addClass('selectedAnimation') 
	loader()
	  
	  var paramsObject = {
			selectorId: 'entities_sprites_list_container',
			target: $('#animationsContainer'),
			injectMethod: 'appendTo',
			contentPath: './sprites_editor/ #sprites_list_container',// .sprites_list
			title: 'select an animation sprite for the entity',
			searchFormId : 'entityFilterSprites'
		}
		generateAssetSelector( paramsObject )

	})
	
	
	
	// ENTITY EDITOR
	$(document)
	  .delegate('#entities_sprites_list_container .select_sprite','click',function(e){
	  e.preventDefault()
	  var label = $('.selectedAnimation label'),
		  input = $('.selectedAnimation input')  
	  label.children('img').remove()  
	  var img = $(this).children('img')	 
	  img
		.addClass('sprite_thumb')
		.attr('id','im'+Date.now())
		.appendTo(label)
		
	  input.val($(this).children('.spriteLbl').text())
	  $('.selectedAnimation').removeClass('selectedAnimation')
	  $('#entities_sprites_list_container').remove()
	  
	  // INIT / UPDATE ENTITY PREVIEW
	  spawnEntityPreview()
	  
	})
	
	$(document)
	.delegate('#closeEntitySpritesSelector','click',function(e){
	  e.preventDefault()
	  
	  $('.selectedAnimation').removeClass('selectedAnimation')
	  
	  $('#entities_sprites_list_container').remove()
	})
	
	/*
	$(document)
	.delegate('#entity_x,#entity_y','change',function(i,e){
	   spawnEntityPreview()
	})
	*/
	
	// EXPORT AN ENTITY TO A JSON FILE
	$(document).delegate('form#ent_ed_frm', 'submit', function(event) {
	  event.preventDefault();
	 loader()
	 
	   if($('#entity_states').val()==''){
		  $('#entity_states').val('[]')
	   }
	  
	 
	  /*
		GENERATE A THUMBNAIL OF THE ENTITY
		.game_assets/entities/entityName.png
		will be used by:
			stages editor
			levels editor					
	  */
	  entity_screenshot()
	  
	  var json = $('form#ent_ed_frm')
	  .serializeObject()  
	
		//console.clear()
		console.log('submit: \r\n'+json)
	
	  $.ajax({
		  type : "POST",
		  async: true,
		  url : "export_json_file.php",
		  data : {json:JSON.stringify(json)}
	  })
	  .done(function(response){
		  console.log(response)
		  loaderOff()
		  var jsonObj = JSON.parse(response)
		 //////alert( jsonObj.type+':\r\n'+jsonObj.msg  )
		 dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
  
			load_entities_list()
		  
	  })  
	})
	
	
	function generate_entityPathEndSelect(){
	
	    var selectId = 'entity_pathEnd',
			newSelectId = 'entity_pathEnd',
			selectName = 'pathEnd'
			
		if(arguments.length > 0){
			selectId = arguments[0].selectId			
			newSelectId = arguments[0].newSelectId
			selectName = arguments[0].selectName
		}
	
		var select_options = {
		  loop:'loop',
		  reverseLoop:'reverseLoop',
		  stop:'stop'		   
		}
    
		var options_str = '';
		$.each(select_options, function(i,e){
		  options_str += '<option id="'+i+'" value="'+e+'">'
		  options_str +=  e
		  options_str += '</option>'		  
		})
			
		if( arguments.length > 0 ){			
			var lbl = 
			$('<li id="liPathEnd"><label for="'+newSelectId+'">pathEnd</label></li>')						
			.appendTo('#entityCannonFrm')
			
			var select = 
				$('<select/>')
				.attr('id',newSelectId)
				.attr('name',selectName)
				//.wrap('<li></li>')
				.html(options_str)
				
			select.appendTo('#entityCannonFrm li:last')
			
		} 
		else{			
			var select = 
			$('<select/>')
			.attr('id',newSelectId)
			.attr('name',selectName)
			.html(options_str)

			$('#'+selectId)
			.replaceWith(select)			
		}			
	}

	
	 function spawnEntityPreview(){
	  
	  $('#entity_witness')
	  .remove()
	  
	  if( $('#divDEFAULT').find('.sprite_thumb').length ==0 ){
		return true
	  }
	  
	  var x = $('#entity_x'),
		  y = $('#entity_y'),
		  dx = $('#entity_dx').val(),
		  dy = $('#entity_dy').val()

	  var preview_div = $('#entity_stage_position_preview')

	  var divDEFAULTClone = 
		  $('#divDEFAULT')
		  .clone(true,true)
		  .find('.sprite_thumb')

	  $('<div/>')
	  .attr('id','entity_witness')
	  .css({
		position: 'absolute',
		top: y.val()+'px',
		left: x.val()+'px',
		width: divDEFAULTClone.width(),
		height: divDEFAULTClone.width()
	  })
	  .append(divDEFAULTClone)
	  .appendTo( preview_div )
	  .draggable({
		drag: function( event, ui ) {
		  console.log(ui.position.left)
		  x.val(parseInt(ui.position.left))
		  y.val(parseInt(ui.position.top))
		}
	  })
	}
	
	
	/*
		LOAD AN ENTITY INTO THE ENTITY EDITOR
	*/
	$(document).delegate('#entities_list_container a.select_entity', 'click', function(e) {
		e.preventDefault()
		loader()
		$.getJSON( $(this).attr('href') )
		.done(function(json){  
			
		   // IDENTITY
		  $('#entity_name').val(json.name)
		  $('#entity_type').val(json.type)			
		  $('#entity_energy').val(json.energy)			
		  $('#entity_strength').val(json.strength)
		  $('#entity_resistance').val(json.resistance)
		  $('#entity_description').val(json.description)
		  
		  $('#entity_firstStateAt')
		  .val(json.firstStateAt)
		  
          // STATES 
		  $('#entity_states').val(JSON.stringify(json.states))
		  
			// CREATE STATE MANAGER AND BTN TO OPEN IT
		    var paramsObject = 
			{
				statesOwnerId: json.name,// THE name ATTRIBUTE OF ENTITY/EC/BW THIS STATES COLLECTION BELONGS TO, ex: flower2.ent
				statesDefaultModel: json.name,// states[]WILL BE POPULATED WITH THE states[] FROM statesDefaultModel
				target: $('#openStatesManagerLbl'),// JQUERY OBJECT TO USE AS A REFERENCE TO INJECT THE STATES MANAGER BTN 
				injectMethod: 'insertAfter', //HOW TO INJECT THE BTN, i.e.: 'append | insertBefore | insertAfter | replaceWith
				statesManagerId: 'entities_editor_statesManager', //ID OF THE INSTANCE OF THE MANAGER DIALOG
			}
			generateStatesManager( paramsObject )	
			
	      
		  // POSITIONS & MOVEMENTS
		  $('#entity_x').val(json.x)
		  $('#entity_y').val(json.y)			
		  $('#entity_dx').val(json.dx)			
		  $('#entity_dy').val(json.dy)
		  $('#entity_path').val(json.path)
		  $('#entity_pathEnd').val(json.pathEnd)
		  $('#entity_pathStep').val(json.pathStep)			
		  $('#entity_pathIdx').val(json.pathIdx)			
		  $('#entity_drawOnCanvas')
		  .val(json.drawOnCanvas)
		  .selectmenu( "refresh" )			

		  // ANIMATIONS
		  $('#DEFAULT').val(json.DEFAULT)  
		  $('#UP').val(json.UP)
		  $('#RIGHT').val(json.RIGHT)			
		  $('#DOWN').val(json.DOWN)			
		  $('#LEFT').val(json.LEFT)
		  $('#APPEAR').val(json.APPEAR)
		  $('#DISAPPEAR').val(json.DISAPPEAR)			
		  $('#PUNCHED').val(json.PUNCHED)			

		  // ADD THE SPRITES' THUMBNAILS INTO LABELS
		  var animations = ['DEFAULT','UP','RIGHT','DOWN','LEFT','APPEAR','DISAPPEAR']
		  $('.sprite_thumb').remove() 
		  $.each(animations,function(i,e){
			
			if( json[e] !='' ){
			
			  var asset_dir = destination_dir.sprites//$('#sprt_ed_frm .destination_dir').val()                    
			  var src = asset_dir+ '/' + $('#'+e).val() + '.png'+'?t='+Date.now()          
			  var lbl = $('label[for="'+e+'"]')

			 // console.log('lbl: ' +lbl.attr('for')+'  i: '+i+' e: '+e)

			  var img =
			  $('<img/>')
			  .attr('src',src)
			  .addClass('sprite_thumb')
			  .attr('id','im'+Date.now())
			  .appendTo(lbl)
			
			}
			
		  })
		  
		  spawnEntityPreview()

		  // BEHAVIOURS 
		  var listBehaviours = []
		  
		  $.each(behaviours,function(i,e){
			listBehaviours.push(i)
			//console.log('listBehaviours:'+i+' '+e)
		  })

		  $.each( json, function(i,e){
			
			var keys = Object.keys(obj)
			var keyName = i    
			
		   //console.log('keyName:'+keyName)
		   //console.log('IS IN ARRAY'+$.inArray(i, listBehaviours)+' e:'+e)
			  if( $.inArray(keyName, listBehaviours) > -1 ){
				
			   var checkedRadio = keyName 
				   checkedRadio += (e == false)?'No':'Yes'   
				 //console.log('checkedRadio:'+checkedRadio)
				
				$('#'+checkedRadio).trigger('click')                
				//$('#bounceHorizontallyYes').trigger('click')                
			  }          
		  })
		
		loaderOff() 	
		
		// NOTIFY OBJET LOADED
		var msg = 'entity '+json.name+' loaded'					
		dialogNotify(msg)					
				
			
		})// DONE
	})
/*
    LOAD AN ENTITY INTO THE ENTITY EDITOR end
*/

function load_entities_list(){
	// REFRESH ENTITIES LIST
	$('#entities_list_container')
	.load('./entities_editor/ #entities_list_container .entities_list',function(e){
		//console.log(e)
	})
}

$(document).delegate('#entities_list_container .entities_list a.delete_entity', 'click', function(e) {
  e.preventDefault()
  loader()
  $.ajax({
    method: 'POST',
    url: 'deleteFile.php',
    asyn: true,
    data: {fileUrl: $(this).attr('href')}

  })
    .done(function(response){
		loaderOff()
    var jsonObj = JSON.parse(response)
    dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
    load_entities_list()
  })
})

$(document).delegate('#reset_entities_form', 'click', function(e) {
	e.preventDefault()
	$('#ent_ed_frm input[type="text"],#ent_ed_frm textarea').val(null)
	$('#ent_ed_frm input.destination_dir').val( destination_dir.entities)
	generateEntitiesAnimationsInputs()	
	generate_entityPathEndSelect()	
	generate_entityTypeSelect()
	generateBehaviourInputs()
})


/*
  ENTITY: REMOVE ANIMATION
*/
$(document)
.delegate('.remove_animation','click',function(e){
  e.preventDefault()
  var parent = $(this).parent()
      parent.find('input').val(null)
      parent.find('.sprite_thumb').remove()
})





// STAGES EDITOR

/*
  function ec_manager_ui()
*/
function ec_manager_ui(){

  // REFERENCE DOM elements
  var ec_manager = $('#stage_ec_manager')

  ec_manager.html(null)

  var ec_list = 
  $('<ul/>')
  .attr('id','ec_list')    
		
  /*
  // 1 determine highest start  
  var n = 0
  while ( n < entityCannons.length ){
    if ( entityCannons[n].start > startMax ){
      startMax = entityCannons[n].start
    }
    n++
  }// end while    
  */
	startMaxUpdate()

  // 2- iterate from 0 to startMax
  for ( stageNthFrame = 0; stageNthFrame <= startMax; stageNthFrame++ ){

    var li_ecNames ='',
        li_ecNames_arr = [] 

    var li_ecs = searchEC() //( array[] )           
    console.log('li_ecs: \\\\r\\\\n'+li_ecs)   

    var li = 
        $('<li/>')          
    .addClass('selectStageFrame')

    li.append('<span class="ec_count">'+stageNthFrame+'</span>') 

    var objEC = JSON.parse(li_ecs)

    for ( var n = 0; n < li_ecs.length; n++ ){

      if (typeof objEC[n] === 'undefined' )  {continue}

      if ( li_ecNames_arr.indexOf( objEC[n].entityName ) == -1 ){                
        li_ecNames_arr[li_ecNames_arr.length] = objEC[n].entityName
      }//endif       

      li_ecNames +=objEC[n].entityName
    }//end for


    li.append('<span class="li_ec"></span>')


    for ( var n = 0; n < li_ecNames_arr.length; n++ ){       
      //count li_ecNames_arr[n]           
      var count = occurrences( li_ecNames, li_ecNames_arr[n] );

      //add count + name + thumb to LI object      
      var imgSrc = destination_dir.entities+'/'+li_ecNames_arr[n]+'.png'

      var img = $('<img/>')
      .attr('src',imgSrc)

    li
	.find('.li_ec')
	.append(img)          
	.append('<span>'+li_ecNames_arr[n]+'</span><span>'+count+'</span><hr/>')  

    }// end for        

    //add LI object to ec_list
    ec_list
    .append(li)

  }// end for 

  ec_manager
    .append(ec_list)

}

/*
  function ec_manager_ui2()
*/
function ec_manager_ui2(){

  // REFERENCE DOM elements
  var ec_manager = $('#stage_ec_manager')

  ec_manager.html('')

  var ec_list = 
  $('<ul/>')
  .attr('id','ec_list')    
	
	startMaxUpdate()

  // 2- iterate from 0 to startMax
  for ( stageNthFrame = 0; stageNthFrame <= startMax; stageNthFrame++ ){

    var li_ecNames ='',
        li_ecNames_arr = [] 

    var li_ecs = searchEC() //( array[] )           
    console.log('li_ecs:'+li_ecs)   

    var li = 
    $('<li/>')          
    .addClass('selectStageFrame')

    li.append('<span class=\"ec_count\">'+stageNthFrame+'</span>') 

    var objEC = JSON.parse(li_ecs)

    for ( var n = 0; n < li_ecs.length; n++ ){
      if (typeof objEC[n] === 'undefined' )  {continue}
      /*
        if this type of entity is not already registered in li_ecNames_arr
          register it
      */
      if ( li_ecNames_arr.indexOf( objEC[n].entityName ) == -1 ){                
        li_ecNames_arr[li_ecNames_arr.length] = objEC[n].entityName
      }//endif
      li_ecNames +=objEC[n].entityName
    }//end for
    
    li.append('<ul class=\"li_ec\"></ul>')

    for ( var n = 0; n < li_ecNames_arr.length; n++ ){       
      //count li_ecNames_arr[n]           
      var count = occurrences( li_ecNames, li_ecNames_arr[n] );

      //add count + name + thumb to LI object      
      var imgSrc = destination_dir.entities+'/'+li_ecNames_arr[n]+'.png'
      let img = new Image()        
      img.setAttribute('id','img'+Date.now())      
      img.onload = function(){
        // ADD TITLE WITH IMAGE DIMENSIONS
        var id = img.id
        var i = document.querySelector('#'+id)
        img.setAttribute('title',img.width+'x'+img.height)    
      }
      img.src = imgSrc 
      
    /*
      DISPLAY ONE EC TYPE WITH THE NUMBER OF ITS INSTANCES 
    
    li
    .find('.li_ec')
    .append(img)          
    .append('<span>'+li_ecNames_arr[n]+'</span><span>'+count+'</span><hr/>')
    */ 
      
     var html =  
         '<li><a href="#" class="showECThisName">'
         +'<span class="img">'              
         +'</span>'
         +'<span class="lbl">'     
         +li_ecNames_arr[n]
         +'</span>'
         +'<span class="count">'
         +count
         +'</span></a></li>'
      
     li
     .find('ul.li_ec')
     .append(html)//<hr/> 
     
     li
     .find('.li_ec li:last .showECThisName .img') 
     .prepend(img)
      
    }// end for        
    
     li
     .find('ul.li_ec')
     .append('<li class="EC_btns"></li>')
    
    for ( var n = 0; n < li_ecs.length; n++ ){
       if (typeof objEC[n] === 'undefined' )  {continue}
       console.log(JSON.stringify(objEC[n]))
       
         var imgSrc = destination_dir.entities+'/'+objEC[n].entityName+'.png'
         var img = 
         $('<img/>')         
         .addClass('ECImgClone')         
         .attr('src',imgSrc)
         
         var editEcBtn = 
         $('<a/>') 
         .attr('href','#')
         .attr('ECID',objEC[n].ID)
         .attr('title',objEC[n].ID)
         .addClass('EC_edit')
         .addClass(objEC[n].entityName)
         .append(img)
         .on('click',function(e){
            e.preventDefault()
            var entityID = $(this).attr('ECID')           
             $('#'+entityID)
              .trigger('click') 
          })
            
         li
         .find('.li_ec li.EC_btns')
         .append(editEcBtn)           
          
      ECTL_make_tooltip(objEC[n].ID)
           
     } 
    
    
    //add LI object to ec_list
    ec_list
    .append(li)
	
  }// end for 

  ec_manager
  .append(ec_list)
	
  createEcManagerDeleteBtns()	
	//showECThisName
	
} //end  ec_manager_ui2
 
/*
  FILTER EC TO DISPLAY FROM WITHIN EC MANAGER
*/
$(document)
.delegate('.showECThisName','mouseup',function(e){
 
  //e.preventDefault()
  let This = $(this)
  var entityName = $(this).find('.lbl').text()
  
  var btns = $(this)
  .parents('.selectStageFrame')
  .find('.EC_edit')
  
  btns
  .hide()
  
  btns
  .filter(function(){
    return $(this).hasClass(entityName)    
  })
  .show()
  
  createEcManagerDeleteBtns()
  	
})

/*
  function ECTL_make_tooltip()
  DOES:
    MAKE A TOOLTIP FOR EC from Time Line
*/
/* function ECTL_make_tooltip(ID){ 
  $('.ECTL'+ID).remove()
	// GENERATE TOOLTIP  '#stage_ec_manager'
  $(document).tooltip({
    track:true,
    create: function( event, ui ) {
      $(this).addClass('ECTL'+ID)	
    },
    open: function(){
      $('.ui-helper-hidden-accessible div:hidden').remove()
    },
    items: '.EC_edit, .edit_ec',  
		content: function() {
		  var ID = $( this ).attr('ECID');        
		  var ECobject = searchEcInEntities(ID)
		  var dataString = ''			

		  $.each(ECobject[0],function(i,e){        
			 if( i === 'states' ){
			 dataString += i+' x '+e.length+' <br/>'			 
			 }else{
			 dataString += i+' : '+e+' <br/>'			 
			 }
		  })       
		  return dataString
		}
	})
} */

 function ECTL_make_tooltip(ID){ 
  $('.ECTL'+ID).remove()
    
  var ECobject = searchEcInEntities(ID)
  var dataString = ''
  $.each(ECobject[0],function(i,e){        
	 if( i === 'states' ){
	 dataString += i+' x '+e.length+' <br/>'			 
	 }else{
	 dataString += i+' : '+e+' <br/>'			 
	 }
  }) 
  
  $('.EC_edit[ecid="'+ID+'"] ')
  .attr('id','.ECTL'+ID)
  .html(dataString)
  .tooltip({
    track:true,
    create: function( event, ui ) {
      $(this).addClass('ECTL'+ID)	
    },
    open: function(){
      $('.ui-helper-hidden-accessible div:hidden').remove()
    }
	})
}
 
 



/*
  function createECForm( paramsObject )
*/
function createECForm( paramsObject ){
 
 
  // IF ONE DIALOG ALREADY IN THE DOM, DO NOT CREATE ANOTHER ONE
  if($('#entityCannonFrm').length > 0){
	////alert('not generating form')
	return false
  }
  
  var update = false;  
  var alreadyPushed = false;  
  if( paramsObject.ID != '' ){
        update = true
  }
  
  //console.log('paramsObject.ID !== "undefined": \r\n '+ paramsObject.ID != '' )  
  //console.log('JSON.stringify(paramsObject): \r\n'+JSON.stringify(paramsObject))
  
  console.log(entities)
  
  var entityName = paramsObject.entityName	 
    
  // EXTRACT ENTITY DATA FROM REGISTERED ENTITY OBJECT
  var entity = search(entityName, entities)
  
 var entity_states = ( typeof (entity) !== 'undefined' && typeof (entity) === 'object' )?entity.states:[]
  
  console.log("paramsObject")
  console.log(paramsObject)
  
    console.log("entity")
  console.log(entity)
  
  
  console.log(typeof paramsObject.drawOnCanvas != 'undefined')
  
  console.log("paramsObject VS entity_states")
  console.log(paramsObject.states+ ' \r\n '+entity_states)
    
	var 
	  iterations = paramsObject.iterations,
	  maxSimIterations = ( typeof paramsObject.maxSimIterations != 'undefined' )?paramsObject.maxSimIterations:1,
      next = paramsObject.next,
      start = paramsObject.start,
      drawOnCanvas = ( typeof paramsObject.drawOnCanvas != 'undefined' )?paramsObject.drawOnCanvas:entity.drawOnCanvas,
      x = ( typeof paramsObject.x != 'undefined' )?paramsObject.x:entity.x,// x default
      y = ( typeof paramsObject.y != 'undefined' )?paramsObject.y:entity.y,// y default
      dx = ( typeof paramsObject.dx != 'undefined' )?paramsObject.dx:entity.dx,
      dy = ( typeof paramsObject.dy != 'undefined' )?paramsObject.dy:entity.dy,
      path = ( typeof paramsObject.path != 'undefined' )?paramsObject.path:entity.path,
	  pathEnd = ( typeof paramsObject.path != 'undefined' )?paramsObject.pathEnd:entity.pathEnd,
	  states = ( typeof paramsObject.states != 'undefined' )?paramsObject.states:entity_states,
	  firstStateAt = ( typeof paramsObject.firstStateAt != 'undefined' )?paramsObject.firstStateAt:entity.firstStateAt,
	  energy = ( typeof paramsObject.energy != 'undefined' )?paramsObject.energy:entity.energy,
	  strength = ( typeof paramsObject.strength != 'undefined' )?paramsObject.strength:entity.strength,
	  resistance = ( typeof paramsObject.resistance != 'undefined' )?paramsObject.resistance:entity.resistance
	  
	  
	let tU = timeUnit
		
	if( document.querySelector('#gameTestFrmContainer') != null ){
		if( document.querySelector('#timeUnit_').innerHTML.length > 0 
			&& tIfrm.contentDocument.getElementById("livePointer") != null
		){
			tU = parseInt( document.querySelector('#timeUnit_').innerHTML )
			start = tU
		}
	}
	  
	  	  //console.log('createECForm \r\n: path:'+path+' \r\n: paramsObject.path:'+paramsObject.path+' \r\n: entity.path:'+entity.path)
  
  
  // CALCULATE AND APPLY marginLeft DIFFERENCE 
  //var diffX = document.querySelector('#stage_preview').offsetLeft // unused
  
  console.log('x:'+x)
  
  var entityCannonFields = ['entityName','start','iterations','maxSimIterations','next','drawOnCanvas','x','y','dx','dy','path','energy','strength','resistance','firstStateAt']//,'states','pathEnd'
  
  var form = $('<form/>')
         //.addClass('entityCannonFrm')         	 
         .attr('id','frmEntityCannon')
  
  var ul = $('<ul/>')
         .addClass('entityCannonFrm')         	 
         .attr('id','entityCannonFrm')
		
	
  $.each(entityCannonFields,function(i,e){
        
		var name = e,
			id = e;
		
		// UPDATE 'PATH' LABEL TO PREVENT CONFLIT FROM PATHS EDITOR'S #PATH
		if ( e == 'path' ){
			id = 'stage_path'
			name = 'stage_path_name'
			
		}
		else if ( e == 'pathEnd' ){			
			id = 'stage_pathEnd'
			name = 'stage_pathEnd_name'
		}
		else if ( e == 'firstStateAt' ){			
			id = 'stage_firstStateAt'
			name = 'firstStateAt'
		}
		
        // CREATE LABEL
        var label =
        $('<label/>')
        .attr('for',id)  
        .text(e)			
        		
        // CREATE INPUT
        var input =
        $('<input/>')
        .attr('type','text')
        .attr('id',id)  
        .attr('name',name)
		
		if( paramsObject.ID !='' ){
			input
			.addClass(paramsObject.ID)	
		}
		
		// drawOnCanvas label & <select/> are generated separately
		if( e != 'drawOnCanvas' ){
			
			// ADD LABEL & INPUT TO LIST ITEM
			var li = $('<li/>')
			.append(label)
			.append(input)	       
						  
			// ADD LIST-ITEM TO UNORDERED LIST
			ul
			.append(li)	
        }
		
        if( e == 'next' ){
          /*var frmSplit =
          $('<li/>')
          .addClass('frmSplit')
          
          ul
          .append(frmSplit)	*/
        }
		
		 if( e == 'drawOnCanvas' ){
			 
		  var li_stage_EC_drawOnCanvas =
			$('<li/>')
			.attr('id', 'li_stage_EC_drawOnCanvas')
		  
		  var label =
			$('<label/>')
			.attr('for', 'li_stage_EC_drawOnCanvas')
			.text('drawOnCanvas')
		  
		  li_stage_EC_drawOnCanvas
		  .append(label)		  
		  
          var frmSplit =
          $('<li/>')
		  .attr('data-title','movements & position')
          .addClass('frmSplit')
          
          ul
          .append(li_stage_EC_drawOnCanvas)	
          .append(frmSplit)	
        }
		
		
    
        switch( e ){					
          case 'entityName':
           ul.find('#entityName')
             .val(entityName)					      
          break;	
          case 'iterations':
			  var infiniteBtn = 
			   $('<a/>')
			  .html('&infin;')
			  .attr('href','#')
			  .attr('id','infiniteLoopBtn')

			   ul.find('label[for="iterations"]')
				 .append(infiniteBtn)

			   ul.find('#iterations')
				 .val(iterations)
				 .spinner() 
          break;
		  case 'maxSimIterations':
			  var infiniteBtn = 
			   $('<a/>')
			  .html('&infin;')
			  .attr('href','#')
			  .attr('id','infiniteIterationsLoopBtn')

			   ul.find('label[for="maxSimIterations"]')
				 .append(infiniteBtn)

			   ul.find('#maxSimIterations')
				 .val(maxSimIterations)
				 .spinner() 
          break;
          case 'next':
           ul.find('#next')
             .val(next)
             .spinner({
             spin:function(event,ui){
               decisecondsToseconds(ui,'next')                    
             },
             change:function(event,ui){
               console.log($(this).val())
               var ui = document.querySelector('#next')
               decisecondsToseconds(ui,'next')
             }
           })
            var seconds = $('<span/>')
            .addClass('seconds')
            ul.find('label[for="next"]')
            .append(seconds)
          break;
          case 'start':
          ul.find('#start')
            .val(start)
            .spinner({
            spin:function(event,ui){
              decisecondsToseconds(ui,'start')                    
            },
            change:function(event,ui){
              console.log($(this).val())
              var ui = document.querySelector('#start')
              decisecondsToseconds(ui,'start')
            }
          }) 
          var seconds = $('<span/>')
                        .addClass('seconds')

          ul.find('label[for="start"]')
            .append(seconds)
          break;
		  
		  case 'stage_pathEnd':
	     /* ul.find('#stage_pathEnd')            
			.val(pathEnd)*/
			console.log('case "stage_pathEnd" \r\npathEnd:'+pathEnd)
			//$('#stage_pathEnd').val(pathEnd)
          break;
          
          case 'stage_path':		  
			  form
			  .find('#stage_path')			 
			  .val(path)
			  $('#stage_path').val(path)			  
          break;               
            
          case 'x':
            var el = initField(ul,e,x)
			if ( paramsObject.ID !== 'undefined'){
				el
				.on( "spinchange", function( event, ui ) {					
					$('#'+paramsObject.ID)
					.css({
						left: el.val()+'px'
					})
				})
				.on( "spin", function( event, ui ) {					
					$('#'+paramsObject.ID)
					.css({
						left: ui.value+'px'
					})
				})
			}
          break;             
          case 'y':
            var el = initField(ul,e,y)
			if ( paramsObject.ID !== 'undefined'){
				el
				.on( "spinchange", function( event, ui ) {					
					$('#'+paramsObject.ID)
					.css({
						top: el.val()+'px'
					})
				})
				.on( "spin", function( event, ui ) {					
					$('#'+paramsObject.ID)
					.css({
						top: ui.value+'px'
					})
				})
			}
          break;   
          case 'dx':
            initField(ul,e,dx)
          break;
          case 'dy':
            initField(ul,e,dy)
          break; 
		  
		  case 'energy':
            initField(ul,e,energy)
          break;
		  case 'strength':
            initField(ul,e,strength)
          break;
		  case 'resistance':
            initField(ul,e,resistance)
          break;
		  
		  case 'firstStateAt':
            initField(ul,'stage_firstStateAt',firstStateAt)
			
			 ul.find('#stage_firstStateAt')
             .val(firstStateAt)
             .spinner({
             spin:function(event,ui){
               decisecondsToseconds(ui,'stage_firstStateAt')                    
             },
             change:function(event,ui){
               console.log($(this).val())
               var ui = document.querySelector('#stage_firstStateAt')
               decisecondsToseconds(ui,'stage_firstStateAt')
             }
           })
		   
            var seconds = $('<span/>')
            .addClass('seconds')
            ul.find('label[for="stage_firstStateAt"]')
            .append(seconds)
			
			
          break;
        }
		
		
  })
  
		
  
		// ADD THE LI THAT WILL CONTAIN THE openECStatesManagerLbl BTN
		// & ITS LABEL	

		ul
		.append(
			'<li id="liSM">'
			+'<label for="stages_ECstates">'
			+'states'
			+'</label>'
			+'<textarea id="stages_ECstates" name="stages_ECstates"></textarea>'
			+'</li>'
		)	
		
		ul
		.append(
			'<li>'
			+'<label id="openECStatesManagerLbl">'
			+''
			+'</label>'
			+'</li>'
		)		
		
			
		
		
		form.append(ul)
		
		
		
		// $('#stage_path').val(path)
		form
		  .find('#stage_path')			 
		  .val(path)
		
		//////alert(pathEnd)
		
var title = ( update == true )?'modify entity cannon':'new entity cannon'
    
  myButtons = {}
	
    if(update == false) {
		myButtons["OK - continue"] = function() {    
		var ID = ( paramsObject.ID !='' && alreadyPushed == false)?paramsObject.ID:'entity'+Date.now()	
		   
			if( $('#iterations').val() < 0){
				var iterations = parseInt($('#iterations').val(),10)			
			}else if( $('#iterations').val() >= 0 ){
				var iterations = parseInt($('#iterations').val())			
			}
			
			if( $('#maxSimIterations').val() < 0){
				var maxSimIterations = parseInt($('#maxSimIterations').val(),10)			
			}else if( $('#iterations').val() >= 0 ){
				var maxSimIterations = parseInt($('#maxSimIterations').val())			
			}
			  // EXTRACT ENTITY DATA FROM REGISTERED ENTITY OBJECT
			 //var entity = search(entityName, entities)
				//x -= diffX

			var pathEnd	= $('[name=stage_pathEnd] option').filter(function() { 
				return ($(this).prop('selected') == true); //To select Blue
			}).text()
			
			var states = []			
			// != []
			if( $('#stages_ECstates').val().length > 2 ){		
				states = JSON.parse($('#stages_ECstates').val())
				//alert('states: \r\n'+JSON.stringify(states))
			}
			
			//alert(parseInt($('#start').val()) + parseInt($('#next').val()))
			
			 var entityCannon = {
				ID: ID,  
				entityName: entityName,
				iterations: iterations,
				maxSimIterations: maxSimIterations,
				drawOnCanvas:$('#stage_EC_drawOnCanvas').val(),
				next: parseInt($('#next').val()),
				start: parseInt($('#start').val()),
				archiveIterations: iterations,
				archiveStart: parseInt($('#start').val()),
				x: parseInt($('#x').val()),
				y: parseInt($('#y').val()),
				dx: parseInt($('#dx').val()),
				dy: parseInt($('#dy').val()),				
				path: $('#stage_path').val(),
				pathEnd: pathEnd,
				states: states,
				firstStateAt: parseInt($('#stage_firstStateAt').val()),
				energy: parseInt($('#energy').val()),
				strength: parseInt($('#strength').val()),
				resistance: parseInt($('#resistance').val())
			 }
					  
			 if( update == true && alreadyPushed == false){
			   // REMOVE EC WHICH ID == ID FROM entities BEFORE RECREATING IT          
			   var objIdx = searchEcInEntities( ID );// [EC,idx]
			   console.log('objIdx:'+objIdx)
			   entityCannons.splice(objIdx[1],1)
			 }
		     
			 //////alert($('#stage_pathEnd').val()+' '+entityCannon.pathEnd+' '+entityCannon.path)		
			 
			 // ADD EC TO entityCannons[]
			 entityCannons.push(entityCannon)  
					 
			 // ADD EC TO STAGE
			 representEntityOnStage(entityCannon)
			 
			 console.log(entityCannons)
			 alreadyPushed = true
			 
		   resetTimeLine()
		  
		 startMax = 0
		 startMaxUpdate()  
		   /*
			 // IF EC UI is visible, refresh it
			  if ( $('#stage_timeline_container').is(':visible') ){  */
				 //ec_manager_ui ()
				 ec_manager_ui2()
			/*  }*/
			$('#frmEntityCannon').remove()
			$('#stages_paths_selector').remove() 

			// ERASE & CREATE TOOLTIPS
			$('ui-tooltip').remove()
			$.each(entityCannons,function(i,e){		  
				makeECPreviewToolTip(e.ID)
			})
			
			//rotateEC()
 			
			toggleDisplayStageEmptyFrames()
			
		}// function		
		
	  } 
    
		myButtons["OK - close"] = function() {    
		var ID = ( paramsObject.ID !='' && alreadyPushed == false)?paramsObject.ID:'entity'+Date.now()
		 	
			var states = []			
			// != []
			if( $('#stages_ECstates').val().length > 2 ){		
				states = JSON.parse($('#stages_ECstates').val())
				//alert('states: \r\n'+JSON.stringify(states))
			}
						
			if( $('#iterations').val() < 0){
				var iterations = parseInt($('#iterations').val(),10)			
			}else if( $('#iterations').val() >= 0 ){
				var iterations = parseInt($('#iterations').val())			
			}
			
			if( $('#maxSimIterations').val() < 0){
				var maxSimIterations = parseInt($('#maxSimIterations').val(),10)			
			}else if( $('#maxSimIterations').val() >= 0 ){
				var maxSimIterations = parseInt($('#maxSimIterations').val())			
			}
			
			var pathEnd	= $('[name=stage_pathEnd] option').filter(function() { 
				return ($(this).prop('selected') == true); //To select Blue
			}).text()
			
			  // EXTRACT ENTITY DATA FROM REGISTERED ENTITY OBJECT
			 //var entity = search(entityName, entities)
				//x -= diffX

			/* 
				ADJUST x and y coordinates/attributes FOR THE ENTITY ON THE STAGE
				IF LIVE EDITOR -- begin
			*/
				//var diffX = document.querySelector('#stage_preview').offsetLeft
				//var diffY = document.querySelector('#stage_preview').offsetTop
				
				/*
					GET POSITION (left, top) OF #combo (one of the divs from APP)
					RELATIVE TO ITS PARENT DOCUMENT BODY
					THAT IS IN THE IFRAME #gameTestFrm
				*/
				
				window.tIfrm = document.getElementById('gameTestFrm')
				
				let comboDiv,
					diffX,
					diffY
				
				if( window.tIfrm != null ){
					comboDiv = tIfrm.contentDocument.querySelector('#combo')
					diffX = parseInt(comboDiv.style.left)
					diffY = parseInt(comboDiv.style.top)				
					
					let elem = $('#gameTestFrmContainer #gameTestFrm');
					console.log('#gameTestFrm - IFRAME:')
					console.log(elem.position().left.toFixed(0)+' / '+elem.position().top.toFixed(0) )
					
					/*
						SUBTRACT THE IFRAME POSITION LEFT
					*/
					diffX -= parseInt(elem.position().left)
					diffY -= parseInt(elem.position().top)	
				}
				/* 
					ADJUST x and y coordinates/attributes FOR THE ENTITY ON THE STAGE
					IF LIVE EDITOR -- end
				*/
			
				
			 var entityCannon = {
				ID: ID,  
				entityName: entityName,
				iterations: iterations,
				maxSimIterations: maxSimIterations,
				drawOnCanvas: $('#stage_EC_drawOnCanvas').val(),
				next: parseInt($('#next').val()),
				start: parseInt($('#start').val()),
				archiveIterations: iterations,
				archiveStart: parseInt($('#start').val()),
				x: parseInt($('#x').val()),
				y: parseInt($('#y').val()),
				dx: parseInt($('#dx').val()),
				dy: parseInt($('#dy').val()),
				path: $('#stage_path').val(),
				pathEnd: pathEnd,
				states: states,
				firstStateAt:  parseInt($('#stage_firstStateAt').val()),
				energy: parseInt($('#energy').val()),
				strength: parseInt($('#strength').val()),
				resistance: parseInt($('#resistance').val())
			 }
			 
			 if( tIfrm != null ){
				 entityCannon.x += parseInt(diffX)
				 entityCannon.y += parseInt(diffY)
			 }
			 
			 //alert('entityCannon.states: \r\n'+JSON.stringify(entityCannon.states))
			 
			 if( update == true && alreadyPushed == false){
			   // REMOVE EC WHICH ID == ID FROM entities BEFORE RECREATING IT          
			   var objIdx = searchEcInEntities( ID );// [EC,idx]
			   console.log('objIdx:'+objIdx)
			   entityCannons.splice(objIdx[1],1)
			 }
		   
			 // ADD EC TO entityCannons[]
			 entityCannons.push(entityCannon)  
			 
			 // ADD EC TO STAGE
			 representEntityOnStage(entityCannon)
			 
			 console.log(entityCannons)
			 alreadyPushed = true
		   ECResetStart() 
		   resetTimeLine()
		  
		 startMax = 0
		 startMaxUpdate()  
		   
			 // IF EC UI is visible, refresh it
			  //if ( $('#stage_timeline_container').is(':visible') ){  
				 //ec_manager_ui ()
				 ec_manager_ui2()
			  //}
         
		  // ERASE & CREATE TOOLTIPS
		  $('ui-tooltip').remove()
		  $.each(entityCannons,function(i,e){
            //////alert(e.ID)

				makeECPreviewToolTip(e.ID)
		  }) 
		  
		 // CLOSE THIS FORM
			$('.entityCannonFrm')
			.dialog('close')
			
			/*
				IF LIVE TEST IFRAME IS OPENED THEN 
					- SPAWN THE NEWLY ADDED ENTITY ONTO ITS LIVE STAGE
					- RESUME APP MAIN LOOP
			*/
			if( document.querySelector('#gameTestFrmContainer') != null ){
				
				
				/*
					
					COORDINATES COULD BE ADJUSTED....
					
				entityCannon.x -= parseInt(diffX)   
				entityCannon.y -= parseInt(diffY) 
				
				*/
				
								
				let entityCannon_stage = {...entityCannon}
				
				entityCannon_stage.x -= parseInt(diffX)
				entityCannon_stage.y -= parseInt(diffY)
 				
				tIfrm.contentWindow.spawnEntityFromJson( entityCannon_stage.entityName, entityCannon_stage )
				
				if( tIfrm.contentWindow.paused == true ){
					$('.testIframeStagePause')
					.button('option','icon','ui-icon-pause')			
					if( tIfrm.contentDocument.getElementById("liveEditor") != null ){				
						tIfrm.contentDocument.getElementById("liveEditor").remove()
						tIfrm.contentDocument.getElementById("livePointer").remove()
					}			
					tIfrm.contentWindow.mouseEventsInit()
					tIfrm.contentWindow.resume()			
				}
			}
			
			
			$('#frmEntityCannon').remove()
			
			$('#stages_paths_selector').remove()
			
			//rotateEC()
			toggleDisplayStageEmptyFrames()
		 }  
  
		  myButtons["Cancel"] = function(){ 
       // CLOSE THIS FORM
			 $('.entityCannonFrm')
			 .dialog('close')
			  $('#stages_paths_selector').remove()  
			 $('#frmEntityCannon').remove() 
			 
			 //rotateEC()
			 toggleDisplayStageEmptyFrames()
		 }    
  
	ul
	.appendTo("#stages_editor")
	.dialog(
		{
		 title: title,
		 width: 600,
		 height: 550,
		 modal: false,
		 buttons: myButtons,
		 close: function (){
			 
			setTimeout(rotateEC,100)
			 
			$(this)
			.dialog('destroy')
			.remove()
			
			toggleDisplayStageEmptyFrames()
			//alert('update EC rotations')
		 },		 
		 create: function(){
		 
		  // ADD noPath BUTTON
		   var noPathBtn = $('<a/>')
			.attr('id','ECnoPathBtn')
			.text('no')
			
			noPathBtn
			.appendTo('label[for="stage_path"]')  
		 
		    // ADD pathEnd CONTROL + SET ITS DEFAULT VALUE
			var paramsObject2 = 
			{
				selectId: 'stage_pathEnd', 
				newSelectId: 'stage_pathEnd', 
				selectName: 'stage_pathEnd'
			}
			generate_entityPathEndSelect(paramsObject2) 	
			// set default value
			$('option[value="'+pathEnd+'"]').prop("selected", true); 			
			
			var path = $('#stage_path').val()
			// IF path != -1, add the path thumbnail into label[for='path']
			  if ( path != -1 ){
				var path_thumb_src = './'+destination_dir.paths+'/'+path+'.png'
				var path_thumb = new Image()
				path_thumb.onload = function(){
				    //document.querySelector('label[for="stage_path"] img')
					
					path_thumb.classList.add('path_thumb')
					
					console.log(path_thumb)
					$('label[for="stage_path"]')
					.append(path_thumb)
				}
				path_thumb.src = path_thumb_src
			  } 	


			/*
			  GENERATE EC CANVASES DROPDOWN
			*/
			 var paramsObject =
					{
					  id: 'stage_EC_drawOnCanvas', // element id attribute
					  name: 'drawOnCanvas', // element name attribute
					  selectedValue: drawOnCanvas, // option selected by default          
					  target: $('#li_stage_EC_drawOnCanvas'),// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
					  injectMethod:'appendTo',// appendTo | insertAfter | replaceWith,
					  lbl: 'drawOnCanvas' // element's label text         
					}

			generateDropDown( paramsObject )
			/*
			var ul = $('#entityCannonFrm ul')
			
			// ADD THE LI THAT WILL CONTAIN THE openECStatesManagerLbl BTN
			// & ITS LABEL		
				
			ul
			.append(
				'<li>'
				+'<label for="stages_ECstates">'
				+''
				+'</label>'
				+'<textarea id="stages_ECstates" name="stages_ECstates"></textarea>'
				+'</li>'
			)
			ul
			.append(
				'<li>'
				+'<label id="openECStatesManagerLbl">'
				+'states'
				+'</label>'
				+'</li>'
			)	
			*/
			// CREATE STATE MANAGER AND BTN TO OPEN IT
		    var paramsObject = 
			{
				statesOwnerId: $('#entityName').val(),// THE name ATTRIBUTE OF ENTITY/EC/BW THIS STATES COLLECTION BELONGS TO, ex: flower2.ent
				statesDefaultModel: $('#entityName').val(),// states[]WILL BE POPULATED WITH THE states[] FROM statesDefaultModel
				target: $('#openECStatesManagerLbl'),// JQUERY OBJECT TO USE AS A REFERENCE TO INJECT THE STATES MANAGER BTN 
				injectMethod: 'insertAfter', //HOW TO INJECT THE BTN, i.e.: 'append | insertBefore | insertAfter | replaceWith
				statesManagerId: 'stages_editor_ECstatesManager' //ID OF THE INSTANCE OF THE MANAGER DIALOG
			}
			generateStatesManager( paramsObject )	
			
			// POPULATE STATES TEAXTAREA						
			$('#stages_ECstates').val(JSON.stringify(states))
			
			// MAKE SURE STATE-RELATED FIELDS ARE LAST IN THE FORM
			$('#liPathEnd').insertBefore('#liSM')
			
			$('<li/>')
			.attr('data-title','states')
			.addClass('frmSplit')
			.insertBefore('#liSM')
			
			
			setTimeout(rotateEC,100)
		}// create
	})// dialog  
    
}

function makeECPreviewToolTip(ID){

$('.'+ID).remove()

	// GENERATE TOOL TIP -- '#stage_preview' 
$(document).tooltip({
	track: true,
	create: function( event, ui ) {
		$(this).addClass(ID)	
	},
	open: function(){
		$('.ui-helper-hidden-accessible div:hidden').remove()
	},
	items: '.edit_ec .info',  
	content: function() {
	var ID = $( this ).parent().attr('ID');        
	var ECobject = searchEcInEntities(ID)
	var dataString = ''			

	$.each(ECobject[0],function(i,e){
		console.log(i+' '+e) 
	   if( i === 'states' ){
		 dataString += i+' x '+e.length+' <br/>'			 
	   }else{
		 dataString += i+' : '+e+' <br/>'			 
	   }
	   
	})       
		return dataString
	  }
	})
}


/*
   EXPRESS deciseconds TO seconds
   FOR MORE CLARITY 
   USED BY #next, and #start
*/
window.decisecondsToseconds = function( ui, fromId ){                           
  var seconds =  ui.value/10
  console.log('ui.value/10:'+ui.value/10+' '+seconds)
  seconds += '&nbsp;sec'
  $('label[for="'+fromId+'"] span.seconds')
  .html(seconds)          
}

function initField(ul,e,value){
 return ul.find('#'+e)
    .val(value)
    .spinner()
}


function representEntityOnStage( ec ){     
    console.log(JSON.stringify(ec))
  
	  $('#'+ec.ID)
	  .remove()
  
	var stage_preview = $('#stage_preview')	
    
    var deleteControl =
    $('<a/>')
    .addClass('delete_ec')
    .attr('href',ec.ID)    
    .html('&times;')
    
	var info =
	$('<span/>')
	.addClass('info')
	/*
	 var stateManagerControl =
		$('<a/>')
		.addClass('edit_ec_states')
		.attr('href',ec.ID)    
		.html('states')
	*/
	
    var imgSrc = destination_dir.entities+'/'+ec.entityName+'.png'
     console.log(imgSrc)    
    var img = new Image()    
    
	var canvas = search(ec.drawOnCanvas, canvases)// get drawOnCanvas's index
	
	var canvasZindex = 
	( typeof canvas !== 'undefined' && canvas.zIndex != null )?canvas.zIndex:canvases[0].zIndex
	
    img.onload = function(){
      var entity = 
      $('<div/>')
      .attr('id',ec.ID)
      .addClass('edit_ec')
      .css({
        position: 'absolute',
		zIndex: canvasZindex,
        top: ec.y+'px',
        left: ec.x+'px'
      })
      .append(img)
	  .append(info)
      .append(deleteControl)
      /*.append(stateManagerControl)*/
      .appendTo( stage_preview )
      .draggable({
        drag: function( event, ui ) {			
		  var diffX = document.querySelector('#stage_preview').offsetLeft		
          // UPDATE COORDINATES ON DRAG
		  //		  -diffX
          ec.x = parseInt(ui.position.left)
          ec.y = parseInt(ui.position.top)         
          console.log(ec)		  
		  $('#x.'+ec.ID).val(ec.x)
		  $('#y.'+ec.ID).val(ec.y)		  
        }
      })

		/*if( i == entityCannons.length ){
		alert('rotate them all')					
		rotateEC()// rotate entityCannons that are rotatable 
		}*/	
	  
    }
    img.src = imgSrc  
}

$(document)
.delegate('.selectStageFrame .ec_count','mouseup',function(e){
   e.preventDefault()    
  startMax = 0
  startMaxUpdate()  
  //resetTimeLine()  
  timeUnit = parseInt($(this).text())//stageNthFrame  
  $('#stageNthFrameC').val(stageNthFrame)
  $('#timeUnitC').val(timeUnit)  
  triggerEntityCannons({
    found: entityCannons
  })
})

function stage_ec_manager_refresher(){
	 startMax = 0
	 startMaxUpdate()
	 //ec_manager_ui()
	 ec_manager_ui2()
	 toggleDisplayStageEmptyFrames()
}


function insertAfter(newNode, referenceNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}

function createEcManagerDeleteBtns(){
	
	document.querySelectorAll('.EC_btns .delete_ec').forEach(function(e,i){e.remove()})
		
	document.querySelectorAll('.EC_btns .EC_edit')
	.forEach(function(e,i){
		console.log(i+' '+e.getAttribute('ecid'))
		
		if($('.EC_btns a.EC_edit[ecid="'+e.getAttribute('ecid')+'"]').is(':visible')){
		
			let newA = document.createElement('a')
				newA.setAttribute('href',e.getAttribute('ecid'))
				newA.classList = 'delete_ec'
				//newA.innerHTML = 'X'
				let ref = document.querySelector('[ecid="'+e.getAttribute('ecid')+'"]');
				insertAfter(newA,ref) 
		}			
	})
}

$(document)
.delegate('#stage_ec_manager_refresh','click',function(e) {
  e.preventDefault()  
  stage_ec_manager_refresher()
  
})

$(document)
.delegate('#stageEntityBtn','click',function(e) {
  e.preventDefault()  
  loader()
  var paramsObject = {
		selectorId: 'stages_entities_list_container',
		target: $(this).parent(),
		injectMethod: 'appendTo',
		contentPath: './entities_editor/ #entities_list_container .entities_list',
		title: 'select an entity for the stage',
		searchFormId : 'stageFilterEntities'	
	}
	
	generateAssetSelector( paramsObject, load_entities )	
  
})



/*
$(document)
.delegate('#stage_ec_manager_open','click',function(e) {
  e.preventDefault()  
   startMax = 0
   startMaxUpdate()
  ec_manager_ui()
  $('#stage_ec_manager_container').show()
})*/
/*
$(document)
.delegate('#stage_ec_manager_close','click',function(e) {
  e.preventDefault()
  $('#stage_ec_manager_container').hide()
})
*/
// ADD AN ENTITY CANNON TO COLLECTION entityCannons[]
$(document)
  .delegate('#stages_entities_list_container .entities_list li .select_entity','click',function(e) {
    e.preventDefault();
	
    var entityName = $(this).find('.entityLbl').text()
    /*
       GET THE ENTITY OBJECT 
       WHICH NAME IS entityName
       TO GET ITS ATTRIBUTES
       dx, dy, path
    */	
    var entityObject = search(entityName, entities)
	
    var entityCannon = {
        ID: '',
        entityName: $(this).find('.entityLbl').text(),
        iterations: 1,
        next: 0,
        start: timeUnit //stageNthFrame,
      }
	  
	  $('#stages_entities_list_container').dialog('close')	  
	  
      // GENERATE ENTITY CANNON FORM
    createECForm(entityCannon)	
	
	toggleDisplayStageEmptyFrames()	
})

/* 
	ADD AN ENTITY CANNON TO COLLECTION entityCannons[]
	FROM THE STAGE LIVE EDITOR
*/

$(document)
  .delegate('#stages_entities_list_container_live .entities_list li .select_entity','click',function(e) {
    e.preventDefault();	
	
    var entityName = $(this).find('.entityLbl').text()		
    /*
       GET THE ENTITY OBJECT 
       WHICH NAME IS entityName
       TO GET ITS ATTRIBUTES
       dx, dy, path
    */
    var entityObject = search(entityName, entities)
	
    var entityCannon = {
        ID: '',
        entityName: entityName,
        iterations: 1,
        next: 0,
        start: timeUnit //stageNthFrame,
      }
	  /*
	  entityCannon.x = window.liveEditorX
	  entityCannon.y = window.liveEditorY
	  */
	  
	  
	  
	  entityCannon.x = window.liveEditorX
	  entityCannon.y = window.liveEditorY
	  
	  $('#stages_entities_list_container').dialog('close')
	  $('#stages_entities_list_container_live').dialog('close')	  
      // GENERATE ENTITY CANNON FORM
	  
	  //console.clear()
	  console.log('NEW entityCannon')
	  console.log(entityCannon)
	  
    createECForm(entityCannon)
	
	toggleDisplayStageEmptyFrames()	
})

// DELETE AN ENTITY CANNON FROM COLLECTION entityCannons[]
$(document)
  .delegate('.delete_ec','click',function(e){
  e.preventDefault();
  
  var ID = $(this).attr('href')  
  var objIdx = searchEcInEntities( ID );// [EC,idx]  
  entityCannons.splice(objIdx[1],1)
  $('#'+ID).remove()// remove avatar from stage
  
  // IF ONE DIALOG ALREADY IN THE DOM, DELETE IT
  if($('#entityCannonFrm').length > 0){
	$('#entityCannonFrm').remove()
  }
  
  // GENERATE ENTITY CANNON FORM
  // createECForm( entityCannon )
  /*
  // UPDATE startMax TO MAKE SURE WE DON'T SEE USELESS FRAMES
  startMax = 0
  startMaxUpdate() 
  */
  resetTimeLine()
  ECResetStart()
  // IF EC UI is visible, refresh it
 /* if ( $('#stage_timeline_container').is(':visible') ){  
	   //ec_manager_ui ()
	   ec_manager_ui2()
  }*/
  	   ec_manager_ui2()
  
})

// MODIFY AN ENTITY CANNON FROM COLLECTION entityCannons[]
$(document)
  .delegate('.edit_ec','click',  function(e) {
    e.preventDefault();
	ECResetStart()
    var ID = $(this).attr('id')
    var objIdx = searchEcInEntities(ID); // [EC,idx]  
    var entityCannon = objIdx[0]
    console.clear()
    console.log(entityCannon)
      // GENERATE ENTITY CANNON FORM
    createECForm(entityCannon)
  
})

// 
$(document)
.delegate('#closeStagePathSelector','click',function(e) {
  e.preventDefault()
  $('#stages_paths_selector').remove()          
})

// STAGES EDITOR PATH SELECT
$(document)
.delegate('#stage_path','click',function(e) {
  e.preventDefault() 
loader()  
  var paramsObject = {
		selectorId: 'stages_paths_selector',
		target: $('#stages_editor'),
		injectMethod: 'appendTo',
		contentPath: './paths_editor/ #paths_list_container .paths_list',
		title: 'select a path for the entity',
		searchFormId : 'stageFilterPaths'
	}
	generateAssetSelector( paramsObject )	
})

$(document)
  .delegate('#stages_paths_selector .paths_list .select_path','click',function(e) {
  e.preventDefault()
  var img = $(this).children('img')
  var imgTitle = img.attr('title')  
  $('#stage_path').val(imgTitle)
  $('label[for="stage_path"] .path_thumb').remove()  
  img	
    .addClass('path_thumb')
    .appendTo('label[for="stage_path"]')
  $('#stages_paths_selector').remove()  
})

$(document)
.delegate('#ECnoPathBtn','click',function(e){
	e.preventDefault()
   $('#stage_path').val(-1)  
   $('label[for="stage_path"] .path_thumb').remove() 
   $('#stages_paths_selector').remove()  
})

/*
    INFINITE LOOP BUTTON
*/ 
$(document)
  .delegate('#infiniteLoopBtn','click',function(e){
  e.preventDefault();  
  $('#iterations').val(-1)
})

/*
    INFINITE LOOP BUTTON
*/ 
$(document)
  .delegate('#infiniteIterationsLoopBtn','click',function(e){
  e.preventDefault();  
  $('#maxSimIterations').val(-1)
})


// POSITIONS AND MOVEMENTS
	// SELECT A PATH FOR THE ENTITY FROM ENTITY EDITOR
	$(document)
	.delegate('#stage_BW_path','click',function(e){
	  e.preventDefault()
	  loader()
		var paramsObject = {
			selectorId: 'stage_BW_path_selector',
			target: $('#stage_BW_path'),
		  injectMethod: 'insertAfter',
			contentPath: './paths_editor/ #paths_list_container .paths_list',
			title: 'select a path for the brickwall',
			searchFormId : 'stageFilterBrickwallsPaths'		
		}
		generateAssetSelector( paramsObject )
	})
    /*
	$(document)
	.delegate('#BWCloseEntityPathSelector','click',function(e){
	  e.preventDefault()
	  $('#stage_BW_path_selector').remove()
	})
	*/
	// STAGES EDITOR: SELECT PATH FOR BRICKWALL
	$(document)
	.delegate('#stage_BW_path_selector .paths_list .select_path','click',function(e){
	  e.preventDefault()
	  $('label[for="stage_BW_path"] .path_thumb').remove()	  
	  var img = $(this).children('img')
	  $('#stage_BW_path').val(img.attr('title'))
	  $('#stage_BW_pathMode').val($(this).find('.jsonObjectPathMode').text())
	  img
	  .addClass('path_thumb')
	  .appendTo('label[for="stage_BW_path"]')
	  $('#stage_BW_path_selector').remove()
	})
	
	
function generate_stagePathEndSelect(){
	
	    var selectId = 'stage_BW_pathEnd',
			newSelectId = 'stage_BW_pathEnd',
			selectName = 'stage_BW_pathEnd'
	
		var select_options = {
		  loop:'loop',
		  reverseLoop:'reverseLoop',
		  stop:'stop'		   
		}
    
		var options_str = '';
		$.each(select_options, function(i,e){
		  options_str += '<option id="'+i+'" value="'+e+'">'
		  options_str +=  e
		  options_str += '</option>'		  
		})
		
			var lbl = 
			$('<li><label for="'+newSelectId+'">pathEnd</label></li>')						
			.appendTo('#entityCannonFrm')
			
			var select = 
				$('<select/>')
				.attr('id',newSelectId)
				.attr('name',selectName)				
				.html(options_str)
				
			$('#stage_BW_pathEnd').replaceWith(select)
		
	}

/*
	SELECT A BRICKWALL FOR THE STAGE FROM STAGES EDITOR -- begin
*/

	$(document)
	.delegate('#stage_brickwall_name','click',function(e){
	  e.preventDefault()
	  loader()
		var paramsObject = {
			selectorId: 'stage_brickwall_name_selector',
			target: $('#stage_brickwall_name'),
			injectMethod: 'insertAfter',
			contentPath: './brickwalls_editor/ #BW_brickwalls_list_container .brickwalls_list',
			title: 'select a brickwall for the stage',
			searchFormId : 'stageFilterBrickwalls'			
		}
		generateAssetSelector( paramsObject )
	})
  
  
  // STAGES EDITOR : CLOSE BRICKWALL SELECTOR
  $(document)
	.delegate('#BWCloseBWSelector','click',function(e){
	  e.preventDefault()
	  $('#stage_brickwall_name_selector').remove()
	})
 /*
 // LOAD BRICKWALL INTO STAGE EDITOR STAGE PREVIEW 
 $(document).delegate('#stage_brickwall_name_selector .brickwalls_list a.select_brickwall', 'click', function(e) {
   e.preventDefault()	
   load_brickwall($(this).attr('href'))	
   $('#stage_brickwall_name_selector').remove()			
 })
*/


$(document).delegate('#stage_brickwall_name_selector .brickwalls_list a.select_brickwall', 'click', function(e) {
 e.preventDefault()
	// LOAD BRICKWALL TO STAGE PREVIEW AND RESET OTHER RELATED PARAMS
	/*
		 #stage_brickwall_name, #stage_BW_x,#stage_BW_y,
		 #stage_BW_dx,#stage_BW_dy,#stage_BW_pathIdx	
	*/
	loadBrickwallToStage( $(this).attr('href'), true)
	
})

/*
		function loadBrickwallToStage()
		
		DOES:
			load a brickwall into #stage_preview
		
		PARAMS:
			changeOtherBWParams -- populate or reset 
								   #stage_brickwall_name, #stage_BW_x,#stage_BW_y,
								   #stage_BW_dx,#stage_BW_dy,#stage_BW_pathIdx	
	*/
 
	function loadBrickwallToStage( BWJsonURL ){
		loader()
		
		var changeOtherBWParams = true
		
		if( arguments.length == 2 ){			
			changeOtherBWParams = arguments[1]	
		} 
		
		// LOAD PATH into paths editor FROM THE .json file
		var brickwallFileUrl = BWJsonURL 
        $.getJSON(brickwallFileUrl)
		.done(function(json){          
		
			$('#BW_avatar').remove()
			
			if( changeOtherBWParams === true ){				
				$('#stage_brickwall_name').val(json.brickwall_name)
				$('#stage_BW_x,#stage_BW_y,#stage_BW_dx,#stage_BW_dy,#stage_BW_pathIdx')
				.val(0)
				$('#stage_BW_pathMode')
				.val('')
				$('#stage_BW_pathStep')
				.val(1)
			}
			// GET THE THUMBNAIL SOURCE
			var imgSrc =destination_dir.brickwalls
						+'/'
						+json.brickwall_name+'.png' 
						
			let tmpImg = new Image();                  
				tmpImg.onload = function() {								
				   $('<div/>')
				   .attr('id','BW_avatar')
				   .append(tmpImg)   
				   .draggable({
						drag:function(event,ui){								
							console.log(ui.position.left)
							$('#stage_BW_x').val(ui.position.left)
							$('#stage_BW_y').val(ui.position.top)
						}
					})
					.appendTo('#stage_preview')
					
					var drawOnCanvas = $('#stage_BW_drawOnCanvas').val()					
					var canvas = search(drawOnCanvas, canvases)// get drawOnCanvas's index
					
					$('#BW_avatar')					   
				   .css({
						/*position: 'absolute',*/
						top: $('#stage_BW_y').val()+'px',
						left: $('#stage_BW_x').val()+'px',
						zIndex: canvas.zIndex,
						width:tmpImg.width,
						height:tmpImg.height
					})	
				}
			tmpImg.src = imgSrc+'?t='+Date.now() ;
			loaderOff()
        })   
		$('#stage_brickwall_name_selector').remove()
	}// end function loadBrickwallToStage()


/*
	SELECT A BRICKWALL FOR THE STAGE FROM STAGES EDITOR -- end
*/

/*
	STAGES EDITOR: brickwall no path btn on click
*/
$(document)
.delegate('#BWnoPathBtn','click',function(e){
    e.preventDefault()
   $('label[for="stage_BW_path"] .path_thumb')
   .remove()
  $('#stage_BW_path').val(-1)
})

/*
	STAGES EDITOR: brickwall no brickwall btn on click
*/
$(document)
.delegate('#BWnoBrickwallBtn','click',function(e){
    e.preventDefault()
   $('#BW_avatar')   
   .remove()
   
  $('#stage_brickwall_name').val(null)
})


/*
	CLICK ON BW_AVATAR, SELECT BRICKWALL TAB
*/
$(document)
.delegate('#BW_avatar','mouseup',function(){
  $('#stg-ed-tabs')
  .tabs("option", "active",2)
  .tabs('refresh')
})

/*
	STAGES EDITOR
	
	function ECCompensateAdjustCoords()
	
	DOES:
			- adjust Entity Cannons coordinates before save, then restore it to its initial value	
	PARAMS:
	
			'add' | unset 	
			Left += OffsetX
			Top += OffsetY
	
			'subtract'	
			Left -= OffsetX
			Top -= OffsetY
*/

window.ECCompensateAdjustCoords = function(){      
  // SUBTRACT BY DEFAULT
  var operation = 'subtract'
  if( arguments.length > 0 ) {
		  operation = arguments[0]
  }
    
  var diffX = document.querySelector('#stage_preview').offsetLeft
  var diffY = document.querySelector('#stage_preview').offsetTop 
  
   $.each( entityCannons ,function(i,e){ 
	if ( operation == 'subtract' ){
	  entityCannons[i].x = parseInt( e.x - diffX)   
	  entityCannons[i].y = parseInt( e.y - diffY)   
	}else if ( operation == 'add' ){
	  entityCannons[i].x = parseInt( e.x + diffX)   
	  entityCannons[i].y = parseInt( e.y + diffY)   
	}
		
	console.log( 'e.x:'+e.x+' entityCannons[i].x: '+ entityCannons[i].x)
	console.log( 'e.y:'+e.y+' entityCannons[i].y: '+ entityCannons[i].y)
		
	if( i ==  entityCannons.length){
		Defer.resolve()
		return true
	}
  })
}

/*
	STAGES EDITOR
	spawnBalls -- begin
*/


// INIT ADD spawnBall SELECTOR
$(document)
.delegate('.addSpawnBall','mouseup',function(e){
  e.preventDefault()
  var paramsObject = {
    selectorId: 'stage_spawnBalls_selector',
    target: $('#spawnBallsContainer'),
      injectMethod: 'appendTo',
      contentPath: './entities_editor/ #entities_list_container .entities_list',
	  searchFormId: "stageFilterEntitiesSpawnBalls"
    }
  generateAssetSelector( paramsObject )
})

// ADD A SPAWNBALL TO FORM
$(document)
.delegate('#stage_spawnBalls_selector .entities_list li .select_entity','click',function(e){
    e.preventDefault();
    var img = $(this).find('img')
    var src = img.attr('src')
    var title = img.attr('title')
    $('#spawnBallsList img[title="'+title+'"')            
    .parent() 
	.remove()
  
    $('<li><img title="'+title+'" src="'+src+'" class="'+title+'" />'+title+'<a href="#" class="removeSpawnBallBtn">&times;</a></li>')
    .appendTo('#spawnBallsList')
  	updateSpawnBalls()
     $('#stage_spawnBalls_selector')
     .undelegate('.select_entity', "click")    
	   .dialog('destroy').remove()
     $(document).dialogfullmode();// RE-INIT FULLSCREEN BTN  
})

// DELETE A spawnBall FROM FORM
$(document)
.delegate('.removeSpawnBallBtn','mouseup',function(e){
  e.preventDefault()
 $(this).parent().remove()
  updateSpawnBalls()
})

function updateSpawnBalls(){
  var spawnBalls = [] 
  $.each( $('#spawnBallsList li'), function(i,e){		
    console.log("$(this).attr('title'): "+$(this).find('img').attr('title'))
  	spawnBalls.push($(this).find('img').attr('title'))
  })  
  $('#spawnBalls')
  .val(JSON.stringify(spawnBalls))
}

function populateSpawnBallsFromTextarea(){
	
	console.clear()
	console.log($('#spawnBalls').val())
	
	var spawnBalls = JSON.parse($('#spawnBalls').val())
  $.each(spawnBalls,function(i,e){
   console.log(i+' '+e+' '+$(this))
   var src = destination_dir.entities+'/'+e+'.png' 
   var title = e  
		$('<li><img title="'+title+'" src="'+src+'" class="'+title+'" />'+title+'<a href="#" class="removeSpawnBallBtn">&times;</a></li>')
    .appendTo('#spawnBallsList')
	})
}

/*
	STAGES EDITOR
	spawnBalls -- end
*/


// EXPORT A STAGE TO A JSON FILE
	$(document).delegate('form#stg_ed_frm', 'submit', function(event) {
	  event.preventDefault();
	loader()
	  /*
		GENERATE A THUMBNAIL OF THE STAGE
		.game_assets/stages/stageName.png
		will be used by:
			stages editor
			campaign editor					
	  */
	  /*
	  if($('#entity_states').val()==''){
		  $('#entity_states').val([])
	  }
	  */
	  
	  stage_screenshot()
	  
	  
	  if( $('#stage_BW_states').val() == "" )
	  {
		  $('#stage_BW_states').val("[]")
	  }
	  
	var Defer = $.Deferred()
      Defer = ECCompensateAdjustCoords('subtract')
	
		$.when(Defer).done(function(){
				
				// POPULATE TEXTAREA
			$('#stage_entityCannons').val(JSON.stringify(entityCannons))
			
			  var json = $('form#stg_ed_frm')
						.serializeObject()  
					
				console.log('submit: \r\n'+JSON.stringify(json))
			
			  $.ajax({
				  type : "POST",
				  async: true,
				  url : "export_json_file.php",
				  data : {json:JSON.stringify(json)}/*json*/
			  })
			  .done(function(response){
				  loaderOff()
				  console.log(response)
				  
				  var jsonObj = JSON.parse(response)
				
				 dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
				 
				 ECCompensateAdjustCoords('add')
				 
 				 load_stages_list()
				  
			  })  
			
		})// then
	
	
	})


/*
	ADD ENTITIES TO COLLECTION TO MAKE THEM ACCESSIBLE
*/

window.load_entities = function(){
  entities = []// GLOBAL
  
  var container = 'stages_entities_list_container'
  
  if( arguments.length > 0 ){
	  container = 'stages_entities_list_container_live'
  }
    
  $.each( $('#'+container+' .entities_list .select_entity'),function(i,e){
    var href = $(this).attr('href')
    console.log(href)
    load(href,function(response){			
      var jsonObj = JSON.parse(response)
      entities.push(jsonObj)

    })
  })
  console.log('entities:')	
  console.log(entities)
}			


/*
    function  generateCanvasDropDown( paramsObject )
    
    DOES:
        GENERATE A DROP DOWN TO SELECT A CANVAS 
        FOR AN ENTITY, A BRICKWALL, OR A ENITTY CANNON's ENTITY
        
    PARAMS:
        - GLOBAL JS ARRAY canvases (inferred)
        - paramsObject, example:
        
         var paramsObject =
        {
          id: 'BW_drawOnCanvas', // element id attribute
          name: 'BW_drawOnCanvas', // element name attribute
          selectedValue: 'sky', // option selected by default          
          target: $('#stage_brickwall_name'),// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
          injectMethod: 'insertAfter',// appendTo | insertBefore | insertAfter | replaceWith,
          lbl: 'drawOnCanvas' // element's label text         
        }

     RETURN : NONE
*/
function generateDropDown(paramsObject){
	   
		 var options_str = '';
		 //objectivesOptions
	if( typeof(paramsObject.optionsCollection) !== 'undefined' ){
		$.each(paramsObject.optionsCollection, function(i, e){
		  options_str += '<option id="'+e.name+'" value="'+e.name+'">'
            options_str += e.lbl
          options_str += '</option>'	
		})		  
	}			
	else {
		$.each(canvases, function(i, e){
          options_str += '<option id="'+e.name+'" value="'+e.name+'">'
            options_str += 'z-index:' + e.zIndex + ' - &quot;'+e.name+'&quot;'
          options_str += '</option>'		  
        })
	}
		 
      // MAKE SELECT ELEMENT
      var select = 
				$('<select/>')
				.attr('id',paramsObject.id)
				.attr('name',paramsObject.name)				
				.html(options_str)
        .val(paramsObject.selectedValue)
      
      // REMOVE EXISTING ELEMENT WITH THE SAME ID, IF IT EXISTS
      $('#'+paramsObject.id).remove()
      
      // INJECTION INTO DOM
      var target = paramsObject.target
      switch( paramsObject.injectMethod ){
        case 'appendTo':  
          target.append(select)
        break;
        case 'insertBefore':  
          select.insertBefore(target)
        break;
        case 'insertAfter':  
          select.insertAfter(target)
        break;
        case 'replaceWith':  
          target.replaceWith(select)
        break;  
      }			
		  
  return select.selectmenu()
  
}




/*
	STATES MANAGER -- begin
 
function generateStatesManager( paramsObject ){

DOES: CREATE STATE MANAGER AND BTN TO OPEN IT
PARAMS: paramsObject -- required
 
var paramsObject = 
{
	statesOwnerId: 'flower2.ent',// THE name ATTRIBUTE OF ENTITY/EC/BW THIS STATES COLLECTION BELONGS TO, ex: flower2.ent
	statesDefaultModel: 'flower2.ent',// states[]WILL BE POPULATED WITH THE states[] FROM statesDefaultModel
	target: $('#entity_name'),// JQUERY OBJECT TO USE AS A REFERENCE TO INJECT THE STATES MANAGER BTN 
	injectMethod: 'insertAfter', //HOW TO INJECT THE BTN, i.e.: 'append | insertBefore | insertAfter | replaceWith
	statesManagerId: 'flower2', //ID OF THE INSTANCE OF THE MANAGER DIALOG
}
  */ 
function generateStatesManager( paramsObject ){

	
var statesOwnerId = paramsObject.statesOwnerId,
	statesDefaultModel = paramsObject.statesDefaultModel,
	target = paramsObject.target,
	injectMethod = paramsObject.injectMethod,
    statesManagerId = paramsObject.statesManagerId
	
	//$('a.openStatesManager[dialog="'+statesManagerId+'"]') replaced $('.openStatesManager')
	/*
		IF THE BUTTON EXISTS, REMOVE IT FROM THE DOM
	*/
	if( $('a.openStatesManager[dialog="'+statesManagerId+'"]').length > 0 ){
		$('a.openStatesManager[dialog="'+statesManagerId+'"]').remove()
		/*
			IF THE DIALOG EXISTS, REMOVE IT FROM THE DOM
		*/		
		if( $('#'+statesManagerId).length ){
			$('#'+statesManagerId)
			.dialog('destroy')
			.remove()
		}
	}
	
	// THE LIST THAT CONTAINS THE SORTABLE STATES FORMS
    var statesList =
     $('<ul/>')
	   .addClass('statesList')
       .sortable({       
		   cursor: "grab",
		  /* containment: "parent",
		   placeholder: "sortable-placeholder",
		   grid: [ 300, 600 ],*/
		   handle: '.stateHeader'
		})
  
	  // THE BUTTON THAT OPENS THE DIALOG    
    var selector = $('<a/>')
    .attr('href','#')
    .attr('dialog',statesManagerId)
    .text('edit states')
    .addClass('openStatesManager')
	.button({
		icon: "ui-icon-arrowthickstop-1-e",
		iconPosition: "end"
	})
	
    // INJECTION OF BTN INTO DOM
    var target = paramsObject.target
    switch( injectMethod ){
	  case 'prependTo':  
        target.prependTo(selector)
      break;
	  
      case 'appendTo':  
        target.append(selector)
      break;	  
      case 'insertBefore':  
        selector.insertBefore(target)
      break;
      case 'insertAfter':  
        selector.insertAfter(target)
      break;
      case 'replaceWith':  
        target.replaceWith(selector)
      break;  
    }
  
    // THE DIALOG THAT CONTAINS THE STATES MANAGER
    var statesDialog = 
    $('<div/>')
    .attr('id',statesManagerId)
    /*.append(addStateBtn)*/
    .append(statesList)
    .dialog({
	  title: 'edit states for "'+statesOwnerId+'"',		
      modal: true,
      autoOpen: false,
      width: 800,
      height: 600,
      dialogClass: "dialog-full-mode",
      buttons: [
        {
          text: "state",
          icon: "ui-icon-plusthick",
          click: function( e ) {            
            var statesList = 
            $(this).parents('.ui-dialog').find('.statesList')
            // ADD SORTABLE STATE TO ul.statesList
           // addStateToStateList(statesList)
			$.when( addStateToStateList(statesList) )
			  .then(function(){
				var count = statesList.children('.state').length  			  
				statesList.parents('.ui-dialog').data('countstates',count) 
				countstates(statesList)			  
			  })			  			
		}},
		  {
          text: "save",
          icon: "ui-icon-disk",
          click: function( e ) {            
           
		    // ENTITIES EDITOR
			if(statesManagerId == 'entities_editor_statesManager'){			   
				var paramsObject = 
				{
				  sourceStateManager: $('#entities_editor_statesManager'),
				  editorName: 'entities_editor' // editor's name
				  /*id: 'entity_name'// id of object or input */
				}				
				$('#entity_states')
				.val(JSON.stringify(generateStatesCollection( paramsObject )))				
  			}
			else 
				
			// STAGES EDITOR: EC
			if(statesManagerId == 'stages_editor_ECstatesManager'){			   
				var paramsObject = 
				{
				  sourceStateManager: $('#stages_editor_ECstatesManager'),
				  editorName: 'stages_editor' // editor's name
				  /*id: 'entity_name'// id of object or input */
				}				
				$('#stages_ECstates')
				.val(JSON.stringify(generateStatesCollection( paramsObject )))				
  			}
			else 
				
			// STAGES EDITOR: BW
			if(statesManagerId == 'stages_editor_BWStatesManager'){			   
				var paramsObject = 
				{
				  sourceStateManager: $('#stages_editor_BWStatesManager'),
				  editorName: 'stages_editor' // editor's name
				  /*id: 'entity_name'// id of object or input */
				}				
				$('#stage_BW_states')
				.val(JSON.stringify(generateStatesCollection( paramsObject )))				
  			}
			
			$('#'+statesManagerId)
			.find('li.state').remove()
			
			$('#'+statesManagerId)
			.dialog('disable')			
			.find('.ui-button-fullscreen').remove()	
			
			$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG  
			$('#'+statesManagerId)
			.dialog('enable')
			.dialog('close')
          }
        }],
      create:function(){		
        // ADD .addStateToStatesList TO [+ states]
		// TO ENABLE THE BTN TO ADD A BLANK STATE TO STATES LIST
        $(this).dialog('widget')
        /*.css({fontSize:'1em'})// FIX  */
        .find('.ui-icon-plusthick').parent().addClass('addStateToStatesList') 
		$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG 
		
		if( typeof defStateDialog !== 'undefined' ){
			defStateDialog.resolve()		
		}
		
      },
      close:function(){
        // ON CLOSE RESET FULLSCREEN 
        $(this)
        .dialog('disable')
        .find('.ui-button-fullscreen').remove()
        $(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG  
        $(this).dialog('enable')
      }
    }) 
	$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG	
}// end generateStatesManager( paramsObject ){
 
$(document)
.delegate('.ui-dialog .statesList', "sortstop", function( event, ui ) {
	//alert(ui)
	var parentDialog = $(this).parents('.ui-dialog')
	refreshStatesIndexes( parentDialog )
});
   
/*
	STATES MANAGER:
	ADD A BLANK SORTABLE STATE
	TO THE STATE LIST
	IS USED BY generateStatesManager()
	CREATES & INITS THE next ATTRIBUTE
*/
function addStateToStateList(statesList){
	
// ADD STATE LIST-ITEM	
    $('<li/>')
    .addClass('state')
    .appendTo(statesList)    
// ADD FORM TO STATE	
    $('li.state:last')
    .html('<form id="stateForm'+Date.now()+'" name="stateForm'+Date.now()+'"></form>')  
// ADD HEADER TO STATE's FORM	
    $('li.state:last form')
    .append('<span class="stateHeader ui-widget-header"></span>')    

// CREATE [REMOVE STATE] BUTTON
   var removeStateBtn =
    $('<a/>')
    .attr('href','#')
    .addClass('removeStateBtn')
    .append('<span class="ui-icon ui-icon-circle-close"></span>') 
// ADD [REMOVE STATE] BUTTON TO STATE's HEADER	
    $('li.state:last form .stateHeader')       
    .append(removeStateBtn)    
 
// ADD [+attribute] BUTTON TO STATE's HEADER   
   $('li.state:last form .stateHeader')    
   .append('<a href="#" class="addStateAttributeBtn"><span class="ui-icon ui-icon-plusthick"></span>Property</a>')   

// ADD [+action] BUTTON TO STATE's HEADER   
   $('li.state:last form .stateHeader')    
   .append('<a href="#" class="addStateActionBtn"><span class="ui-icon ui-icon-plusthick"></span>Action</a>')   
   
// ADD DATA[injectionTargetId] TO [+attribute] BUTTON 
   $('li.state:last form .stateHeader')
   .find('.addStateAttributeBtn')
   .data('injectionTargetId',$('li.state:last form').attr('id'))
   
// ADD DATA[injectionTargetId] TO [+action] BUTTON 
   $('li.state:last form .stateHeader')
   .find('.addStateActionBtn')
   .data('injectionTargetId',$('li.state:last form').attr('id'))
   
// ADD NEXT INPUT TO STATE's HEADER	
    var nextInputId = 'next'+Date.now()  
    var nextInput =   
    $('<input/>')
    .attr('id',nextInputId)
    .attr('name','next')
    .val(0),        
    nextInputLbl = 
    $('<label for="'+nextInputId+'"><span class="seconds"></span></label>')
    $('li.state:last form .stateHeader')     
    .append(nextInputLbl)
   $('li.state:last form .stateHeader')    
   .append(nextInput)    
    $('#'+nextInputId)
    .spinner({
      spin:function(event,ui){
        decisecondsToseconds(ui,nextInputId)                    
      },
      change:function(event,ui){
        console.log('ui: '+ui)
        var ui = document.querySelector('#'+nextInputId)
        decisecondsToseconds(ui,nextInputId)
      }
    })
	refreshStatesIndexes($('li.state:last').parents('.ui-dialog'))
	
	if( typeof defStateDialog !== 'undefined' ){
		defStateDialog.resolve()		
	}
	
	return true
}// END OF FUNCTION

// DELETE STATE FROM StatesList
$(document)
.delegate('.removeStateBtn',"click", function(e) {
  e.preventDefault() 
   var parentDialog = $(this).parents('.ui-dialog')
   var count = Number(parentDialog.data('countstates')) 
   count--
   parentDialog.data('countstates',count)    
   countstates($(this))
   $(this).parents('.state').remove()
   refreshStatesIndexes(parentDialog)
})

// UPDATE STATES COUNT IN STATE MANAGER TITLE BAR
// PARAM: This: object from which DOM is parsed 
function countstates(This){
  var dialogTitle = 
  This.parents('.ui-dialog')
  .find('.ui-dialog-title')  
  dialogTitle
  .find('.countstates')
  .remove()  
  dialogTitle
  .append('<span class="countstates"> (states:'+This.parents('.ui-dialog').data('countstates')+')</span>')
}

/*
	OPEN entities_editor STATES MANAGER DIALOG
*/
$(document)
.delegate('#entities_editor .openStatesManager',"mouseup", function(e) {	
  e.preventDefault()   
	var statesManagerId =  $(this).attr('dialog')
	
	//var states = JSON.parse($('#entity_states').val())
	var states = $('#entity_states').val()
	/*
		ENTITIES EDITOR:
		IF THERE ARE NO STATES IN THE TEXTAREA
		JUST OPEN A BLANK STATES MANAGER
		OTHERWISE OPEN THE STATES MANAGER AND POPULATE IT
	*/
	$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG
	if( 
		$('#entity_states').val() === ''
		|| $('#entity_states').val() === "[]"
	){
		var id = '#'+statesManagerId		  
		$(id).dialog("open");
	}
	else if(typeof( JSON.parse($('#entity_states').val())) === 'object'){
		var paramsObject =
		{
			states: $('#entity_states').val(),
			stateDialogObject: $('#entities_editor_statesManager')
		}
		populateStateManager( paramsObject )
	}  
})

/*
	function load_stages_list()
	DOES:
		MAKE A LIST OF SELECTABLE STAGES
	
*/
function load_stages_list(){
	// REFRESH STAGES LIST
	$('#stages_list_container')
	.load('./stages_editor/ #stages_list_container .stages_list',function(e){
		//console.log(e)
	})
}

/*
	DELETE A STAGE
*/
$(document).delegate('#stages_list_container .stages_list a.delete_stage', 'click', function(e) {
  e.preventDefault()
  loader()
  $.ajax({
    method: 'POST',
    url: 'deleteFile.php',
    asyn: true,
    data: {fileUrl: $(this).attr('href')}

  })
    .done(function(response){
		loaderOff()
    var jsonObj = JSON.parse(response)
    dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
    load_stages_list()
  })
})


/*
	OPEN stages_editor STATES MANAGER DIALOG
*/
$(document)
.delegate('#entityCannonFrm .openStatesManager',"mouseup", function(e) {	
  e.preventDefault()

	var statesManagerId =  $(this).attr('dialog')	
	
	//var states = JSON.parse($('#entity_states').val())
	
	var states = $('#stages_ECstates').val()
	/*
		STAGES EDITOR:
		IF THERE ARE NO STATES IN THE TEXTAREA
		JUST OPEN A BLANK STATES MANAGER
		OTHERWISE OPEN THE STATES MANAGER AND POPULATE IT
	*/
	$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG
	//alert(JSON.stringify(states))
	if( 
		$('#stages_ECstates').val() === ''
		|| $('#stages_ECstates').val() === "[]"
	){
		
		var id = '#'+statesManagerId
	
		$(id).find('.state').remove()				
		
		//$(id).find('.ui-dialog-title').text()
		
		var statesOwnerId = $('#entityName').val()
		
		$(id).dialog('option','title','edit states for "'+statesOwnerId+'"')
		
		$(id).find('.countstates').text("(states:0)")
		
		
		$(id).dialog("open");
	}
	else if(typeof( JSON.parse($('#stages_ECstates').val())) === 'object'){
		var paramsObject =
		{
			states: $('#stages_ECstates').val(),
			stateDialogObject: $('#stages_editor_ECstatesManager')
		}
		populateStateManager( paramsObject )
	}
})

/*
	OPEN stages_editor BW STATES MANAGER DIALOG
*/
	$(document)
	.delegate('#stages_editor .openStatesManager',"mouseup", function(e) {	
		e.preventDefault()   
		var statesManagerId =  $(this).attr('dialog')
		var states = $('#stage_BW_states').val()
		/*
			STAGES EDITOR:
			IF THERE ARE NO STATES IN THE TEXTAREA
			JUST OPEN A BLANK STATES MANAGER
			OTHERWISE OPEN THE STATES MANAGER AND POPULATE IT
		*/
		$(document).dialogfullmode();// ADD A FULL SCREEN BUTTON TO THE DIALOG
		if( 
			$('#stage_BW_states').val() === ''
			|| $('#stage_BW_states').val() === "[]"
		){
			var id = '#'+statesManagerId		  
			$(id).dialog("open");
		}
		else if(typeof( JSON.parse($('#stage_BW_states').val())) === 'object'){
			var paramsObject =
			{
				states: $('#stage_BW_states').val(),
				stateDialogObject: $('#stages_editor_BWStatesManager')
			}
			populateStateManager( paramsObject )
		}  
	})
			

	/*
		LOAD A STAGE INTO THE STAGES EDITOR -- begin
	*/
	$(document).delegate('#stages_list_container a.select_stage', 'click', function(e) {
		e.preventDefault()
		loader()
		
		// REMOVE ALL li.state FROM STAGES EDITORS' STATES MANAGERS
		$('#stages_editor_BWStatesManager li.state,#stages_editor_ECstatesManager li.state').remove()
					
		$.getJSON( $(this).attr('href') )
		.done(function(json){  
			
		// STAGE
		$('#stage_preview').html(null)
		$('#stage_name').val(json.name)		  
		$('#stage_description').val(json.description)		  		
		$('#stage_briefing').val(json.briefing)		  		
		$('#stage_entityCannons')
		.val(JSON.stringify(json.stage_entityCannons))
		 
		// SPAWNBALLS 
		$('#spawnBalls').empty()
		$('#spawnBallsList').empty() 
		
		$('#spawnBalls')
		.val(JSON.stringify(json.spawnBalls)) 
		
		console.log('json.spawnBalls')
		console.log(json.spawnBalls)
		
		if($.inArray(json.spawnBalls,['[]','']) == -1 ){			
			populateSpawnBallsFromTextarea()
		}
		
		let maxCasualties = (json.maxCasualties !== undefined)?json.maxCasualties:''
		$('#maxCasualties').val(maxCasualties)		  
		
		
		// BRICKWALL
		$('#stage_BW_drawOnCanvas')
		.val(json.BW_drawOnCanvas)
		.selectmenu('refresh')

		$('#stage_brickwall_name').val(json.stage_brickwall_name)		
		$('#stage_BW_x').val(json.BW_x)	
		$('#stage_BW_y').val(json.BW_y)	
		$('#stage_BW_dx').val(json.BW_dx)	
		$('#stage_BW_dy').val(json.BW_dy)	
		  
		$('#stage_BW_path').val(json.BW_path)
		$('#stage_BW_pathMode').val(json.BW_pathMode)
			
		$('#stage_BW_pathEnd')
		.val(json.stage_BW_pathEnd)
		.selectmenu('refresh')			
			
		$('#stage_BW_pathStep').val(json.BW_pathStep)
		$('#stage_BW_pathIdx').val(json.BW_pathIdx)
		   
		$('#stage_BW_states').val(JSON.stringify(json.BW_states))
		$('#stage_BW_firstStateAt').val(json.BW_firstStateAt)

		$('#objectives').val(JSON.stringify(json.objectives))
		if( typeof(json.objectives) !=='undefined'){
			if( json.objectives.length > 0){ 
				populateObjectivesFromStageJson()
			}
		}
		// LOAD THE BRICKWALL STAGE WITHOUT CHANGING OTHER BW PARAMS
		var t = Date.now()
		var BWJson = destination_dir.brickwalls+'/'+json.stage_brickwall_name+'.json?t='+t
		loadBrickwallToStage(BWJson, false)
			
		// ENTITIES
		// LOAD ENTITIES LIST
		load_entities2()			
		
		entityCannons = json.stage_entityCannons
		var Defer = $.Deferred()
		Defer = ECCompensateAdjustCoords('add')

		$.when(Defer).done(function(){
			//representEntityOnStage( ec )
				
			$.each(entityCannons,function(i,e){
				// ADD EC TO STAGE
				var entityCannon = e
				representEntityOnStage(entityCannon)
				// ERASE & CREATE TOOLTIPS
				makeECPreviewToolTip(e.ID)
				
				if( i == entityCannons.length-1 ){
					//alert('rotate them all')					
					setTimeout(rotateEC,2000)// rotate entityCannons that are rotatable after 2 seconds
				}				
			})
				
		 })
		 .then(function(){
			startMax = 0
			ECResetStart()
			startMaxUpdate()      
			ec_manager_ui2()
			
		 })
		 
		 
		 $('#scrollingScreens').val('[]')
		 $('#scrollingsContainerList').html(null)		 
		 if( json.scrollingScreens != [] && json.scrollingScreens != '' ){
			$('#scrollingScreens').val(JSON.stringify(json.scrollingScreens))
			populateScrollingScreensFromStageJson()
			
		 }
		 
		 var lbl = $('label[for="stage_music"]')
		 lbl.html(null)
		 
		 if( json.music != "" ){
			 $('#stage_music').val(json.music)
			 
			 //json.music = game_assets/sounds/bgm_1-loop.mp3?t=1581778774
			 var music = json.music
			 var idArr = music.split('/')// ['game_assets','sounds,'bgm_1-loop.mp3?t=1581778774']
			 var idExtArr = idArr[idArr.length-1]//bgm_1-loop.mp3?t=1581778774
		 	 var idArr = idExtArr.split('.')//bgm_1-loop,mp3
             var id = idArr[idArr.length-1]//bgm_1-loop			
			 
			 $('<audio/>')
			 .attr('id',id)
			 .attr('src',json.music)			 
			 .appendTo(lbl)	
							
			 $('<a/>')			 
			 .addClass('play_bgm')
			 .prop('href',id)
			 .appendTo(lbl)	
			 
			 $('<a/>')			 
			 .addClass('stop_bgm')
			 .prop('href',id)
			 .appendTo(lbl)	
			 
			 lbl
			 .find('.play_bgm')
			 .button({
				 icon:'ui-icon-play',
				 position: 'end'
			 })
			 
			 lbl
			 .find('.stop_bgm')
			 .button({
				 icon:'ui-icon-stop',
				 position: 'end'
			 })
			
		 } 
		 
			loaderOff() 	

			// NOTIFY OBJET LOADED
			var msg = 'stage '+json.name+' loaded'					
			dialogNotify(msg)					
		
			console.log(JSON.stringify(json))
		})// DONE
	})
/*
    LOAD STAGE INTO THE STAGES EDITOR end
*/


function load_entities2(){
	loader()
	entities = []// GLOBAL
	$('<div/>')
		.attr('id','Entities')
		.appendTo('#stages_editor')
		.load('./entities_editor/ #entities_list_container .entities_list',function(e){

				$.each( $('#Entities .select_entity'),function(i,e){
					var href = $(this).attr('href')
					console.log(i+' '+ e+ ' '+href)
					load(href,function(response){			
						var jsonObj = JSON.parse(response)
						entities.push(jsonObj)
					})// end load

				})// end each	

			$('#Entities').remove()
			loaderOff() 	  
		})// end load			
	
	
}




function refreshStatesIndexes(parentDialog){
  $('.stateIndex').remove()
  parentDialog.find('.state')
  .each(function(idx, el){
     var removeBtn = $(this).find('.removeStateBtn')
    //var idx = $(this).parent().index()
    var stateIndex = $('<span/>')
        .addClass('stateIndex')
        .text(idx+1)
    stateIndex.insertAfter(removeBtn)

  })
}

/*
	FIND AN OBJECT BY ITS id ATTRIBUTE 
	WITHIN A COLLECTION ARRAY
*/
function searchById(nameKey, myArray){
	var i = 0;
	while ( i <= myArray.length-1 ) {
		if (myArray[i].id === nameKey) {
			return myArray[i];
		}
		i++
	}
}

/*
	STATES MANAGER : 
		ATTRIBUTES INPUTs:
			- CREATION,
			- INTERACTIONS  
	-- begin
*/
/* 
	GLOBAL JS ARRAY statesInputs[]
	LIST OF PARAMS TO CREATE ATTRIBUTES INPUTs IN STATES MANAGER's STATES
	-- WILL BE PLACED WITH OTHER JAVASCRIPT GLOBALS
*/
var statesInputs = [
  [/* entities editor: entities & stages editor: ECs */
    {id:'energy',type:'spinner'},
    {id:'strength',type:'spinner'},
    {id:'resistance',type:'spinner'},
    {id:'drawOnCanvas',type:'select',values:['ground','aboveGround','midAir','sky']},
    {id:'x',type:'spinner'},
    {id:'y',type:'spinner'},
    {id:'dx',type:'spinner'},
    {id:'dy',type:'spinner'},
    {id:'path',type:'assetSelector',assetType:'path'},
    {id:'pathEnd',type:'select',values:['loop','reverseLoop','stop']},
    {id:'pathStep',type:'spinner'},
    {id:'pathIdx',type:'spinner'},
	{id:'pathMode',type:'select',values:['absolute','relative']},
    {id:'DEFAULT',type:'assetSelector',assetType:'sprite'},
    {id:'LEFT',type:'assetSelector',assetType:'sprite'},
    {id:'RIGHT',type:'assetSelector',assetType:'sprite'},
    {id:'UP',type:'assetSelector',assetType:'sprite'},
    {id:'DOWN',type:'assetSelector',assetType:'sprite'},
    {id:'APPEAR',type:'assetSelector',assetType:'sprite'},
    {id:'DISAPPEAR',type:'assetSelector',assetType:'sprite'},
    {id:'PUNCHED',type:'assetSelector',assetType:'sprite'},
    {id:'bounceHorizontally',type:'boolean'},
    {id:'bounceVertically',type:'boolean'},
    {id:'outOfHorizontalBoundaryRemove',type:'boolean'},
    {id:'outOfVerticalBoundaryRemove',type:'boolean'},
    {id:'collideWithPaddleRemove',type:'boolean'},
    {id:'collideWithPaddleBounce',type:'boolean'},
    {id:'BounceBallVertically',type:'boolean'},
    {id:'BounceBallHorizontally',type:'boolean'},
    {id:'collideBallRemoveBall',type:'boolean'},
    {id:'collideBallAttacksBall',type:'boolean'},
    {id:'collideBallLoseEnergy',type:'boolean'},
    {id:'collidePaddleLoseEnergy',type:'boolean'},
	{id:'collidePaddleAttacksPaddle',type:'boolean'},	
    {id:'collideWithBWRemove',type:'boolean'},
    {id:'collideWithBWBounce',type:'boolean'}
  ],
  [/* stages editor:BW */
    {id:'drawOnCanvas',type:'select',values:['ground','aboveGround','midAir','sky']},
    {id:'x',type:'spinner'},
    {id:'y',type:'spinner'},
    {id:'dx',type:'spinner'},
    {id:'dy',type:'spinner'},
    {id:'path',type:'assetSelector',assetType:'path'},
    {id:'pathEnd',type:'select',values:['loop','reverseLoop','stop']},
	{id:'pathMode',type:'select',values:['absolute','relative']},
    {id:'pathStep',type:'spinner'},
    {id:'pathIdx',type:'spinner'},
  ],
  [],
  [ 
    {id:'removeSelf',type:'selfFunction',is:'action'},
	{id:'lastState',type:'selfFunction',is:'action'},
	{id:'spawn',type:'assetSelector',assetType:'entity',is:'action'},	
  ]
  
]
/*
  STATE MANAGER:
  GENERATE ATTRIBUTES SELECTOR LIST
    
  generate btns if 
  their matching input is not already injected into form  
*/
function generateStateAttributeSelectorList(paramsObject){
	
	console.log(JSON.stringify(paramsObject))
	
  var statesInputs = paramsObject.array,
      title = paramsObject.title,
      target = paramsObject.target,
	  selectorClass = paramsObject.selectorClass,
      stateForm = paramsObject.stateForm,
      injectionTargetId = paramsObject.injectionTargetId
	
  //alert(JSON.stringify(target))
	
  var dialogId = 'stateSelector'+Date.now()  
  var dialog = 
      $('<div/>')
      .attr('id',dialogId) 
  var selectorList = 
      '<ul class="stateSelectorList">'   
  for ( n in statesInputs ){
	  
     var id = statesInputs[n].id  
	 
     if( stateForm.has('#'+id+stateForm.attr('id')).length == 0 
         && stateForm
		 .find('label')
		 .filter(function(){
			return (				
				$(this).text() == id			
			)
		 })
		 .length == 0
		 		 
		 ){
         selectorList += '<li><a href="#" class="'+selectorClass+'" injectiontargetid="'+injectionTargetId+'">'+id+'</a></li>'      
     }    
   }// end for 


   //alert(injectionTargetId)
   
   selectorList += '</ul>'  
   target.append(dialog)  
  
   $('#'+dialogId)   
   .html(selectorList)    
   .dialog({
     title:title,
     width: 500,
     height: 500,
     close:function(){
        $('#'+dialogId)
        .dialog('destroy')
        .remove()
		$(document).dialogfullmode();// RE-INIT FULLSCREEN BTN
     }
   })
} // end function generateStateAttributeSelectorList(paramsObject)
 
/*
	STATES MANAGER : add 1 attribute (AKA property) to state form
*/ 
$(document)
.delegate('.addStateAttributeBtn','click',function(e){
  e.preventDefault()
  
  var title = 'select entity attribute to add to state'
  var array = statesInputs[0]
  // STAGES EDITOR: ECs
  if( $(this).parents('#stages_editor_ECstatesManager').length > 0 ){
	  var target = $('#stages_editor')	  
  }
  // STAGES EDITOR: BW
  else if( $(this).parents('#stages_editor_BWStatesManager').length > 0 ){
	  var target = $('#stages_editor')
	  title = 'select brickwall attribute to add to state'
	  array = statesInputs[1]
  }
  // ENTITIES EDITOR
  else if( $(this).parents('#entities_editor_statesManager').length > 0 ){
	  var target = $('#entities_editor')
  }
  //alert(target)
  var paramsObject = {
	  title:title,
	  selectorClass:'addStateAttributeInput',
      array: array,
      target: target,
      stateForm: $(this).parents('form'),
      injectionTargetId: $(this).data('injectionTargetId')// JQobject
  }  
  generateStateAttributeSelectorList(paramsObject)  
})

/*
	STATES MANAGER : add 1 action (function) to state form
*/
$(document)
.delegate('.addStateActionBtn','mouseup',function(e){
  e.preventDefault()
 
   var title = 'select entity action to add to state'
  
  // STAGES EDITOR: ECs
  if( $(this).parents('#stages_editor_ECstatesManager').length > 0 ){
	  var target = $('#stages_editor')	  
  }
  // STAGES EDITOR: BW
  else if( $(this).parents('#stages_editor_BWStatesManager').length > 0 ){
	  var target = $('#stages_editor')
	  title = 'select brickwall action to add to state'
  }
  // ENTITIES EDITOR
  else if( $(this).parents('#entities_editor_statesManager').length > 0 ){
	  var target = $('#entities_editor')
  }
     
  var paramsObject = {
      title: title,
      selectorClass:'addStateActionInput',
      array: statesInputs[3],
      target: target,
      stateForm: $(this).parents('form'),
      injectionTargetId: $(this).data('injectionTargetId')// JQobject
  }  
  generateStateAttributeSelectorList(paramsObject)  
})




/*
  function generateStateAttributeInput(paramsObject)
  
  PARAMS: paramsObject -- required
	example:
	var paramsObject = {
      id: $(this).text(), // FUTURE INPUT 's ID
      statesInputsArray: statesInputs[0], // WHICH INPUTS COLLECTION TO USE, 0 = entities_editor
      targetId: $(this).attr('injectiontargetid') // DOM CONTAINER OF FUTURE INPUT
    }  
  
  GENERATE ONE STATE INPUT INTO STATE's FORM
*/
function generateStateAttributeInput(paramsObject){
	
    var id = paramsObject.id,
        statesInputsArray = paramsObject.statesInputsArray,
        targetId = paramsObject.targetId,
        el, lbl,
		defaultValue
		
		
		//console.log('paramsObject: '+JSON.parse(paramsObject))
		
		// SECOND parameter is the default value
		// i.e. value loaded from the json file 
		if( arguments.length == 2 ){
			defaultValue = arguments[1]
		}
		
		// GET THE INPUT DEFINITION OBJECT
		var inputParams = searchById(id, statesInputsArray)
		
		/*
			USED TO DISTINGUISH ACTION FROM ATTRIBUTE is : 'action ' | false
			
			IMPORTANT:
			ON [save state] CLICK:
			.stateAttributeRow.action WILL BE REGISTERED WITH ADDITIONAL PARAMETERS
			i.e. ADDITIONNAL FIELDS FOR ATTRIBUTE 'params'			
			
		*/
		
		//console.log('typeof inputParams.is: '+typeof inputParams)
		
		
		var is = (typeof inputParams != 'undefined')?' '+inputParams.is:''
		
        var container =
        $('#'+targetId)
        .append('<div class="stateAttributeRow'+is+'"></div>') 
		
        var target = container.find('.stateAttributeRow:last')
		
        container
        .find('.stateAttributeRow:last')             
        .append('<a href="#" class="deleteAttribute"><span class="ui-icon ui-icon-close"></span></a>')
		   
	
    var type = inputParams.type
	
    if( container.has('#'+id+container.attr('id')).length <1 ){
      switch( type ){
        case 'spinner':
          el = 
          $('<input/>')
          .attr('type','text')
          .attr('id',id+container.attr('id'))
          .attr('name',id)          
          lbl = 
          $('<label/>')
          .attr('for',id+container.attr('id'))
          .text(id)
          target
          .append(lbl)
          target
          .append(el)
          $('#'+id+container.attr('id'))
		  .val(defaultValue) // SET DEFAULT VALUE
		  .spinner()
        break;
        case 'select':
          el = 
          $('<select/>')          
          .attr('id',id+container.attr('id'))
          .attr('name',id)          
          var options_str;
          $.each(inputParams.values, function(i,e){
            options_str += '<option id="'+i+'" value="'+e+'">'
            options_str +=  e
            options_str += '</option>'
          })
          el
          .append(options_str)
          lbl = 
          $('<label/>')
          .attr('for',id+container.attr('id'))
          .text(id)
          target
          .append(lbl)
          target
          .append(el) 
		  
		  // SET DEFAULT VALUE
		  $('#'+id+container.attr('id'))
		  .val(defaultValue)
				
          
        break; // case 'spinner' end
        case 'assetSelector':          
          if( inputParams.assetType == 'path' ){
            var paramsObject = {
              selectorId: 'selector'+id+container.attr('id'),
              target: target,
              injectMethod: 'appendTo',
              contentPath: './paths_editor/ #paths_list_container .paths_list'
            }
            var contentUrlEnd = ' .paths_list .select_path'
            var thumbClass = 'path_thumb'
			var assetPath = 'game_assets/paths'
			
			
		  var noPathBtn = 
          $('<a/>')
          .attr('href','#')
		  .text('no')
          .addClass('BWnoPathBtn')          
          .on('mouseup',function(e){
			// remove path thumbnail
			$(this).parents('label').find('img').remove()  
			// set path to -1
			$(this).parents('label').next('input').val(-1)
		  })
						
          }
          else if( inputParams.assetType == 'sprite' ){
            var paramsObject = {
              selectorId: 'selector'+id+container.attr('id'),
              target: target,
              injectMethod: 'appendTo',
              contentPath: './sprites_editor/ #sprites_list_container .sprites_list'
            }
            var contentUrlEnd = ' .select_sprite'
            var thumbClass = 'sprite_thumb'
			var assetPath = 'game_assets/entities'
          }          
          
          el = 
          $('<input/>')
          .attr('type','text')
          .attr('id',id+container.attr('id'))
          .attr('name',id)          
          .on('mouseup',function(e){
            //e.preventDefault()
            generateAssetSelector( paramsObject )
			
           $(document)           
           .delegate('#'+'selector'+id+container.attr('id')+contentUrlEnd,'click',function(e){
              e.preventDefault()  
			  
              $('label[for="'+id+container.attr('id')+'"] .'+thumbClass).remove() 
			  
              var img = $(this).find('img')
			  console.log(  
			  "label:"
				+$('label[for="'+id+container.attr('id')+'"]').text()
			  )
			  console.log("img:"+img.src)
			  console.log("$('#'+id+container.attr('id')):"  
				+$('#'+id+container.attr('id'))
			  )
			  
              $('#'+id+container.attr('id'))
			  .val(
				img.attr('title')
			  )
			  			  			  
              img
              .addClass(thumbClass)
              .appendTo('label[for="'+id+container.attr('id')+'"]')   
			  
              $(document)
              .undelegate( '#'+'selector'+id+container.attr('id')+contentUrlEnd, "click")    
			  
              $('#'+'selector'+id+container.attr('id'))
              .dialog('destroy')
              .remove()
			  
              $(document).dialogfullmode();// RE-INIT FULLSCREEN BTN
            })            
          })//.on('mouseup',function(e){          
            
          lbl = 
          $('<label/>')
          .attr('for',id+container.attr('id'))
          .text(id)
          target
          .append(lbl)
          target
          .append(el) 
		  
		   // FOR path only, inject no path btn
		   if( typeof (noPathBtn) !== 'undefined'  ){
			 target
			.find('label')
			.append(noPathBtn)  
		   }
		  
			/*
				IF THERE IS A DEFAULT VALUE
				SET IT 
				FETCH THE THUMBNAIL SOURCE, ADD THE THUMBNAIL TO THE LABEL
			*/			 
			if( typeof defaultValue !== 'undefined' ) {				
				// SET DEFAULT VALUE
				$('#'+id+container.attr('id'))
				.val(defaultValue)	
				if( defaultValue != -1 ){
					// GET THE THUMBNAIL						 
					var src = assetPath+'/'+defaultValue+'.png'
					$('<img/>')
					.attr('src',src)
					.addClass(thumbClass)
					.appendTo('label[for="'+id+container.attr('id')+'"]') 
				}
			}
        break; // case 'assetSelector' end  
        
        case 'boolean':          
          var e = {idTrue:'yes',idFalse:'no'},
              i = 'selector'+id+container.attr('id')          
          var label =
          $('<label/>')
          .text(id)
          var input1 =
          $('<input/>')
          .attr('type','radio')
          .attr('id',i+e.idTrue)  
          .attr('name',i)
          .val(true)
          var label1 =
          $('<label/>')
          .attr('for',i+e.idTrue)  
          .text(e.idTrue)
          var input2 =
          $('<input/>')
          .attr('type','radio')
          .attr('id',i+e.idFalse)  
          .attr('name',i)
          .val(false)
          var label2 =
          $('<label/>')
          .attr('for',i+e.idFalse)  
          .text(e.idFalse)
          $('<span/>')
          .addClass('btnSet')
          .appendTo(target)          
          var targetBtnSet = target.find('.btnSet:last')          
          label
          .appendTo(targetBtnSet)
		  
           // NO - false
          input2
          .appendTo(targetBtnSet)  
          label2
          .appendTo(targetBtnSet)
		  
          // YES - true
          input1
          .appendTo(targetBtnSet)  
          label1
          .appendTo(targetBtnSet)
		  
          $( targetBtnSet ).controlgroup();
		  
		  if( typeof defaultValue !== 'undefined' ) {				
				// SET DEFAULT VALUE
		   
		   var Id = ( defaultValue === 'true' )?e.idTrue:e.idFalse
		   
		   $("#"+i+e.idTrue).prop( "checked", false).checkboxradio( "refresh" );         
		   $("#"+i+e.idFalse).prop( "checked", false).checkboxradio( "refresh" );
		   
		   $("#"+i+Id).prop( "checked", true).checkboxradio( "refresh" );
         
		  }
        break;
          
  } // end switch
 } // if end
	/*if( typeof(defStateDialog) !== 'undefined' ){
		defStateDialog.resolve()
	}*/
} // function generateStateAttributeInput end
/*
  ADD ATTRIBUTE INPUT TO STATES MANAGER's STATE
*/
$(document)
.delegate('.addStateAttributeInput','mouseup',function(e){
  e.preventDefault()

  var statesInputsArray = statesInputs[0]
  // IF THE STATES MANAGER IS FOR STAGES EDITOR: BW,
  // LOAD THE CORRESPONDING statesInputs[]
  /*
	IF THE PARENT DIALOG OF [.addStateAttributeInput] CONTAINS THE 
	WORD 'brickwall' IN ITS TITLE
	USE statesInputs[1] 
  */  
  if( $(this).parents('.ui-dialog').find('.ui-dialog-title:contains("brickwall")').length){
	  statesInputsArray = statesInputs[1]
  }
  
  var paramsObject = {
      id: $(this).text(),// input ID
      statesInputsArray: statesInputsArray, // array used within statesInputs[]
      targetId: $(this).attr('injectiontargetid') // where to inject the input
  }  
  generateStateAttributeInput(paramsObject)  
   $(this)   
   .parents('.ui-dialog').remove()  
})


function generateStateActionInput(paramsObject){
	var id = paramsObject.id,
        statesInputsArray = paramsObject.statesInputsArray,
        targetId = paramsObject.targetId,
        el, lbl,
		defaultValue = ''


		if( arguments.length == 2 ){
			defaultValue = arguments[1]
		}
		
		// GET THE INPUT DEFINITION OBJECT
		var inputParams = searchById(id, statesInputsArray)
		
		/*
			USED TO DISTINGUISH ACTION FROM ATTRIBUTE is : 'action ' | false
			
			IMPORTANT:
			ON [save state] CLICK:
			.stateAttributeRow.action WILL BE REGISTERED WITH ADDITIONAL PARAMETERS
			i.e. ADDITIONNAL FIELDS FOR ATTRIBUTE 'params'			
			
		*/
		var is = (typeof inputParams.is !== 'undefined')?' '+inputParams.is:''
		
        var container =
        $('#'+targetId)
        .append('<div class="stateAttributeRow'+is+'"></div>') 
		
        var target = container.find('.stateAttributeRow:last')
		
        container
        .find('.stateAttributeRow:last')             
        .append('<a href="#" class="deleteAttribute"><span class="ui-icon ui-icon-close"></span></a>')
	
	
    var type = inputParams.type
	
    if( container.has('#'+id+container.attr('id')).length <1 ){
      switch( type ){
		 
         case 'assetSelector':  
			if( inputParams.assetType == 'entity' ){
			    // USED BY ACTION: spawn()
				var paramsObject = {
				  selectorId: 'selector'+id+container.attr('id'),
				  target: target,
				  injectMethod: 'appendTo',
				  contentPath: './entities_editor/ #entities_list_container .entities_list',
				  searchFormId: 'stageFilterStateEntitySpawn'
				}
				var contentUrlEnd = ' .select_entity'
				var thumbClass = 'entity_thumb'
				var assetPath = 'game_assets/entities'
            }   
          
          el = 
          $('<input/>')
          .attr('type','text')
          .attr('id',id+container.attr('id'))
          .attr('name',id)		  
          .on('mouseup',function(e){
            //e.preventDefault()
            generateAssetSelector( paramsObject )
			
           $(document)           
           .delegate('#'+'selector'+id+container.attr('id')+contentUrlEnd,'click',function(e){
              e.preventDefault()  
			  
              $('label[for="'+id+container.attr('id')+'"] .'+thumbClass).remove() 
			  
              var img = $(this).find('img')
			  console.log(  
			  "label:"
				+$('label[for="'+id+container.attr('id')+'"]').text()
			  )
			  console.log("img:"+img.src)
			  console.log("$('#'+id+container.attr('id')):"  
				+$('#'+id+container.attr('id'))
			  )
			  
              $('#'+id+container.attr('id'))
			  .val(img.attr('title'))
			  			  			  
              img
              .addClass(thumbClass)
              .appendTo('label[for="'+id+container.attr('id')+'"]')   
			  
              $(document)
              .undelegate( '#'+'selector'+id+container.attr('id')+contentUrlEnd, "click")    
			  
              $('#'+'selector'+id+container.attr('id'))
              .dialog('destroy')
              .remove()
			  
              $(document).dialogfullmode();// RE-INIT FULLSCREEN BTN
            })            
          })//.on('mouseup',function(e){          
            
          lbl = 
          $('<label/>')
          .attr('for',id+container.attr('id'))
          .text(id)
		  
          target
          .append(lbl)
		  
          target
          .append(el) 
		 
		   if( typeof defaultValue !== 'undefined' ) {				
				// SET DEFAULT VALUE
				$('#'+id+container.attr('id'))
				.val(defaultValue)	

				// GET THE THUMBNAIL						 
				var src = assetPath+'/'+defaultValue+'.png'
				$('<img/>')
				.attr('src',src)
				.addClass(thumbClass)
				.appendTo('label[for="'+id+container.attr('id')+'"]') 
			}
		 break;
		 
		 case 'selfFunction':
			//USED BY ACTION: removeSelf()
			//
			//	{"name":"spawn","params":{"name":"flower2"}}
			//	"action":{"name":"removeSelf","params":{}}
			//
		  
		  el = 
          $('<input/>')
          .attr('type','text')
          .attr('id',id+container.attr('id'))
          .attr('name',id)  
		  
		  lbl = 
          $('<label/>')
          .attr('for',id+container.attr('id'))
          .text(id)
		  
          target
          .append(lbl)
          target
          .append(el)
			
		break; 
		  
	  }//end switch
		
	}// end if( container.has('#'+id+container.attr('id')).length <1 )
}


/*
  ADD ACTION INPUT TO STATES MANAGER's STATE
*/
$(document)
.delegate('.addStateActionInput','mouseup',function(e){
  e.preventDefault() 
  var paramsObject = {
      id: $(this).text(),
      statesInputsArray: statesInputs[3],
      targetId: $(this).attr('injectiontargetid')
  }  
  generateStateActionInput(paramsObject)  
   $(this)   
   .parents('.ui-dialog').remove()  
})


/*
  DELETE ATTRIBUTE INPUT & LABEL FROM STATES MANAGER's STATE
*/
$(document)
.delegate('.stateAttributeRow .deleteAttribute','mouseup',function(e){
  e.preventDefault()  
   $(this)   
   .parent()
   .remove()  
})

/*
	STATES MANAGER : 
		ATTRIBUTES INPUTs:
			- CREATION,
			- INTERACTIONS  
	-- end
*/

/*
  GET STATES FROM STATES MANAGER 
  & RETURN THEM AS A COLLECTION (array)
*/
function generateStatesCollection( paramsObject ){
  var states = [],
      sourceStateManager = paramsObject.sourceStateManager,
      editorName = paramsObject.editorName/*,
      id = paramsObject.id*/

  // get states
  var stateObjects = sourceStateManager.find('.state')
   
  // ITERATE THROUGH STATES
  $.each(stateObjects,function(i,e){
    var state = {}
    // ITERATE THROUGH STATES ATTRIBUTES
    $(this).find('form > div.stateAttributeRow > *')
    .each(function(j,f){
      
	  // ADD "next"'s key and value to states[]'s item
	  if( j == 0 ){
		  var next = $(this).parents('.state').find('input[name="next"]').val()		  
		  var propertyName =  'next',
              value =  next
			  addPropertyValue(state,propertyName,value)
	  }
	  
	  if($(this).parents('.stateAttributeRow').hasClass('action')){
		  
		  
		   var propertyName =  'action',
               value =  {
						 "name": $(this).attr('name'),
						 "params": {name:$(this).val()}
						}	
          addPropertyValue(state,propertyName,value)
		  
		  
	  }
	  else 
      if(f.tagName != 'LABEL'){       
        if( 
           $(this).is('input') 
           || $(this).is('select')           
        ){
         
           var propertyName =  $(this).attr('name'),
              value =  $(this).val()
          addPropertyValue(state,propertyName,value)
        }
        else if($(this).hasClass('ui-spinner')){
          var propertyName = $(this).children(0).attr('name'),
              value = $(this).children(0).val()
          addPropertyValue(state,propertyName,value)         
        }
        else if( $(this).hasClass('btnSet') ){
          
        var radioName = 
          $(this).find("input[type='radio']").attr('name');
          var radioValue = $("input[name='"+radioName+"']:checked").val();
          var propertyName = $(this).find('label:first').text(),
              value = radioValue
              addPropertyValue(state,propertyName,value)
        }
      }

      
    })
    
    // append state{} to states[]
    states.push(state)
  })
  console.log(JSON.stringify(states))
  return states
}

/*
  function populateStateManager( paramsObject )
  DOES:
    populate a state manager from a states collection
    
  PARAMS:
    paramsObject -- required
    paramsObject =
    {
       states: states[],
       stateDialogObject: jquery ui dialog ID       
    }
    example: 
    populate entities editor states
    var paramsObject =
    {
       states: $('#entity_states').val(),
       stateDialogObject: $('#entities_editor_statesManager')
    }
    populateStateManager( paramsObject )
*/
function populateStateManager( paramsObject ){
  var states = JSON.parse( paramsObject.states )
  
  
  console.clear()
  //console.log(states)
  
  
  if( typeof(states) === 'object' && states.length > 0  ){

    // SELECT STATES MANAGER DIALOG -- WILL BE CHANGED
    var dialog = paramsObject.stateDialogObject
	
	dialog.find('.state').remove()
	
    // OPEN STATES MANAGER DIALOG
    dialog.dialog('open')

    // PARSE states{} 1st level
    $.each( states, function(i,e){

      defStateDialog = $.Deferred()

      // ADD ONE STATE TO THE STATESLIST
      dialog
      .parents('.ui-dialog')
      .find('.addStateToStatesList')
      .trigger('click')

      /*
        WHEN STATE HAS BEEN ADDED TO STATESLIST
      */
      $.when( defStateDialog )
      .then(function(){

        var stateKeys = Object.keys(e)
        var stateValues = Object.values(e)

        dialog
        .find('li.state:eq('+i+') form input[name="next"]')
        .val(states[i].next) 
        
        /*
          ITERATE THROUGH ALL
          ITEMS, i.e. ATTRIBUTES | ACTIONS
          & GENERATE THEIR RELEVANT INPUT 
          IN THE LAST STATE FORM GENERATED
          -- begin
        */
        // targetId is ID of form within last li.state inserted into DOM
        var targetId = $('li.state:last form').attr('id')
             
        var n = 0
        while ( n < stateKeys.length ) {

            var id = stateKeys[n]
           
             if( id == 'action' ){
                // ADD STATE ACTION INPUT
                console.log('36 -- e.action.name:'+e.action.name)
                var defaultValue = e.action.params.name

                var paramsObject = {
                  id: e.action.name,
                  statesInputsArray: statesInputs[3],
                  targetId: targetId
                }  
                generateStateActionInput(paramsObject, defaultValue)        
              }
              else if( id != 'action' && id != 'next' ){
                // ADD STATE ATTRIBUTE INPUT

                var defaultValue = stateValues[n]
                
                var paramsObject = {
                  id: id,// input ID
                  statesInputsArray: statesInputs[0], // array used within statesInputs[]
                  targetId: targetId // where to inject the input
                } 

				console.log('8043 -- id:'+paramsObject.id)
				console.log('8043 -- statesInputsArray:'+paramsObject.statesInputsArray)
				console.log('8043 -- targetId:'+paramsObject.targetId)				
				
                generateStateAttributeInput(paramsObject, defaultValue) 
              }
          n++
        }// end while 

        /*
          ITERATE THROUGH ALL
          ITEMS, i.e. ATTRIBUTES | ACTIONS
          & GENERATE THEIR RELEVANT INPUT 
          IN THE LAST STATE FORM GENERATED
          -- end
        */

       })// end then
    })// END $.each(states,function(i,e){

  }// end if( typeof(states) !== 'undefined' && states.length > 0  ){
}


/*
  function addPropertyValue(obj,propertyName,value)
  APPEND PROPERTY & VALUE DYNAMICALLY TO AN OBJECT
*/
function addPropertyValue(obj,propertyName,value){
  // Example of an object property added with defineProperty with a data property descriptor
  Object.defineProperty(obj, propertyName, {value: value,
                           writable : true,
                           enumerable : true,
                           configurable : true});
}


$(document)
.delegate('#toggle_timeline_controls','mouseup',function(e){
	e.preventDefault();
	$('#stage_timeline_container')
	.toggle()
})


function hideEmptyStageFrames(){
	$('#ec_list .selectStageFrame ul.li_ec')
    .each(function(){       
        if( $(this).children('li:not(.EC_btns)').length < 1 ){
           $(this).parents('li.selectStageFrame').hide()
        }   
    })	
}


$(document)
.delegate('#hideEmptyStageFrames','mouseup',function(){
	$(this).addClass('selected')
	$('#showAllStageFrames').removeClass('selected')
	hideEmptyStageFrames()
})

$(document)
.delegate('#showAllStageFrames','mouseup',function(){
	$(this).addClass('selected')
	$('#hideEmptyStageFrames').removeClass('selected')
	//$('#ec_list .selectStageFrame').show()  
})

function toggleDisplayStageEmptyFrames(){
	if( $('#showAllStageFrames').hasClass('selected') == true ){
		$('#ec_list .selectStageFrame').show()  
	}else{
		hideEmptyStageFrames()
	}
}


/*
	STAGES EDITOR SCROLLING FUNCTIONS -- begin
*/



/*
   div#scrollingsContainer 
      ul#scrollingsContainerList
          li.parallax
          li.parallax
          ...
            screensToScroll
            screensScrollSpeed
*/

function generate_stage_scrolling_UI(){
  // REMOVE EXISTING ELEMENTS IN THE DOM
  $('#scrollingsContainer').remove()
  $('#scrollingsContainerList').remove()
  // ADD scrollingsContainer TO DOM
  $('<div/>')
  .attr('id','scrollingsContainer')
  .addClass('halfPanelStyle')
  .appendTo('#stage_preview_container')

  var scrollingsContainer = $('#scrollingsContainer')

  // ADD scrollingsContainerList TO #scrollingsContainer
  var scrollingsContainerList =
  $('<ul/>')
  .attr('id','scrollingsContainerList')
  .appendTo('#scrollingsContainer')
  /*
  $('#stage_preview_container')
  .resizable()
  */
}

// ADD A PARALLAX
/*
  ADD .parallax 
        .removeParallaxBtn 
*/
window.add_stage_parallax = function(){
	
  var paramsObject;
  var screensToScroll = 0,
	  screensScrollSpeed = 0;
  
  if( arguments.length > 0){
	  paramsObject = arguments[0]
  }
  
  if( typeof paramsObject !== 'undefined'  ){	   
	 screensToScroll = paramsObject.screensToScroll 
	 screensScrollSpeed =   paramsObject.screensScrollSpeed	  
  }
  
  $('<li/>')
  .addClass('parallax')
  .appendTo('#scrollingsContainerList')
  
  var parallax = 
  $('#scrollingsContainerList>li.parallax:last')
  
  // ADD header title + removeParallaxBtn TO .parallax .parallaxHeader  
  var headerHTML =   
  '<a href="#" class="removeParallaxBtn">&times;</a>'
  +'<span class="title">'
  +'&nbsp;parallax&nbsp;'+$('#scrollingsContainerList>li.parallax').length
  +'</span>'
   
 // +'<a href="#" class="shootable">shootable</a>'
 
   
   
  $('<span/>')
  .addClass('parallaxHeader')
  .html(headerHTML)
  .appendTo(parallax)
  
  //div
  $('<ul/>')
  .addClass('screensContainer')
  .appendTo(parallax)
  
  // ADD input.screensToScroll TO .parallax .parallaxHeader
  var datenow = Date.now() 
  var sTSID = 'screensToScroll'+datenow,
      sSSID = 'screensScrollSpeed'+datenow
  // .screensToScroll
  
  var screensToScrollLbl =
  $('<label/>')
  .attr('for',sTSID)
  .text('screensToScroll Total')
  
  parallax
  .find('.parallaxHeader')
  .append(screensToScrollLbl)
  
  var screensToScroll =
  $('<input/>')
  .attr('id',sTSID)
  .addClass('screensToScroll')
  .val(screensToScroll)  

  parallax
  .find('.parallaxHeader')
  .append(screensToScroll)
  
  // TURN .screensToScroll#sTSID into a spinner
  $('#'+sTSID)
  .spinner()
  
  
  var screensScrollSpeedLbl =
  $('<label/>')
  .attr('for',sSSID)
  .text('screensScrollSpeed')
  
  parallax
  .find('.parallaxHeader')
  .append(screensScrollSpeedLbl)
  
  var screensScrollSpeed =
  $('<input/>')
  .attr('id',sSSID)
  .addClass('screensScrollSpeed')
  .val(screensScrollSpeed)  

  parallax
  .find('.parallaxHeader')
  .append(screensScrollSpeed)
  
  // TURN .screensToScroll#sTSID into a spinner
  $('#'+sSSID)
  .spinner()
  
  // GET a.removeParallaxBtn
  removeParallaxBtn = 
  parallax
  .find('.removeParallaxBtn')  
  
  removeParallaxBtn
  .on('click',function(){
    $(this).off('click')
    $(this)
    .parents('.parallax').remove()
  })
  
  // ADD [+screen] TO .parallax
  var addScreenToParallaxBtn = 
      $('<a/>')
      .attr('href','#')
      .text('screen')  
      .addClass('addScreenToParallaxBtn')   
   
  parallax
  .prepend(addScreenToParallaxBtn)
  
  addScreenToParallaxBtn = 
   parallax
   .find('.addScreenToParallaxBtn')
  
   addScreenToParallaxBtn
   .button({
     icon: "ui-icon-plusthick",
     iconPosition: "end"
   })
  
   $('.screensContainer')
  .sortable({       
	   cursor: "grab",
	   handle: '.screenContainerHeader'
	})

}


function addScreenToParallax( parallaxObject ){ 
  
  var spriteName = '',
	  drawOnCanvas = 'groundScrolling',
	  loop = 0
  
  // GET screensContainer
  var screensContainer = parallaxObject.parallax.find('.screensContainer')  
  
  var datenow = Date.now()  
  var screenContainerId = 'screenContainer'+datenow,
      spriteNameId = 'spriteName'+datenow,
      loopId = 'loop'+datenow,
      drawOnCanvasId = 'drawOnCanvas'+datenow
  
  // PREPARE screenContainer
  var screenContainer = 
  $('<li/>')
  .addClass('screenContainer')
  .attr('id',screenContainerId)
  
  // APPEND screenContainer TO // PREPARE screensContainer
  screensContainer.append(screenContainer)  
  
  // ADD spriteName input  
  if( typeof parallaxObject.spriteName !== 'undefined' ){
	  spriteName = parallaxObject.spriteName	  
  } 
  $('<input/>')
  .addClass('spriteName')
  .addClass('sprite_selector')
  .attr('id',spriteNameId)
  .attr('type','text')
  .attr('placeholder','select screen sprite')
  .appendTo( '#'+screenContainerId )
  .val(spriteName)
  
  if( typeof parallaxObject.spriteName !== 'undefined' ){
	  
	  // ADD SCROLLING SPRITE THUMBNAIL
	  var img = new Image()//$('<img/>')//
	  /*img
	  .setAttribute('id','im'+Date.now())
	  .classList = 'sprite_thumb'*/
	  screenContainer = document.querySelector('#'+screenContainerId)
	  screenContainer.insertBefore(img, screenContainer.firstChild);
	  
	  img.load = function(){
		console.clear()
		console.log('img'+img.src)	
		
		//$(img)
		//.addClass('sprite_thumb')
		//.attr('id','im'+Date.now())
		//.prependTo(screenContainer)
				
	  }
	  img.src = destination_dir.sprites+'/'+spriteName+'.png'	 
  } 
  
  screenContainer = $('#'+screenContainerId)
  
  screenContainer
  .find('img')
  .addClass('sprite_thumb')
  .attr('id','im'+Date.now())
  
  // ADD loop input
  if( typeof parallaxObject.loop !== 'undefined' ){
	  loop = parallaxObject.loop	  
  }   
  $('<input/>')
  .addClass('loop') 
  .attr('id',loopId)
  .attr('type','text')
  .attr('placeholder','loops | -1:infinite')
  .appendTo( '#'+screenContainerId )
  .val(loop)
  
   $( '#'+loopId )  
   .spinner()
   
   /*
      ADD drawOnCanvas select menu before '#'+loopId
   */
   if( typeof parallaxObject.loop !== 'undefined' ){
	  drawOnCanvas = parallaxObject.drawOnCanvas	  
   } 
    var paramsObject =
        {
          id: drawOnCanvasId, // element id attribute
          name: 'drawOnCanvas', // element name attribute
          selectedValue: drawOnCanvas, // option selected by default          
          target:  $( '#'+loopId ).parent('.ui-spinner') ,// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
          injectMethod: 'insertBefore',// appendTo | insertBefore | insertAfter | replaceWith,
          lbl: 'drawOnCanvas' // element's label text         
        }   
   generateDropDown(paramsObject) 
      
    var screenContainerHeader =      
    $('<span class="screenContainerHeader"></span>')    
    screenContainerHeader.prependTo(screenContainer)
  
     // ADD header title + removeParallaxBtn TO .parallax .parallaxHeader  
    var removeScreenBtn =   
    $('<a href="#" class="removeScreenBtn">&times;</a>')
       
    removeScreenBtn.prependTo(screenContainerHeader)
  
    screenContainerHeader
    .append('<span class="ui-icon ui-icon-arrowthick-2-n-s"></span>')
  
    // GET a.removeParallaxBtn
    removeScreenBtn =
    screenContainer
    .find('.removeScreenBtn')  

    removeScreenBtn
    .on('click',function(){
      $(this).off('click')
      $(this)
      .parents('.screenContainer').remove()
    }) 
  
}// end function addScreenToParallax( parallaxObject )

/*
	function populateScrollingScreensArray()

  DOES: 
				RESETS AND POPULATE GLOBAL ARRAY scrollingScreens[]
  		  POPULATE TEXTAREA#scrollingScreens
  RETURNS VOID		
*/

function populateScrollingScreensArray(){

	scrollingScreens = []
	$.each( $('li.parallax'),function( i, e ){
		scrollingScreens[i]  = []
		/* 
			FIRST LEVEL INPUTS
		*/
		var screensToScroll = $(this).find('.screensToScroll').val()
		var screensScrollSpeed = $(this).find('.screensScrollSpeed').val()
		var parallaxSettings = {
				screensToScroll: screensToScroll,
				screensScrollSpeed: screensScrollSpeed
		}
		console.log(i+' '+screensToScroll+' '+screensScrollSpeed)

		scrollingScreens[i].push(parallaxSettings)
			/* 
				SECOND LEVEL INPUTS	
			*/
			var parallax = $(this)
			$.each( parallax.find('.screenContainer'),function( j, f ){
					var spriteName = $(this).find('.spriteName').val()
					var drawOnCanvas = $(this).find('select[name="drawOnCanvas"]').val()
					var loop = $(this).find('.loop').val()

					var screen = {	
						spriteName: spriteName,
						drawOnCanvas: drawOnCanvas,
						loop: loop
					}
					console.log(spriteName+' '+drawOnCanvas+' '+loop)
					scrollingScreens[i].push(screen)
			})
	})
	console.log(JSON.stringify(scrollingScreens))
  $('#scrollingScreens').val(JSON.stringify(scrollingScreens))
}



$(document)
.delegate('#addParallaxBtn','mouseup',function(e){
  e.preventDefault()
	add_stage_parallax()	
})

$(document)
.delegate('.addScreenToParallaxBtn','mouseup',function(e){
  e.preventDefault()
  var parallax = 
  $(this)
  .parents('.parallax')
  var parallaxObject =
  {
    parallax: parallax  
  }  
	addScreenToParallax(parallaxObject)
})

/*
  STAGES EDITOR: 
    SCROLLINGS EDITION
    CREATE SCROLLING SCREEN SPRITE SELECTOR
*/
$(document)
	.delegate('.screenContainer input.sprite_selector','click',function(e){
	  e.preventDefault() 
	  
    $(this).parent('li').addClass('selectedScrollingName') 
  
	loader()
	  
	  var paramsObject = {
			selectorId: 'scrolling_sprites_list_container',
			target: $(this).parents('.screenContainer'),
			injectMethod: 'appendTo',
			contentPath: './sprites_editor/ #sprites_list_container .sprites_list',
			title: 'select a sprite for the scrolling'
		}
		generateAssetSelector( paramsObject )
})


/*
  STAGES EDITOR: 
    SCROLLINGS EDITION
    SELECT SPRITE FOR SCROLLING SCREEN
*/
	$(document)
	  .delegate('#scrolling_sprites_list_container .select_sprite','click',function(e){
	  e.preventDefault()
            
    var screenContainer = $('.selectedScrollingName'),
        input = screenContainer.find('.sprite_selector')
    
    screenContainer
    .children('img')
    .remove()  
    
	  var img = $(this).children('img')	 
    
	  img
		.addClass('sprite_thumb')
		.attr('id','im'+Date.now())
		.prependTo(screenContainer)		

	  input.val($(this).children('.spriteLbl').text())
	  screenContainer.removeClass('selectedScrollingName')
	  $('#scrolling_sprites_list_container').remove()
	})
	
	
/*
	STAGES EDITOR: 
		SCROLLINGS EDITION
		POPULATE SCROLLING EDITOR FROM stage.json' s textarea#scrollingScreens
*/
function populateScrollingScreensFromStageJson(){

	scrollingScreens = []
  
  if( $('#scrollingScreens').val() == ''
	  || $('#scrollingScreens').val() == '[]'
  ){
	  return
  }
  
  scrollingScreens = JSON.parse($('#scrollingScreens').val())
    
  console.log(scrollingScreens)
  
  for ( var m = 0; m < scrollingScreens.length;m++ ){
       
    /* 
		  ADD ONE PARALLAX
			   SET screensToScroll 
				     & screensScrollSpeed
		*/	
		var screensToScroll = scrollingScreens[m][0].screensToScroll
		var screensScrollSpeed = scrollingScreens[m][0].screensScrollSpeed
    add_stage_parallax({screensToScroll:screensToScroll,screensScrollSpeed:screensScrollSpeed})
    
		// REMOVE THE FIRST ITEM 
		// ({screensToScroll:screensToScroll,screensScrollSpeed:screensScrollSpeed})
		// FROM scrollingScreens[m]
		scrollingScreens[m].splice(0,1)
			/* 
				ADD AS MANY SCREENS CONTAINERS TO PARALLAX 
        AS THERE ARE ITEMS IN scrollingScreens[m]
					 SET screensToScroll 
							 & screensScrollSpeed
			*/	
			for ( var n = 0; n < scrollingScreens[m].length;n++ ){

        var parallax = 
				$('.parallax:last')
				var parallaxObject =
					{
						parallax: parallax,
						spriteName: scrollingScreens[m][n].spriteName,
						drawOnCanvas: scrollingScreens[m][n].drawOnCanvas,
						loop: scrollingScreens[m][n].loop
					}  

				addScreenToParallax( parallaxObject )
			}
  }  
}
	
	
	$(document)
	.delegate('#updateStageScrollingScreensBtn','mouseup',function(e){
		e.preventDefault()

		// POPULATE scrollingScreens[]
		populateScrollingScreensArray()
	})
	
	
	$(document)
	.delegate('#noScrollingBtn','mouseup',function(e){
		e.preventDefault()
		$('#scrollingScreens').val('[]')
		$('#scrollingsContainerList').html(null)
	})
	
	
/*
	STAGES EDITOR OBJECTIVES FUNCTIONS -- begin
*/


/*
   div#objectivesContainer 
      ul#objectivesContainerList
          li.objective
          li.objective
          ...
            
*/

function generate_stage_objective_UI(){
  // REMOVE EXISTING ELEMENTS IN THE DOM
  $('#objectivesContainer').remove()
  $('#objectivesContainerList').remove()
  // ADD objectivesContainer TO DOM
  $('<div/>')
  .attr('id','objectivesContainer')
  .addClass('halfPanelStyle')
  .appendTo('#stage_preview_container')

  var objectivesContainer = $('#objectivesContainer')

  // ADD objectivesContainerList TO #objectivesContainer
  var objectivesContainerList =
  $('<ul/>')
  .attr('id','objectivesContainerList')
  .appendTo('#objectivesContainer')
   
  $('#objectivesContainerList')
	.sortable({       
	   cursor: "grab",
	   handle: '.objectiveHeader',
	   stop: function(){
		   // refresh header title
		   $('.objectiveHeader')
		   .each(function(i,e){
			   $(this).find('.title').html('&nbsp;objective&nbsp;'+(parseInt(i)+1))
		   })
	   }
	})
	
	return true
}

/*
"objectives" : [
		{
			"name": "destroyBW",
			"value": true,
			"description": "Destroy all the bricks", 
			"messageSuccess": "All bricks destroyed", 
			"messageFailure": "Some bricks still remain" 
		},
		{
			"name": "minCombos",
			"value": 5,
			"description": "Do 50 combos or more",
			"messageSuccess": "50 combos done", 
			"messageFailure": "Not enough combos"
		},	
		{
			"name": "timer",
			"value": 600, 
			"description": "Complete the stage in 60 seconds",
			"messageSuccess": "Stage completed within 60 seconds",
			"messageFailure": "Time out"
		},
		{
			"name": "targets",
			"value": [
				{
					"name": "runningeye.ent",
					"count": 2			
				},
				{
					"name": "starbucks2.ent",
					"count": 2			
				}
			],
			"description": "Terminate 2 running eyes & 2 starbucks",
			"messageSuccess": "Targets terminated",
			"messageFailure": "Targets not terminated"
		}
	]
  */

/*
function generate_stage_objective_UI(){
  // REMOVE EXISTING ELEMENTS IN THE DOM
  $('#objectivesContainer').remove()
  $('#objectivesContainerList').remove()
  // ADD objectivesContainer TO DOM
  $('<div/>')
  .attr('id','objectivesContainer')
  .addClass('halfPanelStyle')
  .appendTo('#stage_preview_container')

  var objectivesContainer = $('#objectivesContainer')

  // ADD objectivesContainerList TO #objectivesContainer
  var objectivesContainerList =
  $('<ul/>')
  .attr('id','objectivesContainerList')
  .appendTo('#objectivesContainer')
}*/



// ADD AN OBJECTIVE
/*
  ADD .objective
        .removeObjetiveBtn 
*/
window.add_stage_objective = function(){
	
  var paramsObject;
   
  if( arguments.length > 0){
	  paramsObject = arguments[0]
  }
  
  if( typeof paramsObject !== 'undefined'  ){	 
    	 
  }
  
  var containerId = 'container'+Date.now()
   
  $('<li/>')
  .attr('id',containerId)
  .addClass('objective')
  .appendTo('#objectivesContainerList')
  
  var objective = 
  $('#objectivesContainerList>li.objective:last')
  
  // ADD header title + removeParallaxBtn TO .objective .objectiveHeader  
  var headerHTML =   
  '<a href="#" class="removeObjectiveBtn">&times;</a>'
  +'<span class="title">'
  +'&nbsp;objective&nbsp;'+$('#objectivesContainerList>li.objective').length
  +'</span>'
   
  $('<span/>')
  .addClass('objectiveHeader')
  .html(headerHTML)
  .appendTo(objective)
  
  
  // GET a.removeParallaxBtn
  removeObjectiveBtn = 
  objective
  .find('.removeObjectiveBtn')  
  
  removeObjectiveBtn
  .on('click',function(){
    $(this).off('click')
    $(this)
    .parents('.objective').remove()
  })
  
  
  // CONTAINS FORM FIELDS
  $('<div/>')
  .addClass('objectiveFeaturesContainer') //screensContainer
  .appendTo(objective)
  
  objective.find('.objectiveFeaturesContainer:last')  
  .append('<span class="objectiveTypeContainer"></span>')
  
  var container = $('#'+containerId)//.find('.objectiveTypeContainer')
  
   /*
      "NAME"  
      ADD objective type select menu TO .objective
   */
   var paramsObject =
        {
          id: 'objectiveTypeId'+Date.now(), // element id attribute
          name: 'name', // element name attribute
          selectedValue: 'destroyBW', // option selected by default          
          target:  container.find('.objectiveTypeContainer'),// jqueryObject CONTAINER | OR REFERENCE TO INSERT DROPDOWN AFTER | OR TO REPLACEWITH
          injectMethod: 'appendTo',// appendTo | insertBefore | insertAfter | replaceWith,
          lbl: 'objective type', // element's label text         
		      optionsCollection : objectivesOptions
        }   
   var selectMenu = generateDropDown(paramsObject)
   
   /* 
    INIT THE DROPDOWN TO 'destroyBW' BY DEFAULT
  */
   if( selectMenu ){
      //$('#'+paramsObject.id)
        selectMenu.on( "selectmenuchange", function( event, ui ) {
       // GENERAT INPUTs PERTAINING NAME OF SELECTED OPTION (destroyBW, timer, minCombos< targets) 
       generateObjectiveInputs(ui.item.value, container)
          console.clear()
          console.log('containerId:'+container.attr('id'))
      });
     
     generateObjectiveInputs('destroyBW', container)
   }
    
  
}


/*
  function generateObjectiveInputs( name, container )
  DOES
      CREATE INPUT PERTAINING THE name OF ITS TYPE (destroyBW | minCombos | timer | targets)
  
*/
window.generateObjectiveInputs = function(name, container){  
    // REMOVE ALL BUT THE OBJECTIVE TYPE SELECTOR		
  var containerId = container.attr('id')  
  $( '#'+containerId+' .objectiveFeaturesContainer > :not(.objectiveTypeContainer)').remove()
  $( '#'+containerId+' .objectiveFeaturesContainer > input[type="text"]').remove()
    
  /*
         fieldParams.name
         fieldParams.value // field default value
         fieldParams.description // field description default text
         fieldParams.messageSuccess // field messageSuccess default text
         fieldParams.messageFailure // field messageFailure default text
    */
  
  let fields = ['description','messageSuccess','messageFailure']  
    // GET THIS SELECTED OPTION's FIELD PARAMS
    let fieldParams = Array.prototype.filter.call( objectivesOptions, function(item){     
      return item.name == name
    })  
    /*
    console.clear()
    console.log('fieldParams:\r\n')
    console.log(JSON.stringify(fieldParams))*/
   // alert(fieldParams[0].messageSuccess+' '+fieldParams[0]['description'])
   
   /*
      ADD THE INPUT THAT WILL GENERATE THE VALUE 
   */
   let input, id = name+Date.now()
   
   var label = 
    $('<label/>')
   .attr('for',id)     
   .text(name)
   
   switch( fieldParams[0].input ){
     case 'spinner':         
       input = $('<input/>').attr('type','text')
     break;
     case 'text':         
       input = $('<input/>').attr('type','text')
     break;
     case 'textarea':         
       input = $('<textarea></textarea>')
     break;
   }   
    
   input
     .attr('id',id)
     .attr('name',name)
     .val(fieldParams[0].value)   
    
    container
    .find('.objectiveFeaturesContainer')
    .append( label )
    
    // APPEND INPUT TO .objectiveFeaturesContainer
    container
    .find('.objectiveFeaturesContainer')
    .append( input )
      
       if( fieldParams[0].input == 'spinner' )
      {
       /*  
          timer add a 10th second time converted label before the spinner
         
        if( name == 'timer'){
         input.spinner({
               spin:function(event, ui){

                 $('label[for="'+id+'"]')
                 .find('.seconds')
                 .remove()

                 var seconds =  ui.value/10
                 //console.log('ui.value/10:'+ui.value/10+' '+seconds)
                 seconds += '&nbsp;sec'

                 var Seconds = 
                 $('<span/>')
                 .html(seconds)
                 .addClass('seconds')

                 $('label[for="'+id+'"]')
                 .append(Seconds)

               }
         })
        }
        else{
          input.spinner()
        }
          */
        if( name=='timer' ){
           var Seconds = 
             $('<span/>')
             .html(' seconds | -1 : no timer')
             .addClass('seconds')

             $('label[for="'+id+'"]')
             .append(Seconds)
        }
        input.spinner()
      }
  
     if( name == 'targets'){
       
       // create the targets container
       $('<ul/>')
       .attr('id','objectiveTargets')
       .insertAfter('#'+id) 
       
        // CREATE [ + target] & [ x remove all]
        createAddObjectivesTargetControls( id, name )
     }
	 
	 
	 if( name == 'escortees'){
       
       // create the escortees container
       $('<ul/>')
       .attr('id','objectiveEscortees')
       .insertAfter('#'+id) 
       
        // CREATE [ + escortees] & [ x remove all]
        createAddObjectivesTargetControls( id, name )
     }
    /*
      ADD description, messageSuccess, messageFailure
      TO objective           
   */
    Array.prototype.some.call(fields, function( fieldName ){
        let lbl,
            taId = fieldName+Date.now(),   
            label = 
        $('<label/>')
       .attr('for',taId)     
       .text(fieldName)
    
        switch( fieldName ){
          case 'description':         
            lbl = fieldParams[0].description
          break;
          case 'messageSuccess':         
            lbl = fieldParams[0].messageSuccess
          break;
            case 'messageFailure':         
            lbl = fieldParams[0].messageFailure
          break;
        } 
        container
        .find('.objectiveFeaturesContainer')
        .append( label )
      
        input = 
        $('<textarea></textarea>')
        .attr('id',taId)
        .attr('name',fieldName)
        .val(lbl)    
        // APPEND INPUT TO .objectiveFeaturesContainer
        container
        .find('.objectiveFeaturesContainer')
        .append( input )
    })  
}

/*
function createAddObjectivesTargetControls( id ){
   var html = 
      '<a href="#" class="addTarget">target</a>'
  +'<br/>'
  +'<a href="#" class="removeTargets">remove all</a>'

  var objectiveTargetControls = 
      $('<div/>')
  .addClass('objectiveTargetControls') 
  .html(html)

  $('label[for="'+id+'"]')
    .append(objectiveTargetControls)

  $('label[for="'+id+'"] .addTarget').button({
    icon:'ui-icon-plus',
    position:'end'
  })
  $('label[for="'+id+'"] .removeTargets').button({
    icon:'ui-icon-close',
    position:'end'
  })
}  
  
function addOneObjectiveTarget(){ 
  
  var targetName = '',
	  countVal = 0
  
  if(arguments.length > 0){
	  targetName = arguments[0].targetName
	  countVal = arguments[0].countVal
  }
    
  $('<li/>')              
    .addClass('objectiveTargetLi')
    .appendTo('#objectiveTargets')

  var li = $('#objectiveTargets li.objectiveTargetLi:last')

  // ADD targetInput THAT WILL RECEIVE THE TARGET ENTITY NAME
  // FROM '#targetSelector'+id+Date.now()
  var objectiveTarget = 'objectiveTarget'+Date.now()
  $('<input/>')
    .attr('type','text')
    .attr('name','target')
    .data('selectorId',objectiveTarget) // 'targetSelector'+Date.now() 
    .addClass('selectTargetEntity')
    .attr('id',objectiveTarget)
	.val(targetName)
    .appendTo(li)
      
  var targetInput = $('#'+objectiveTarget)
    
  var objectiveTargetCount = 'objectiveTargetCount'+Date.now()
  
  // ADD THE count SPINNER
  $('<input/>')
  .attr('id',objectiveTargetCount)
  .attr('name','count')  
  .val(countVal) 
  .appendTo(li)
    
  $('#'+objectiveTargetCount) 
  .spinner({
    stop:function(){
        populateObjectiveTargetsTextarea()
    },
    change:function(){
        populateObjectiveTargetsTextarea()
    }
  })
  
  $('<a/>')
  .attr('href','#')
  .text('delete')
  .addClass('removeTarget')
  .appendTo(li)
  
   var removeTarget =
   li.find('.removeTarget')
   .button({
     icon:'ui-icon-trash',
     position:'end'
   })
}



	function populateObjectiveTargetsTextarea()
	DOES:
					POPULATE textarea[name="targets"]
					WITH JSON ARRAY OF OBJECTS 
				[
					{
						"name":"enitytName.ent",
						"count": N
					},...
				]

USAGE: populateObjectiveTargetsTextarea()

function populateObjectiveTargetsTextarea(){
  var targetsTextarea = $('textarea[name="targets"]')
  let tgtArr = []
	$('.objectiveTargetLi').each(function(i,e){
    var targetItem = {}
		targetItem.name = $(this).find('.selectTargetEntity').val()
		targetItem.count = $(this).find('input[name="count"]').val()
		tgtArr[tgtArr.length] = targetItem
	})
	targetsTextarea.val(JSON.stringify(tgtArr))	
}
*/











/*
	function createAddObjectivesTargetControls( id, name )

	PARAMS:
	id = name+Date.now()
	name = targets | escortees
	
	create controls for adding/removing 
	objectives targets OR escortees
	
*/
function createAddObjectivesTargetControls( id, name ){
		
  let addBtnClass = (name == 'targets')?'addTarget':'addEscortee',
	  remBtnClass = (name == 'targets')?'removeTargets':'removeEscortees',
	  objectiveControls = (name == 'targets')?'objectiveTargetControls':'objectiveEscorteesControls',
	  lbl = (name == 'targets')?'target':'escortee'
	
  var html = 
		'<a href="#" class="'+addBtnClass+'">'+lbl+'</a>'
		+'<br/>'
		+'<a href="#" class="'+remBtnClass+'">remove all</a>'

  var objectiveControlsElem = 
      $('<div/>')
	  .addClass(objectiveControls)// 'objectiveTargetControls'
	  .html(html)

	  $('label[for="'+id+'"]')
	  .append(objectiveControlsElem)

	  $('label[for="'+id+'"] .'+addBtnClass).button({
		icon:'ui-icon-plus',
		position:'end'
	  })
	  $('label[for="'+id+'"] .'+remBtnClass).button({
		icon:'ui-icon-close',
		position:'end'
	  })
}  
  
  
  
/*
	function addOneObjectiveTarget(objectiveType)
	
	DOES:  
		ADDS A PARAMETRABLE FIELD THAT DEFINES AN OBJECTIVE
		THAT IS OF TYPE 'escortee' OR 'target'
	
	PARAMS:
		paramsObject.objectiveType - string: 'target' | 'escortee'
		paramsObject.targetName : - string: entityName
		paramsObject.countVal: - number: how many instances to be killed or 
								         to collide with target to fulfill objective
*/  
function addOneObjectiveTarget(paramsObject){ 
  
  let targetName = '',
	  countVal = 0,
	  objectiveType = paramsObject.objectiveType
	  
  /* 
	IN CASE THE FIELD IS POPULATED (LOADING AN EXISTING STAGE) 
	targetName & countVal ARE USED BY targets and escortees
  */
	  if(
		typeof paramsObject.targetName !== undefined
		&& typeof paramsObject.countVal !== undefined
	  ){
		  targetName = paramsObject.targetName
		  countVal = paramsObject.countVal
	  }
   
  let Class = ( objectiveType == 'target' )?'objectiveTargetLi':'objectiveEscorteeLi',
	  Id = ( objectiveType == 'target' )?'objectiveTargets':'objectiveEscortees'	  
   
  $('<li/>')              
    .addClass(Class)
    .appendTo('#'+Id)

  let li = $('#'+Id+' li.'+Class+':last')

  // ADD targetInput THAT WILL RECEIVE THE TARGET ENTITY NAME
  // FROM '#targetSelector'+id+Date.now()
  let objectiveTarget = 
  ( objectiveType == 'target' )
  ?
  'objectiveTarget'+Date.now()
  :
  'objectiveEscortee'+Date.now()
  
  $('<input/>')
    .attr('type','text')
    .attr('name',objectiveType)
    .data('selectorId',objectiveTarget) // 'targetSelector'+Date.now() 
    .addClass('selectTargetEntity')// TO BE CHANGED OR NOT ?
    .attr('id',objectiveTarget)
	.val(targetName)
    .appendTo(li)
  
  // ADD ICON FOR CLARITY
  var TgtE = li.find('.selectTargetEntity')
  $('<span class="ui-icon ui-icon-circle-triangle-e" style="pointer-events: none;left: 1.5em;"></span>')
  .insertBefore(TgtE)      
	  
  let targetInput = $('#'+objectiveTarget)
    
  let objectiveCount = objectiveTarget+'Count'+Date.now()
  
  // ADD THE count SPINNER
  $('<input/>')
  .attr('id',objectiveCount)
  .attr('name','count')  
  .val(countVal) 
  .appendTo(li)
    
  $('#'+objectiveCount) 
  .spinner({
    stop:function(){
        populateObjectiveTargetsTextarea(objectiveType+'s')
    },
    change:function(){
        populateObjectiveTargetsTextarea(objectiveType+'s')
    }
  })
  
  $('<a/>')
  .attr('href','#')
  .text('delete')
  .addClass('remove'+objectiveType.charAt(0).toUpperCase() + objectiveType.slice(1) )
  .appendTo(li)
  
   var removeTarget =
   li.find('.remove'+objectiveType.charAt(0).toUpperCase() + objectiveType.slice(1) )
   .button({
     icon:'ui-icon-trash',
     position:'end'
   })
}


/*
	function populateObjectiveTargetsTextarea()
	DOES:
					POPULATE 
					- textarea[name="targets"]
								OR
					- textarea[name="escortees"]
					
					WITH JSON ARRAY OF OBJECTS				[
					{
						"name":"entitytName.ent",
						"count": N
					},...
				]

USAGE: populateObjectiveTargetsTextarea()
*/
function populateObjectiveTargetsTextarea(objectiveType){
   	
  let objectiveLiClass = (objectiveType == 'targets')?'.objectiveTargetLi':'.objectiveEscorteeLi' 
	
  var targetsTextarea = $('textarea[name="'+objectiveType+'"]')
  let tgtArr = []
  
	$( objectiveLiClass ).each(function(i,e){
		
    var targetItem = {}
		targetItem.name = $(this).find('.selectTargetEntity').val()
		targetItem.count = $(this).find('input[name="count"]').val()
		tgtArr[tgtArr.length] = targetItem
	})
	
	targetsTextarea.val(JSON.stringify(tgtArr))	
}



/*
	 POPULATE STAGES EDITOR textarea#objectives FROM EDITORS FIELDS

   USAGE : populateObjectivesTextarea()
*/
function populateObjectivesTextarea(){

	var objectiveItem = {}
  var objectives = []

	$('li.objective')
  .each(function(i,e){
		objectiveItem = {}
		// CLEAN UP THE NAME BEFORE USING IT AS A JSON ATTRIBUTE
		var name = $(this).find('label:eq(0)').text()
		var nameArr = name.split(' ')
		
		name = (nameArr.length > 0)?nameArr[0]:name
		objectiveItem.name = name
    switch(name){
			case 'destroyBW':
				objectiveItem.value = $(this).find('input[name="destroyBW"]').val() 				
			break;
			case 'targets':
				populateObjectiveTargetsTextarea()
				objectiveItem.value = $('textarea[name="targets"]').val()				
			break;
			case 'escortees':
				populateObjectiveTargetsTextarea()
				objectiveItem.value = $('textarea[name="escortees"]').val()				
			break;
			case 'timer':				
				objectiveItem.value = $('input[name="timer"]').val() 				
			break;
			case 'minCombos':
				objectiveItem.value = $(this).find('input[name="minCombos"]').val() 				
			break;
		} 		 
		objectiveItem.description = $(this).find('textarea[name="description"]') .val()
		objectiveItem.messageSuccess = $(this).find('textarea[name="messageSuccess"]') .val()    
		objectiveItem.messageFailure = $(this).find('textarea[name="messageFailure"]') .val()  
		objectives[objectives.length] = objectiveItem
	})
	
	console.log('objectives')
	console.log(objectives)
 $('textarea#objectives').val(JSON.stringify(objectives))
 /*
 let jsonStr = JSON.parse(objectives) 
 $('textarea#objectives').val(JSON.stringify(jsonStr))
 */
 
 //$('#objectives').val(JSON.stringify(json.objectives))
 
 
}




$(document)
 .delegate('.selectTargetEntity','mouseup',function(e){
  e.preventDefault()

var selectorId  = 'selector' + $(this).data('selectorId'),
    inputId = $(this).data('selectorId')
  
// CREATE ENTITY SELECTOR
  var paramsObject = {
    selectorId: selectorId,//'targetSelector'+Date.now()
    target: $(this),
    injectMethod: 'insertAfter',
    contentPath: './entities_editor/ #entities_list_container .entities_list'
  }
  generateAssetSelector( paramsObject )
  
  /*
	var paramsObject = {
		selectorId: 'entities_paths_selector',
		target: $('#entity_path'),
		injectMethod: 'insertAfter',
		contentPath: './paths_editor/ #paths_list_container .paths_list',
		title: 'select a path for the entity',
		searchFormId : 'entityFilterPaths'
	}
	generateAssetSelector( paramsObject )
  */
  
  $(document)
  .delegate('#'+selectorId+' .select_entity','click',function(e){
      e.preventDefault()  
 
      var img = $(this).find('img')      
      var tmbContainer = 
          $('<span/>')
          .addClass('objectiveTmbContainer')
          .append(img)

      $('#'+inputId)
        .val(img.attr('title'))

      $('#'+inputId)
      .parents('li')
      .prepend(tmbContainer)
      
      // REFRESH targets json
      populateObjectiveTargetsTextarea()

      $(document)
      .undelegate('#'+selectorId+' .select_entity', "click")    

      $('#'+selectorId)
      .dialog('destroy')
      .remove()

      $(document).dialogfullmode();// RE-INIT FULLSCREEN BTN

  })//delegate
  
})// delegate

$(document)
 .delegate('#updateStageObjectivesBtn','mouseup',function(e){
  //e.preventDefault()
 
	 populateObjectivesTextarea()
		
})
 
/*
	STAGES EDITOR: 
		OBJECTIVES EDITION
		POPULATE OBJECTIVES EDITOR FROM stage.json' s textarea#objectives
*/
function populateObjectivesFromStageJson(){

  $('li.objective').remove()
  
	objectives = []
 
  objectives = JSON.parse($('#objectives').val())
  var idx = 0
  Array.prototype.some.call(objectives, function(objective){    
    console.log(objective)         
    /*
		  ADD ONE OBJECTIVE			   
	  */	
		add_stage_objective()    
    
    // SELECT THE TYPE SELECTOR    
    var selectorID = 
    $('li.objective')
    .eq(idx)
    .find('.objectiveTypeContainer select')
    .eq(0)
    .attr('id')
    
    var objectiveID = 
    $('li.objective')
    .eq(idx)    
    .attr('id')
    
    // GENERATE THE OBJECTIVE FORM PERTAINING THE TYPE OF OBJECTIVE SELECTED
    var container = $('#'+objectiveID)
    generateObjectiveInputs ( objective.name, container )
    
    // SELECT THE TYPE SELECTOR    
    $('#'+selectorID).val(objective.name);
    $('#'+selectorID).selectmenu("refresh");    
    
    /*
        POPULATE TEXTAREAS description, messageSuccess, messageFailure
    */
    $('li.objective')
    .eq(idx)
    .find('textarea[name="description"]')
    .val( objective.description )
    
    $('li.objective')
    .eq(idx)
    .find('textarea[name="messageSuccess"]')
    .val( objective.messageSuccess )
    
    $('li.objective')
    .eq(idx)
    .find('textarea[name="messageFailure"]')
    .val( objective.messageFailure )
    
    switch( objective.name){
      case 'timer':
        $('li.objective')
        .eq(idx)
        .find('input[name="timer"]')
        .val( objective.value )
      break;
      case 'minCombos':
         $('li.objective')
        .eq(idx)
        .find('input[name="minCombos"]')
        .val( objective.value )
      break;
      case 'targets':
        Array.prototype.some.call(objective.value, function(target){   
          addOneObjectiveTarget({objectiveType :'target',targetName : target.name, countVal : target.count})          
          var imgSrc = destination_dir.entities+'/'+target.name+'.png'
          var img = 
              $('<img/>')
              .attr('src',imgSrc)
          var tmbContainer = 
              $('<span/>')
              .addClass('objectiveTmbContainer')
              .append(img)          
          $('li.objective')
          .eq(idx)         
          .find('li.objectiveTargetLi:last')
          .prepend(tmbContainer)
        })// end  Array.prototype.some.call(objective.value, function(target){ 
        
        populateObjectiveTargetsTextarea(objective.name)
      break;
	  case 'escortees':
        Array.prototype.some.call(objective.value, function(target){   
          addOneObjectiveTarget({objectiveType : 'escortee' ,targetName : target.name, countVal : target.count})          
          var imgSrc = destination_dir.entities+'/'+target.name+'.png'
          var img = 
              $('<img/>')
              .attr('src',imgSrc)
          var tmbContainer = 
              $('<span/>')
              .addClass('objectiveTmbContainer')
              .append(img)          
          $('li.objective')
          .eq(idx)         
          .find('li.objectiveEscorteeLi:last')
          .prepend(tmbContainer)
        })// end  Array.prototype.some.call(objective.value, function(target){ 
        
        populateObjectiveTargetsTextarea(objective.name)
      break;        
	  
    }
    
   idx++
  }) 
}

/*  OBJECTIVE TARGETS -- begin  */
$(document)
 .delegate('.addTarget','mouseup',function(e){
  e.preventDefault()
	 addOneObjectiveTarget({objectiveType:'target'}) 
})

$(document)
 .delegate('.removeTarget','mouseup',function(e){
 //e.preventDefault()
   
   // REFRESH targets json
   populateObjectiveTargetsTextarea('targets')
   
   let titleName =
   $(this)
  .parent()
  .find('.objectiveTmbContainer img')//img
  .attr('title')
    
   let cont = $(this)
  .parents('.objective')
  .find('span.objectiveTmbContainer img[title="'+titleName+'"]')
  
   cont.parent().remove()   
   
  $(this).parents('.objectiveTargetLi').remove() 
   
})  

$(document)
 .delegate('.removeTargets','mouseup',function(e){
 //e.preventDefault()
	
   // REFRESH targets json
   populateObjectiveTargetsTextarea('targets')
    
 $(this)
  .parents('.objective') 
  .find('.objectiveTmbContainer')
  .remove()  
   
  $(this).parents('.objectiveTargetLi').remove() 
   
  $('.objectiveTargetLi').remove()
})  
/*  OBJECTIVE TARGETS -- end  */

/*  OBJECTIVE ESCORTEES -- begin  */
$(document)
 .delegate('.addEscortee','mouseup',function(e){
  e.preventDefault()
	 addOneObjectiveTarget({objectiveType:'escortee'}) 
})

$(document)
 .delegate('.removeEscortee','mouseup',function(e){
 //e.preventDefault()
	
   // REFRESH targets json
   populateObjectiveTargetsTextarea('escortees')
   
    let titleName =
   $(this)
  .parent()
  .find('.objectiveTmbContainer img')//img
  .attr('title')
    
   let cont = $(this)
  .parents('.objective')
  .find('span.objectiveTmbContainer img[title="'+titleName+'"]')
  
   cont.parent().remove()   
   
   $(this).parents('.objectiveEscorteeLi').remove()
   
})  

$(document)
 .delegate('.removeEscortees','mouseup',function(e){
 //e.preventDefault()
	
   // REFRESH targets json
   populateObjectiveTargetsTextarea('escortees')
   
   $(this)
  .parents('.objective') 
  .find('.objectiveTmbContainer')
  .remove()  
   
    $('.objectiveEscorteeLi').remove()
   
})  
/*  OBJECTIVE TARGETS -- end  */




$(document)
.delegate('#addObjectiveBtn','mouseup',function(e){
  e.preventDefault()
	add_stage_objective()	
})

$(document)
  .delegate('#noObjectiveBtn','mouseup',function(e){
  e.preventDefault()
  $('#objectives').val('[]')
  $('#objectivesContainerList').html(null)
})

/*
	STAGES EDITOR OBJECTIVES FUNCTIONS -- end
*/


/*

	STAGES EDITOR
		BGM FUNCTIONS -- begin

*/

/*
  STAGES EDITOR:
	  WHEN CLICK ON #stage_music:
		CREATE BGM SELECTOR
*/
$(document)
.delegate('#stage_music','click',function(e) {
  e.preventDefault()  
  loader()
  var paramsObject = {
			selectorId: 'stage_BGM_selector',
			target: $('#stage_music'),
			injectMethod: 'insertAfter',      
			contentPath: './sounds_editor/ #sounds_list_container .sounds_list' ,
			title: 'select a music for the stage',
			
		}
  generateAssetSelector( paramsObject )	
  
})

function decorateBGMControls(){
	
	$('.play_bgm:not(.ui-widget)')
	.button({
		 icon:'ui-icon-play',
		 position:'end'
	})

	$('.stop_bgm:not(.ui-widget)')
	.button({
		 icon:'ui-icon-stop',
		 position:'end'
	})

	$('.select_bgm:not(.ui-widget)')
	.button({
		 icon:'	ui-icon-circle-check',
		 position:'end'
	})
	
	
	
	
	
}


/*
  STAGES EDITOR:
	   LISTEN TO A BGM FROM THE BGM SELECTOR
*/
$(document).delegate('.play_bgm','click',function(e){
	e.preventDefault()	
	var audioId = $(this).attr('href')
	$('#'+audioId)
	.get(0).play();
})

/*
  STAGES EDITOR:
	   STOP BGM PLAYING FROM THE BGM SELECTOR
*/
$(document).delegate('.stop_bgm','click',function(e){
	e.preventDefault()
	var audioId = $(this).attr('href')
	$('#'+audioId)
	.get(0)
	.pause()
	
	
	console.log($('#'+audioId).get(0))
	
	//.currentTime = 0; // Reset time;
})
/*
  STAGES EDITOR:
	   SELECT A BGM FOR THE STAGE
*/
$(document).delegate('.select_bgm','mouseup',function(e){
	//e.preventDefault()	
	var audioIdArr = $(this).attr('href').split('?')
	var audioId = audioIdArr[0]
	//$('#stage_music').val(audioId).trigger( "change" ) 	
	//document.getElementById("stage_music").setAttribute("value",audioId);
	document.querySelector("#stage_music").value = audioId;
	
	document.getElementById("stage_music").dispatchEvent(new Event('change'))
	
	$('label[for="stage_music"] a')
	.remove()
	
	$('label[for="stage_music"] audio')
	.remove()
	
	$('label[for="stage_music"]')
	.append($(this).parent().find('audio'))
	
	$('label[for="stage_music"]')
	.append($(this).parent().find('.play_bgm'))
	
	$('label[for="stage_music"]')
	.append($(this).parent().find('.stop_bgm'))
	
	// CLOSE DILAOG, IS DESTROYED ON CLOSE
	 $('#stage_BGM_selector').dialog('close')
			
		
	//$('#stage_music').attr('value',audioId).trigger( "change" )
	
	//document.querySelector('#stage_music').value = audioId
})

$(document).delegate('#reset_stages_form', 'click', function(e) {
	e.preventDefault()
	$('#stg_ed_frm *:not(input[type="submit"]):not(input[type="reset"])').val(null)
	$('#objectivesContainerList,#stage_preview,#ec_list,#scrollingsContainerList').html(null)
	$('#stg_ed_frm input.destination_dir').val( destination_dir.stages)	
	entityCannons = []	
	objectives = []
})

$(document).delegate('#reset_paths_form', 'click', function(e) {
	e.preventDefault()
	$('#path_ed_frm *:not(input[type="submit"]):not(input[type="reset"])').val(null)
	$('#points_list,#path_edit').html(null)
	$('#path_ed_frm input.destination_dir').val( destination_dir.paths)	
})

$(document).delegate('#reset_brickwall_ed_frm', 'mouseup', function(e) {
	e.preventDefault()	
	$('#brickwall_ed_frm *:not(input[type="submit"]):not(input[type="button"])').val(null)
	if( initBWEditor() == true){
		setTimeout($('#brickwall_ed_frm input.destination_dir').val( destination_dir.brickwalls),1000)	
	}
})

/*

	STAGES EDITOR
		BGM FUNCTIONS -- end

*/

/*
	SEARCH FORM FUNCTION -- begin
*/

$(document).delegate('.filter','keyup',function(e){ 
	var source, // css path
	  container,
	  cont;  // jQuery SELECTOR OBJECT	
	  
	var keywordsArr = $(this).val().split(' ')
	var keywords = keywordsArr.join(',')	  
	var filterInputParent = $(this).parent().parent().attr('id')	  
	if( keywordsArr.length < 2){return} 
	
	loader()
	
	var removeDeleteBtn = false; // REMOVE THE LAST WITHIN LOADED LIs , i.e. deleteBtn, e.g.: .delete_stage
	
	
	switch( filterInputParent ){
      case "BW-ed-tabs-1":
			// BRICKWALLS EDITOR: images
			container =  $('#images_list_container, #BW_images_list_container')
			source = './sprites_editor/ #images_list_container .images_list'
      break;
	  case "BW-ed-tabs-4":
			// BRICKWALLS EDITOR: brickwwalls
			container =  $('#BW_brickwalls_list_container')
			source = './brickwalls_editor/ #BW_brickwalls_list_container'
      break
      case "cv-ed-tabs-1":
			// PATHS EDITOR -- not working
			container =  $('#paths_list_container .paths_list')
			source = './paths_editor/ #paths_list_container .paths_list'
      break
	  case "entityFilterPaths"://searchFormId
			// ENTITIES EDITOR: paths
			container =  $('#entities_paths_selector .paths_list')
			source = './paths_editor/ #paths_list_container .paths_list'
			removeDeleteBtn = true
      break
	  case "stageFilterBrickwalls"://searchFormId
			// STAGES EDITOR: brickwalls
			container =  $('#stage_brickwall_name_selector .brickwalls_list')
			source = './brickwalls_editor/ #BW_brickwalls_list_container .brickwalls_list'
			removeDeleteBtn = true
      break
	  case "stageFilterBrickwallsPaths"://searchFormId
			// STAGES EDITOR: paths
			container =  $('#stage_BW_path_selector .paths_list')
			source = './paths_editor/ #paths_list_container .paths_list'
			removeDeleteBtn = true
      break
	  case "stageFilterPaths"://searchFormId
			// STAGES EDITOR: paths
			container =  $('#stages_paths_selector .paths_list')
			source = './paths_editor/ #paths_list_container .paths_list'
			removeDeleteBtn = true
      break
	  case "stageFilterEntities"://searchFormId	 
			// STAGES EDITOR: entities
			
			container =  $('#stages_entities_list_container .entities_list')
			if( typeof tIfrm != 'undefined' ){
				if( tIfrm != null ){
					if( tIfrm.contentDocument != null ){
						if( tIfrm.contentDocument.getElementById("liveEditor") != null ){
							container =  $('#stages_entities_list_container_live .entities_list')	
							//alert('here')
						}
					}
				}
			}
			source = './entities_editor/ #entities_list_container .entities_list'
			removeDeleteBtn = true
      break	
	  case "stageFilterStateEntitySpawn"://searchFormId	 
			// STAGES EDITOR: entities
			//container =  $('#stages_entities_list_container .entities_list')
			let containerName = $('#stageFilterStateEntitySpawn').parent().attr('id')
			container =  $('#'+containerName+' .entities_list')
			source = './entities_editor/ #entities_list_container .entities_list'
			removeDeleteBtn = true
      break	
	  case "stageFilterEntitiesSpawnBalls"://searchFormId	 
			// STAGES EDITOR: entities
			container =  $('#stage_spawnBalls_selector .entities_list')
			source = './entities_editor/ #entities_list_container .entities_list'
			removeDeleteBtn = true
      break	  
      case "ent-ed-tabs-1":	 
			// ENTITIES EDITOR: entities
			container =  $('#entities_list_container .entities_list')
			source = './entities_editor/ #entities_list_container .entities_list'
      break	  
	  case "entityFilterSprites"://searchFormId
			// ENTITIES EDITOR: entities
			container =  $('#sprites_list_container')
			source = './sprites_editor/ #sprites_list_container .sprites_list'
			removeDeleteBtn = true
      break
	  case "stg-ed-tabs-7":
			// STAGES EDITOR: stages
			container =  $('#stages_list_container .stages_list')
			source = './stages_editor/ #stages_list_container .stages_list'
      break
	  
      case "sprt-ed-tabs-1":
			// SPRITES EDITOR: images
			container =  $('#images_list_container .images_list')
			source = './sprites_editor/ #images_list_container .images_list'
      break
      case "sprt-ed-tabs-2":
			// SPRITES EDITOR: sprites
			container =  $('#sprites_list_container .sprites_list')
			source = './sprites_editor/ #sprites_list_container .sprites_list'
      break	  
	  case "cmp-ed-tabs-2":
			// CAMPAIGNS EDITOR: stages
			container =  $('#campaign_stages_list_container .stages_list')			
			source = './stages_editor/ #stages_list_container .stages_list'
			removeDeleteBtn = true
      break  
	  case "cmp-ed-tabs-3":
			// CAMPAIGNS EDITOR: sprites	
			container =  $('#campaign_sprites_list_container .sprites_list')
			source = './sprites_editor/ #sprites_list_container .sprites_list'
			removeDeleteBtn = true
      break 
	  case "cmp-ed-tabs-4":
			// CAMPAIGNS EDITOR: brickwalls	
			container =  $('#campaign_brickwalls_list_container .brickwalls_list')
			source = './brickwalls_editor/ #BW_brickwalls_list_container .brickwalls_list'
			removeDeleteBtn = true
      break 
	  case "cmp-ed-tabs-5":
			// CAMPAIGNS EDITOR: entities
			container =  $('#campaign_entities_list_container .entities_list')
			source = './entities_editor/ #entities_list_container .entities_list'
			removeDeleteBtn = true
      break 
	 case "cmp-ed-tabs-6":
			// CAMPAIGNS EDITOR: paths
			container =  $('#campaign_paths_list_container .paths_list')
			source = './paths_editor/ #paths_list_container .paths_list'
			removeDeleteBtn = true
      break 
	  case "cmp-ed-tabs-7":
			// CAMPAIGNS EDITOR: sounds
			$('#campaign_sounds_list_container .sounds_list').empty()
			container =  $('#campaign_sounds_list_container .sounds_list:not(.assetsList)')
			source = './sounds_editor/ #sounds_list_container .sounds_list'
			removeDeleteBtn = false
      break
	  case "cmp-ed-tabs-8":
			// CAMPAIGNS EDITOR: campaigns
			container =  $('#campaigns_list_container .campaigns_list')
			source = './campaigns_editor/ #campaigns_list_container .campaigns_list'			
      break 
	  /* case "stage_BGM_selector":
			// STAGES EDITOR: BGM
			container =  $('#campaigns_list_container .campaigns_list')
			source = './campaigns_editor/ #campaigns_list_container .campaigns_list'			
      break */
	  default:
	  
			/*
				USED FOR DYNAMICALY GENERATED SEARCH FORMS
			*/			
			cont = $(this).parent().parent().parent().attr('id')			
									
			// stages_editor > add BGM 
			if( cont.indexOf('stage_BGM_selector') != -1){
				container =  $('#'+cont+' .sounds_list')				
				source = './sounds_editor/ #sounds_list_container .sounds_list'	
			}
			/*			
			if( $(this).parent().parent().attr('id') == 'cmp-ed-tabs-7'){	
				alert('here')
				container =  $('#'+cont+' .sounds_list:not(.assetsList)')			
				source = './sounds_editor/ #sounds_list_container .sounds_list'									
			}	
			*/
						
			// stages_editor > add objective .selectTargetEntity
			if( cont.indexOf('selectorobjectiveEscortee') != -1){
				container =  $('#'+cont+' .entities_list')				
				source = './entities_editor/ #entities_list_container .entities_list'
				removeDeleteBtn = true				
			}
			
			// stages_editor > add objective .selectTargetEntity
			if( cont.indexOf('selectorobjectiveTarget') != -1){
				container =  $('#'+cont+' .entities_list')				
				source = './entities_editor/ #entities_list_container .entities_list'
				removeDeleteBtn = true
			}	
			
			// stages_editor > add parallax 
			if( cont.indexOf('scrolling_sprites_list_container') != -1){
				//container =  $('#'+cont+' .entities_list')				
				container =  $('#scrolling_sprites_list_container .sprites_list')
				source = './sprites_editor/ #sprites_list_container .sprites_list'
				removeDeleteBtn = true
			}	
			
			// stages_editor > BW > states > path
			if( cont.indexOf('selectorpathstateForm') != -1){
				//container =  $('#'+cont+' .entities_list')				
				container =  $('#'+cont+' .paths_list')
				source = './paths_editor/ #paths_list_container .paths_list'
				removeDeleteBtn = true
			}	
						
	  break;
    } 
		
	//console.clear()
	console.log(container)
	console.log(source)
	console.log(keywords)
	
	// LOAD THE ITEMS	 
	container.load(source ,{keywords:keywords},function(){
		
		loaderOff()
		
		$(this)
		.find('li:eq(0)')
		.unwrap()
		
		if( removeDeleteBtn == true ){
			$(this)
			.find('li')
			.each(function(){
				$(this)
				.find('a:last')
				.remove()
			})
		}		
		
		
		
		if( filterInputParent == 'cmp-ed-tabs-7'){
			
			decorateBGMControls()
			$('#cmp-ed-tabs-7 ul li a.select_bgm')
			.button( "option", "disabled", true );
		}
		
		/*
		if( cont.indexOf('stage_BGM_selector') != -1){
			decorateBGMControls()
		}
		*/
		if( typeof cont != 'undefined'){		
			if( cont.indexOf('stage_BGM_selector') != -1){
				decorateBGMControls()
			}
		}
		
		//$('ul.assetsList')
		
		
	  //dialogNotify('images list refreshed')
    })  
})

/*
	CAMPAIGNS EDITOR -- begin
*/

// EXPORT A CAMPAIGN TO A JSON FILE
	$(document).delegate('form#cmp_ed_frm', 'submit', function(event) {
	  event.preventDefault();
    loader()

    var json = $('form#cmp_ed_frm')
               .serializeObject()  
					
				console.log('submit: \r\n'+json)	
    
			  $.ajax({
				  type : "POST",
				  async: true,
				  url : "export_json_file.php",
				  data : {json:JSON.stringify(json)}
			  })
			  .done(function(response){
          loaderOff()
          console.log(response)

          var jsonObj = JSON.parse(response)

          dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
	      
		 loader()	
		  
          // REFRESH CAMPAIGNS LIST
         load_campaigns_list()
		 
		 
		 populateAssetsTable()
		 
		 
        }) 
  }) 

// LOAD CAMPAIGNS LIST
function load_campaigns_list(){
		loader()	
	  // REFRESH CAMPAIGNS LIST
	  $('#campaigns_list_container')
		.load('./campaigns_editor/ #campaigns_list_container .campaigns_list',function(){
		loaderOff()
		dialogNotify('campaigns list refreshed')
	  })
	}

/*
	function generateCampaingStagesMenuList()
	
		PARAMS: none
	
	GENERATE CAMPAIGN MENU STAGES LIST JSON
		- this file is used to generate:
		  the list of selectable stages with their name and description
*/
window.generateCampaingStagesMenuList = function(){
	  
 loader()

var json = {}

    json.destination_dir = 'game_assets/campaignStageMenus'
    json.name = 'stages-menu-select-'+$('#campaign_inputs #campaign_name').val()
   
    json.stages = []    

    $('#cmp-ed-tabs-2 .assetsList li.ui-sortable-handle')
    .each(function(idx, el){
        console.log($(this).find('.stageLbl').text()+ ' ' +$(this).find('.jsonObjectDescription').text()) 
        json.stages.push({
            name: $(this).find('.stageLbl').text(),
            description: $(this).find('.jsonObjectDescription').text()
        })  
    })

 					
console.log(json)
console.log(json.length)
	
      $.ajax({
          type : "POST",
          async: true,
          url : "export_json_file.php",
          data : {json:JSON.stringify(json)}
      })
      .done(function(response){

          loaderOff()
          console.log(response)

          var jsonObj = JSON.parse(response)

          dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)

          // REFRESH CAMPAIGNS LIST
         //load_campaigns_list()
       }) 
  } 

$(document)
.delegate('#generateCampaingStagesMenuListBtn','click',function(e){
	e.preventDefault()
	generateCampaingStagesMenuList()	
})


/*
	DELETE A STAGE
*/
$(document).delegate('#campaigns_list_container .campaigns_list a.delete_campaign', 'click', function(e) {
  e.preventDefault()
  loader()
  $.ajax({
    method: 'POST',
    url: 'deleteFile.php',
    asyn: true,
    data: {fileUrl: $(this).attr('href')}

  })
    .done(function(response){
		loaderOff()
    var jsonObj = JSON.parse(response)
    dialogNotify(jsonObj.type+':\r\n'+jsonObj.msg)
    load_campaigns_list()
  })
})


	
	/*
		LOAD A CAMPAIGN INTO THE CAMPAIGNS EDITOR -- begin
	*/
	$(document).delegate('#campaigns_list_container a.select_campaign', 'click', function(e) {
		e.preventDefault()
		
		
		// REMOVE ALL SELECTED ASSETS FROM THE EDITOR's UI
		$('div#cmp-ed-tabs form ul.assetsList li').remove()
		
		//$('#cmp-ed-tabs-7 .assetsList').empty()
		
		loader()
		
		$.getJSON( $(this).attr('href') )
		.done(function(json){  
			
		// CAMPAIGN TAB
		
		$('#campaign_name').val(json.name)	
		$('#campaign_title').val(json.title)			
		$('#campaign_description').val(json.description)
		
		let assets_names = ['stages','sprites','brickwalls','entities','paths','sounds']
		
		$.each(assets_names,function(i,e){
		 
	  var textAreaID = '#assets_'+e
	 
	  var itemsList;
			
	  switch( e ){
		  case 'stages':
					 itemsList = json.stages
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
		  case 'entities':
					 itemsList = json.entities
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
		  case 'sprites':
					 itemsList = json.sprites
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
		  case 'paths':  
					 itemsList = json.paths
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
		  case 'brickwalls':
					 itemsList = json.brickwalls
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
		  case 'sounds':
					 itemsList = json.sounds
			$(textAreaID).val(JSON.stringify(itemsList))			
		  break;
	  }
		 //if(e != 'sounds'){
			var relatedPanel = $('label[for="'+textAreaID.substr(1)+'"]').attr('relatedPanel')
			
			var sourceList =
			$('#'+relatedPanel+' .'+e+'_list')			
			var targetList = $('#'+relatedPanel+' .assetsList')			
			
			let n = 0,
				elem = 'a'
			
			while( n < itemsList.length ){
				
				elem = 'a'				
				var itemId = itemsList[n]
				
				if(e == 'sounds'){
					elem = 'a.select_bgm'
				}
				
				var anchor = 
				sourceList
				.find(elem)
				.filter(function(){  
					return $(this).attr('href').indexOf(itemId) > -1 					  					 
				})				
				.parents('li')				
				
				
				var clone = anchor.clone()
				targetList.append(clone).sortable('refresh')				
				//console.log('clone \r\n'+clone)
				n++
			}// while
		 //}
			
		})		
		//loaderOff() 	

		// NOTIFY OBJET LOADED
		var msg = 'campaign '+json.name+' loaded'					
		dialogNotify(msg)
		})// DONE
		.then(function(){
			
			// RELOAD ALL SOURCE ASSETS LISTS
			//$('.filter').val(' ').trigger('keyup')
			$('.clearFilter').trigger('mouseup')
			/*
			$('#cmp-ed-tabs-7 ul li a.select_bgm')
			.button( "option", "disabled", true );
			*/
			loaderOff()
		})
	})
	/*
	LOAD STAGE INTO THE STAGES EDITOR end
	*/
/*
	$('#cmp-ed-tabs-7 ul li a.select_bgm')
	.button( "option", "disabled", true );
*/

	/*
		CAMPAIGNS EDITOR -- end
	*/


$(document).delegate('.clearFilter','mouseup',function(i,e){
  //e.preventDefault()
  $(this).parent().find('.filter').val(null)
  $(this).parent().find('.filter').val('. ')
  $(this).parent().find('.filter').trigger('keyup')
  $(this).parent().find('.filter').val(null)
})


function styleSearchForm(){
  $('.filter')
    .button()
    .css({
            'font' : 'inherit',
           'color' : '#fff',
      'text-align' : 'left',
         'outline' : 'none',
          'cursor' : 'text'
    });

  $('.clearFilter')
  .button({
    icon:'ui-icon-close'
  })
}

/*
var Dexie = window.Dexie,
	  async = Dexie.async,
	  spawn = Dexie.spawn,
	  db = new Dexie('ASDB')

db.version(1).stores({
	profile: '++id,creationDate,campaignId,characterId', // 
	  character: '++,profileId,name,strength,resistance,charisma',
	  characterAttributes: '++,profileId,characterId,id,cost,max,description',// id is the name of the attribute
		weapons: '++id,profileId,name,entityName,slot', // boxing-gloves.ent  
	  campaigns: '++id,profileId,name',// name : name.cmp
		 stages: '++id,campaignId,name', // name : name.stg
		 stagesList: '++id,campaignId,name,description', // name : name.stg, description, gold, score, combos
		 campaignAssets: '++id'
		 });		


db.on("ready", function(){ 


console.log('Dexie is ready')

})

db.open()
*/
window.totalPromises = 0
window.solvedPromises = 0
window.promises = []

const assetsDir = '/game_assets/';



//
// When document is ready, bind export/import functions to HTML elements
//
document.addEventListener('DOMContentLoaded', () => {

 window.loadWithPromise = function(url, callback) {
	 
    promises[promises.length] = new Promise(function(resolve, reject) {  
		window.totalPromises++    
		const myHeaders = new Headers({
		  "Content-Type": "application/json",
		  Accept: "application/json"
		}); 
		
		console.log('url: '+url)
		
		//alert('url: '+url)
		
		
		fetch('./'+url,
		{headers: myHeaders}
		)
		.then( (response) => {
		return response.json();
		})
		.then( (data)=>{		
			callback(JSON.stringify(data));
			resolve()
			
			window.solvedPromises++
			var percentage = window.solvedPromises / window.totalPromises * 100

			document.querySelector('#loadingStatus').innerHTML =  'Loading '+percentage.toFixed(0)+ '%'					
			document.querySelector('#loadingStatus').innerHTML +=  ' assets added: '+window.solvedPromises +'/'+ window.totalPromises				
			if ( window.solvedPromises == window.totalPromises){
				//alert('attempt exporting')
				
				window.solvedPromises = 0
				window.totalPromises = 0
				
				createExpFile()			
			}

		
		})// then data
	 
	});// promises[promises.length] = new Promise(function(resolve, reject) 
 }
 /*
	populate ASDB.assets
	'stages',
	'sprites',
	'brickwalls',
	'entities',
	'paths',
	'sounds'
	
	FROM campaign.cmp.json FILE
*/

window.populateAssetsTable = function(){
/*
	populateAssetsTable()
	createExpFile()
*/

 /*
 var campaign = 'shortCmp.cmp.json'
var campaign = 'myFirstCampaign.cmp.json'
 */

let cmpName = ''

if( arguments.length > 0){
	cmpName = arguments[0].name
}else{
	cmpName = document.querySelector('#campaign_name').value
}

window.CMP = cmpName

var campaign = assetsDir + 'campaigns/'+ cmpName + '.json'		



 loadWithPromise(campaign, function(response){			
           
    var jsonObjParsed = JSON.parse(response)            
      
    // TRUNCATE assets
    db.assets.clear()

    var collections = ['stages','sprites','brickwalls','entities','paths','sounds']
	
	document.querySelector('#importLog').innerHtml = 'import logs'
	
	var logStr = ''// log will display all imnports
	var t = 0;
	collections.some(function(selectedCollection){
	   
	var collection = jsonObjParsed[selectedCollection]
	var ext = '.json'
	//alert(selectedCollection)
	if( selectedCollection == 'sounds' ){ext = '.mp3'; /*alert(collection.length)*/}
	
	let assetsLoaded = []
	
	if( collection.length > 0 ){
	 // populate sprites
		collection.some(function(assetName,idx){

			//var assetName  = jsonObjParsed.sprites[0]  
 
		    
			if( assetsLoaded.indexOf(assetName) == -1 ){
				
			
			
			// ASSET NOT IN ARRAY assetsLoaded, insert it 
			assetsLoaded.push(assetName)
			/*
				IF ASSET IS NOT A .json FILE
					i.e.: .mp3...
			*/
			if(ext != '.json'){
				
				/*
						DEXIE: start transactions
					*/   
					spawn(function* (){	

						logStr += '['+selectedCollection+']: '+assetName+' | '+assetName+ext+'\r\n<br/>'
						t += 1						
						
						var id = yield db.assets.add(
							{
								name: assetName,// e.g.: 'bgm_4-loop.mp3'
								object: {name:assetName}, // e.g.:{name:'xxx',...}
								description: assetName+ext,// e.g: 'Save the granny from the monsters!'
								collection: selectedCollection // e.g: 'sounds'
							})
						.then(function(id){						
							//console.log(assetJson+' '+id)
							
							document.querySelector('#importLog').innerHTML = logStr
							console.log(t)
							
						})
						.catch(function(err){
							alert(err)
							
						})// then
					
						
					})// spawn
				/*
					DEXIE: end t
				*/ 
								
			}else{
				
				loadWithPromise(assetsDir + selectedCollection + '/'+assetName+ext, function(jsonAsset){
					var assetJson = JSON.parse(jsonAsset) 
					
					/*
						DEXIE: start transactions
					*/   
					spawn(function* (){	

						logStr += '['+selectedCollection+']: '+assetName+' | '+assetJson.description+'\r\n<br/>'
						t += 1
						//console.log('['+selectedCollection+']: '+assetName+' '+assetJson.description+'\r\n')
						
						var id = yield db.assets.add(
							{
								name: assetName,// e.g.: 'stage5.stg'
								object: assetJson, // e.g.:{name:'xxx',...}
								description: assetJson.description,// e.g: 'Save the granny from the monsters!'
								collection: selectedCollection // e.g: 'stages'
							})
						.then(function(id){						
							//console.log(assetJson+' '+id)
							
							
							document.querySelector('#importLog').innerHTML = logStr
							console.log(t)
							
							
						})// then
						
						
						
					})// spawn
				/*
					DEXIE: end transactions
				*/ 
				}) // loadWithPromise(assetName+ext, function(jsonAsset){
				
			}// if(ext != '.json'){	} else
		
			}// if asset not in array already
		
		})// collection.some(function(assetName,idx){ 


		
	} //if( collection.length > 0 ){

	}) // collections.some(function(selectedCollection)

 })// load
 
}// populateAssetsTable()
 
 let Dexie = window.Dexie,
	  async = Dexie.async,
	  spawn = Dexie.spawn,
	  db = new Dexie('ASDB')
 
window.initDB = function(){
	
  Dexie = window.Dexie,
	  async = Dexie.async,
	  spawn = Dexie.spawn,
	  db = new Dexie('ASDB')
	
	db.version(1).stores({
		profile: '++id,creationDate,campaignId,characterId', // 
		  character: '++,profileId,name,strength,resistance,charisma',
		  characterAttributes: '++,profileId,characterId,id,cost,max,description',// id is the name of the attribute
			weapons: '++id,profileId,name,entityName,slot', // boxing-gloves.ent  
		  campaigns: '++id,profileId,name',// name : name.cmp
			 stages: '++id,campaignId,name', // name : name.stg
			 stagesList: '++id,campaignId,name,description', // name : name.stg, description, gold, score, combos
			 assets: '++id,campaignId,campaignName,name,description,collection,object',
			  campaignAssets: '++id'
			 /*
				asset contains all json objects listed in campaign.cmp.json
				collection: where it will be stored in: sprites|entities|brickwalls|paths|sounds 
				object: the json data of the object.xxx.json
			*/
	});		
	
	// OPEN DB	
	db.open()
	dialogNotify('DB initialized')
}

initDB()

db.on("ready", function(){
	console.log('Dexie ready!')
			
})

$('button').button(/*{
		 icon:'ui-icon-arrowrefresh-1-e',
		 position:'end'
	}*/)
	
$('#emptyDB').button({
	 icon:'ui-icon-arrowrefresh-1-e',
	 position:'end'
})

$('#exportLog').button({
	 icon:'ui-icon-document',
	 position:'end'
})

$('#fullScreenBtn').button({
	 icon:'ui-icon-arrow-4-diag',
	 position:'end'
})

$(document)
.delegate('#emptyDB','mouseup',function(e){
	e.preventDefault()			
	
	Dexie.delete('ASDB')	
	.then(function(){
		
		initDB()
		//dialogNotify('DB emptied')
	})
})

$(document)
.delegate('#exportLog','mouseup',function(e){
	e.preventDefault()			
	$('#expProgressLog').dialog()
})


  window.createExpFile = function(){
	
		console.log('attempt exporting')	
		spawn(function* (){	
		
			var tableObjects = yield db.assets.toArray()	
			
			console.log(tableObjects) 
			
			var fileName = window.CMP//document.querySelector('#campaign_name').value	
			
			var fileNameArray = fileName.split('.')
			fileNameArray.pop()
			    fileNameArray.push('exp')
			fileName = fileNameArray.join('.')
	
			tableObjects.fileName = fileName+".json"
			
			var str_json = JSON.stringify(tableObjects)
			
			  fetch('json_download.php?fileName='+fileName+'.json', {
				
				method: 'POST',
				body: str_json,
				headers: {
					'Accept': 'application/json',			
					'Content-type': 'application/json; charset=UTF-8'
				}
				
			  })
			  .then(function(rawResponse){			  
				  loaderOff()
				  
				  console.log(rawResponse.statusText);
				  var msg = (rawResponse.statusText == 'OK')?
				  'exp file '+tableObjects.fileName+' created successfully!':
				  'error, exp file '+tableObjects.fileName+' could not be created'
				
				  dialogNotify(msg)
				  				  
				  if(rawResponse.statusText == 'OK'){					 
					  createCmpZip()
				  }
			  })	
			
			
		})// spawn
		
  }
    
  window.createCmpZip = function(){	  	
		//var fileName = document.querySelector('#campaign_name').value+'.json'
		var fileName = window.CMP + '.json'
		
		 dialogNotify('Creating '+fileName+'.zip')
		
		fetch('zipCreate.php?campaignFileName='+fileName, 
		{				
			method: 'POST',
			headers: {
				'Accept': 'application/json',			
				'Content-type': 'application/json; charset=UTF-8'
			}
		})
		.then(function(rawResponse){
			var msg = fileName+'.zip created!'
			dialogNotify(msg)
		})	
  }
  
  
	/*
		PATH TIMER -- begin
	*/
  
	window.timerStart = function(){
		window.timerOn = true
		//window.timer = 0
		window.numCentiSeconds = 0;
		timerTick()
	}

	/*window.timerTick = function(){
		window.timer++
		document.querySelector('#path_duration').value = timer
		console.log(window.timer)    
		timerPath = requestAnimationFrame(timerTick) 
	}*/

	window.timerStop = function(){
		window.timerOn = false		
		cancelAnimationFrame(timerPath)       
	}
	
	
	window.lastTime = (new Date()).getTime();
	window.displayNode = document.getElementById('path_duration');
	window.numCentiSeconds = 0;
	
	
	window.timerTick = function() {
		if( window.timerOn === false ){
			return true
		}
		requestAnimationFrame(timerTick);
		var currentTime = (new Date()).getTime();

		if (currentTime - window.lastTime >= 100) {

			console.log("Last Time: " + lastTime);
			console.log("Current Time: " + currentTime);

			window.lastTime = currentTime;
			window.numCentiSeconds++;
			document.querySelector('#path_duration').value = numCentiSeconds/10
		}
		
	};
		
	/*
		PATH TIMER -- end
	*/
  
  
	/*
		GENERATE STAGE LIVE EDIT & TEST IFRAME
	*/
	window.createTestIframe = function(){  
		
		/* CREATE TEST IFRAME */
		loader()
		
		let appURL = 'http://localhost/breakout-phonegap-7/www/';// SHOULD BECOME CONFIGURABLE LATER
		
		// REMOVE EXISTING MODAL
		$('#gameTestFrmContainer').remove()
		
		window.liveEditorVerbose = true
		
		// CREATE MODAL WITH TEST/EDIT IFRAME INSIDE
		//$('<div id="gameTestFrmContainer"><span id="currentTime_"></span><span id="lastTime_"></span><span id="timeUnit_"></span><span id="stageNthFrame_"></span><a href="#" class="testIframeCreate">live edit</a><a href="#" class="testIframeStageLoad">run</a><a href="#" class="testIframeStagePause">pause</a><input type="text" value="0" id="goToTimeUnit" name="goToTimeUnit" /><a href="#" class="liveEditorAddEntityBtn">entity</a><iframe id="gameTestFrm" src="'+appURL+'"/></div>')
		$('<div id="gameTestFrmContainer"><span id="currentTime_"></span><span id="lastTime_"></span><span id="timeUnit_"></span><span id="stageNthFrame_"></span><iframe id="gameTestFrm" src="'+appURL+'"/></div>')
		.dialog({
			dialogClass: 'custom-ui-widget-test-app',
			left: 0,
			width: 460,
			height: window.innerHeight,
			create:function(){
				loaderOff()
				setTimeout(function(){					
					toggleVerbose()
					//$('#gameTestFrmContainer').scrollTop(parseInt($('#gameTestFrmContainer').height()))
				},1000)
				
				//tIfrm.contentWindow.paused == false
			},
			close:function(){
				$(this)
				.dialog("destroy")
				.remove();// REMOVE EXISTING MODAL
			}
		})
	}
    
	$('#gameTestFrmContainer').scrollTop(0)
		
	//$('#gameTestFrmContainer').scrollTop(parseInt($('#gameTestFrmContainer').height()))
	
	
	
	/*
		function testIframePlayStageFromStagesEditor()

		DOES:
				- load that is loaded in backend stages editor into test iframe
				- and play the stage

		PARAMS:
				tIfrm - JS global that references the test IFRAME
				
		createTestIframe() MUST BE CALLED BEFOREEND IN ORDER TO GENERATE THE TEST IFRAME
	*/
	window.testIframePlayStageFromStagesEditor = function(){

		/* REFERENCE THE IFRAME */
			window.tIfrm = document.getElementById('gameTestFrm')
			tIfrm.contentDocument.paused = false
		var Defer = $.Deferred()
		
		/*
			REMOVE MARGINS BETWEEN stage_preview & stages_editor dialog
			TO HAVE THE ACCURATE coordinates of entity cannons on APP's stage
		*/
		Defer = ECCompensateAdjustCoords('subtract')
		//Defer = function(){Defer.resolve()}
		$.when(Defer).done(function(){

			//1 - 	
			// POPULATE TEXTAREA
			$('#stage_entityCannons').val(JSON.stringify(entityCannons))
			
			var json = $('form#stg_ed_frm').serializeObject()  					
				console.log('submit: \r\n'+JSON.stringify(json))
				
			//2- RESET ALL STAGE VARS & ARRAYS
				tIfrm.contentWindow.stages = []
				tIfrm.contentWindow.stage = []
				tIfrm.contentWindow.resetStageVars()
				
				// STOP ALL PLAYING SOUNDS
				Array.prototype.some.call(tIfrm.contentWindow.sounds,function(sound, idx){
					tIfrm.contentWindow.stopSound(sound.name)
				})					
				
			//3- 

		  let BW_states = [],
			   stage_entityCannons = [],
			   scrollingScreens = [],
			   objectives = [],
			   spawnBalls = []	

		  /*
			   BW_states = (tIfrm.contentWindow.BW_states.length > 0)?JSON.parse(json.BW_states):BW_states
			   stage_entityCannons = (tIfrm.contentWindow.stage_entityCannons.length > 0)?JSON.parse(json.stage_entityCannons):stage_entityCannons			    
			   objectives = (tIfrm.contentWindow.objectives.length > 0)?JSON.parse(json.objectives):objectives
			   spawnBalls = (tIfrm.contentWindow.spawnBalls.length > 0)?JSON.parse(json.spawnBalls):spawnBalls
			   scrollingScreens = (tIfrm.contentWindow.scrollingScreens.length > 0)?JSON.parse(json.scrollingScreens):scrollingScreens
		  */
			   BW_states = (typeof tIfrm.contentWindow.BW_states != 'undefined')?JSON.parse(json.BW_states):BW_states
			   stage_entityCannons = (typeof tIfrm.contentWindow.stage_entityCannons != 'undefined')?JSON.parse(json.stage_entityCannons):stage_entityCannons			    
			   objectives = (typeof tIfrm.contentWindow.objectives != 'undefined')?JSON.parse(json.objectives):objectives
			   spawnBalls = (typeof tIfrm.contentWindow.spawnBalls != 'undefined')?JSON.parse(json.spawnBalls):spawnBalls
			   scrollingScreens = (typeof tIfrm.contentWindow.scrollingScreens != 'undefined')?JSON.parse(json.scrollingScreens):scrollingScreens
		  
			   BW_states = JSON.parse(json.BW_states)
			   stage_entityCannons = JSON.parse(json.stage_entityCannons)
			   scrollingScreens = JSON.parse(json.scrollingScreens)
			   objectives = JSON.parse(json.objectives)
			   spawnBalls = JSON.parse(json.spawnBalls)
			   
			   json.BW_pathEnd = $('#stage_BW_pathEnd').val()
			   
			   
			   		    
				json.BW_states = BW_states
				json.stage_entityCannons = stage_entityCannons
				json.scrollingScreens = scrollingScreens
				json.objectives = objectives
				json.spawnBalls = spawnBalls
						
				tIfrm.contentWindow.stages.push(json)
				
				
				/*
					READD MARGINS BETWEEN stage_preview & stages_editor dialog
					TO GET THE INITIAL coordinates of entity cannons on stages_editor stage_preview
				*/
				ECCompensateAdjustCoords('add')
				
				
		  	
			//ifrm.stagesList.push( ifrm.contentWindow.stages[0] )	
			
			tIfrm.contentWindow.loadStageFromStages(json.name)
			.then(function(){
								
				tIfrm.contentWindow.loadScrollings()
				
			})
			.then(function(){
				
				setTimeout(
				tIfrm.contentWindow.start_game(json.name)				
				,2000)
				//tIfrm.contentWindow.launch_stage(json.name)
				//tIfrm.contentWindow.pause()
			})
			
			
			//tIfrm.contentWindow.UI_display_selected_stage(json.name)
			
			//4-
				/* */
				console.log('***********************')
				console.log('tIfrm.contentWindow.stages')
				console.log(tIfrm.contentWindow.stages)
			
		})// then
	}

	/*
	$(document)
	.delegate('#goToTimeUnit','change',function(e){
		tIfrm.contentWindow.querySelector('#timeUnit_').text($('#goToTimeUnit').val())	
		alert(tIfrm.contentWindow.querySelector('#timeUnit_').text())
	})
	*/
	/*$(document).spinner({
		change:function(e){
			e.preventDefault()
			alert($('#goToTimeUnit').val())
			tIfrm.contentWindow.querySelector('#timeUnit_').innerHTML = $('#goToTimeUnit').val()	
			alert(tIfrm.contentWindow.querySelector('#timeUnit_').text())
		}
	});*/
	
	
	$(document)
	.delegate('.testIframeCreate','click',function(e){
		e.preventDefault();
		$('.testIframeStagePause')
		.button('option','icon','ui-icon-pause')
		//tIfrm.contentWindow.paused == false
		/* GENERATE THE TEST IFRAME */
		createTestIframe()
	})
	
	$(document)
	.delegate('.testIframeStageLoad','click',function(e){
		e.preventDefault();
		$('.testIframeStagePause')
		.button('option','icon','ui-icon-pause')
		//tIfrm.contentWindow.paused == false
		/* LOAD AND START THE STAGE CURRENTLY EDITED IN stages_editor */
		testIframePlayStageFromStagesEditor()
	})
	
	$(document)
	.delegate('.liveEditorAddEntityBtn','click',function(e) {
		e.preventDefault();
		/*ADD AN ENTITY IN THE LIVE EDITOR */
		tIfrm.contentWindow.mouseEventsReset()
		liveAddEntity()
	})
	
	$(document)
	.delegate('.testIframeStagePause','click',function(e) {
		e.preventDefault();
		/* PAUSE TOGGLE IN THE LIVE EDITOR */
		togglePause()		
	})
	
	$(document)
	.delegate('.testIframeToggleVerbose','click',function(e) {
		e.preventDefault();
		/* VERBOSE TOGGLE IN THE LIVE EDITOR */
		toggleVerbose()		
	})
	
	window.togglePause = function(){
		if( tIfrm.contentWindow.paused == true ){
			$('.testIframeStagePause')
			.button('option','icon','ui-icon-pause')			
			if( tIfrm.contentDocument.getElementById("liveEditor") != null ){				
				tIfrm.contentDocument.getElementById("liveEditor").remove()
				tIfrm.contentDocument.getElementById("livePointer").remove()
			}			
			tIfrm.contentWindow.mouseEventsInit()
			tIfrm.contentWindow.resume()			
		}
		else if( tIfrm.contentWindow.paused == false ){
			$('.testIframeStagePause')
			.button('option','icon','ui-icon-play')
			tIfrm.contentWindow.pause()
			tIfrm.contentWindow.mouseEventsReset()		
		}
	}
	

	window.toggleVerbose = function(){
		if( window.liveEditorVerbose == false ){
			$('.testIframeToggleVerbose')
			.button('option','icon','ui-icon-squaresmall-minus')			
			$('#gameTestFrmContainer').scrollTop(0)
			window.liveEditorVerbose = true		
		}
		else if( window.liveEditorVerbose == true ){
			$('.testIframeToggleVerbose')
			.button('option','icon','ui-icon-squaresmall-plus')
			$('#gameTestFrmContainer').scrollTop(parseInt($('#gameTestFrmContainer').height()))	
			window.liveEditorVerbose = false
		}
		console.log('window.liveEditorVerbose: '+window.liveEditorVerbose)
	}	
	
	/*
		- CREATE LIVE EDITOR
		- INIT liveEditor mousemove: 
			move livePointer
			
		- INIT liveEditor mouseclick: 
			create entity
				with: 
					timeUnit
					x
					y
	
	*/
	window.liveAddEntity = function(){
			$('.testIframeStagePause')
			.button('option','icon','ui-icon-play')
			tIfrm.contentWindow.pause()
			tIfrm.contentWindow.mouseEventsReset()	
		
			let frmBody = tIfrm.contentWindow.document.body    
			/* PREPARE & APPEND liveEditor to iframe DOM */
			let liveEditor = document.createElement('div')
				liveEditor.setAttribute('id','liveEditor')
				frmBody.append(liveEditor)

			let livePointer = document.createElement('div')
				livePointer.setAttribute('id','livePointer')
				frmBody.append(livePointer)

			tIfrm.contentWindow.mouseEventsReset()// Disable mouse move the paddle

			// INIT liveEditor mousemove
			tIfrm.contentWindow.document.getElementById("liveEditor")
			.addEventListener('mousemove', evt => {        
				let 
				x = evt.clientX,
				y = evt.clientY
			
			tIfrm.contentWindow.document.getElementById("liveEditor")
			.innerHTML = 			
			'x: '+x+ '/' +'y: '+y
			/*+' **** '
			'x: '+x-evt.offsetX+ '/' +'y: '+y-evt.offsetY
			+' **** '
			'x: '+x-evt.pageX+ '/' +'y: '+y-evt.pageY
			+' **** '*/
			
			
				console.log(event)        

			livePointer.style.top = y+'px'
			livePointer.style.left = x+'px'    
		})

		// INIT liveEditor mouseclick
		/*
			on click: 
				initiate the insertion of an entity        
		*/
		tIfrm.contentWindow.document.getElementById("liveEditor")
		.addEventListener('mouseup', evt => {
			
			loader()
			
			let 
			x = evt.clientX,
			y = evt.clientY
			
			//document.getElementById("stageEntityBtn").click()
						
			var paramsObject = {
				selectorId: 'stages_entities_list_container_live',
				target: $('#stage_ec_manager_controls'),
				injectMethod: 'appendTo',
				contentPath: './entities_editor/ #entities_list_container .entities_list',
				title: 'place an entity on the stage - live',
				searchFormId : 'stageFilterEntities'	
			}
			
			// 1 - alert('yo')
			
			window.liveEditorX = x
			window.liveEditorY = y
			
			//window.tIfrm = document.getElementById('gameTestFrm')
			//tIfrm.contentWindow.timeUnit
			
			generateAssetSelector( paramsObject, load_entities('live') )
						
		})
	}
 


	function toggleFullScreen() {
	  if (!document.fullscreenElement) {
		  document.documentElement.requestFullscreen();
	  } else {
		if (document.exitFullscreen) {
		  document.exitFullscreen();
		}
	  }
	}
	/*
	document.addEventListener("keypress", function(e) {
	  if (e.keyCode === 13) {
		toggleFullScreen();
	  }
	}, false);
	*/
	
	$(document)
	.delegate('#fullScreenBtn','mouseup',toggleFullScreen)
	
 
})//document.addEventListener('DOMContentLoaded'


	</script>
	
	
	
	
	
	</head>
	<body id='body' class='portrait'>
	
	<div id='expProgressLog'>
		<span id='loadingStatus'></span><br/>
		<div id='importLog'></div><br/>		
	</div>
	
	<canvas id='snapshot_canvas'></canvas>
	<div id='loader'>
		<div class='loading'>LOADING</div>	
		<div class="parent">
		  <div class="gear">
			<div class="center"></div>
			<div class="tooth"></div>
			<div class="tooth"></div>
			<div class="tooth"></div>
			<div class="tooth"></div>
		  </div>  
		</div>
	 </div> 
		<button id='sprites_editor_btn'>sprite editor</button>		
		<button id='paths_editor_btn'>paths editor</button>
		<button id='brickwalls_editor_btn'>brickwalls editor</button>
		<button id='entities_editor_btn'>entities editor</button>
		<button id='stages_editor_btn'>stages editor</button>
		<button id='campaigns_editor_btn'>campaigns editor</button>
		
		<a href='#' id='emptyDB'>empty DB</a>
		<a href='#' id='exportLog'>export Log</a>
		
		<a href='#' id='fullScreenBtn'>full screen</a>
		
		
		
		<div id='minimized_windows'></div>
		<link href='paths_editor/paths_editor.css'  type="text/css" rel="stylesheet" /> 
		<link href='sprites_editor/sprites_editor.css'  type="text/css" rel="stylesheet" /> 
		<div id='searchFormModel'></div>
	</body>
</html> 